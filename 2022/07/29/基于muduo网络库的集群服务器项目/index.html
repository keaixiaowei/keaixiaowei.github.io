<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>基于muduo网络库的集群服务器项目 | 憨憨小胖</title><meta name="keywords" content="C++项目"><meta name="author" content="蔡伟"><meta name="copyright" content="蔡伟"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1 配置远程开发环境1.1 安装Json开发库打开WinSCP，将json.hpp传送至服务器创建的目录，我的目录是&#x2F;home&#x2F;iot&#x2F;caiwei&#x2F;test  1.2 安装boost + muduo网络库开发环境使用百度云盘下载muduo库源码，下载地址为 https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1Rqrnz8NY6UOiFemYQv-63Q 提取">
<meta property="og:type" content="article">
<meta property="og:title" content="基于muduo网络库的集群服务器项目">
<meta property="og:url" content="http://example.com/2022/07/29/%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="憨憨小胖">
<meta property="og:description" content="1 配置远程开发环境1.1 安装Json开发库打开WinSCP，将json.hpp传送至服务器创建的目录，我的目录是&#x2F;home&#x2F;iot&#x2F;caiwei&#x2F;test  1.2 安装boost + muduo网络库开发环境使用百度云盘下载muduo库源码，下载地址为 https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1Rqrnz8NY6UOiFemYQv-63Q 提取">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/3.jpg">
<meta property="article:published_time" content="2022-07-29T07:46:09.000Z">
<meta property="article:modified_time" content="2022-08-11T14:08:19.651Z">
<meta property="article:author" content="蔡伟">
<meta property="article:tag" content="C++项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/3.jpg"><link rel="shortcut icon" href="/img/%E4%B8%BB%E9%A1%B5%E8%83%8C%E6%99%AF%E5%9B%BE.jpg"><link rel="canonical" href="http://example.com/2022/07/29/%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '基于muduo网络库的集群服务器项目',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-08-11 22:08:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/loading.gif" data-original="/img/%E5%A4%B4%E5%83%8F.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/3.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">憨憨小胖</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">基于muduo网络库的集群服务器项目</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-29T07:46:09.000Z" title="发表于 2022-07-29 15:46:09">2022-07-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-11T14:08:19.651Z" title="更新于 2022-08-11 22:08:19">2022-08-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C-%E9%A1%B9%E7%9B%AE/">C++项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="基于muduo网络库的集群服务器项目"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="1-配置远程开发环境"><a href="#1-配置远程开发环境" class="headerlink" title="1 配置远程开发环境"></a>1 配置远程开发环境</h2><h3 id="1-1-安装Json开发库"><a href="#1-1-安装Json开发库" class="headerlink" title="1.1 安装Json开发库"></a>1.1 安装Json开发库</h3><p>打开WinSCP，将json.hpp传送至服务器创建的目录，我的目录是&#x2F;home&#x2F;iot&#x2F;caiwei&#x2F;test</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-01(1).png" alt="本地png图片PictureTest.png"></p>
<h3 id="1-2-安装boost-muduo网络库开发环境"><a href="#1-2-安装boost-muduo网络库开发环境" class="headerlink" title="1.2 安装boost + muduo网络库开发环境"></a>1.2 安装boost + muduo网络库开发环境</h3><p>使用百度云盘下载muduo库源码，下载地址为</p>
<p><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Rqrnz8NY6UOiFemYQv-63Q">https://pan.baidu.com/s/1Rqrnz8NY6UOiFemYQv-63Q</a> 提取码：8nio</p>
<p>打开WinSCP，将<strong>muduo-master.zip</strong>传送至服务器创建的目录，我的目录是&#x2F;home&#x2F;iot&#x2F;caiwei&#x2F;test</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><strong>muduo库是基于boost开发的，所以需要先在Linux平台上安装boost库</strong></p>
<p>去boost官网下载boost库源码，下载地址为</p>
<p><a target="_blank" rel="noopener" href="https://www.boost.org/users/history/version_1_79_0.html">Version 1.79.0 (boost.org)</a></p>
<p>打开WinSCP，将<strong>boost_1_79_0.tar.gz</strong>传送至服务器创建的目录，我的目录是&#x2F;home&#x2F;iot&#x2F;caiwei&#x2F;test</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(1).png" alt="本地png图片PictureTest.png"></p>
<p>将<strong>boost_1_79_0.tar.gz</strong>进行解压</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -zxvf boost_1_79_0.tar.gz</span><br></pre></td></tr></table></figure>

<p>tar解压完成后，进入源码文件目录，查看内容：</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(2).png" alt="本地png图片PictureTest.png"></p>
<p>运行bootstrap.sh工程编译构建程序，需要等待一会儿，查看目录：</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(3).png" alt="本地png图片PictureTest.png"></p>
<p>源码根目录下生成了b2程序，运行b2程序如下（boost源码比较大，这里编译需要花费一些时间）：</p>
<p>【注意】：如果Linux系统没有安装g++编译器，需要先安装g++，建议g++4.6版本以上，能比较好的支持C++新标准，可以通过命令 g++ –version 查看g++版本号。</p>
<p>编译完成后，会有如下打印:</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(4).png" alt="本地png图片PictureTest.png"></p>
<p>最后，再把上面的boost库头文件和lib库文件安装在默认的Linux系统头文件和库文件的搜索路径下，运行下面命令（<strong>因为要给&#x2F;usr目录下拷贝文件，需要先进入</strong></p>
<p><strong>root用户</strong>）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./b2 install</span><br></pre></td></tr></table></figure>

<p>安装完成后，最后会有如下信息打印出来：</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(5).png" alt="本地png图片PictureTest.png"></p>
<p>验证安装boost是否成功，通过下面的代码验证一下：</p>
<p>vim test.c</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;boost/bind.hpp&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">class Hello</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">	void say(string name) </span><br><span class="line">	&#123; cout &lt;&lt; name &lt;&lt; &quot; say: hello world!&quot; &lt;&lt; endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	Hello h;</span><br><span class="line">	auto func = boost::bind(&amp;Hello::say, &amp;h, &quot;zhang san&quot;);</span><br><span class="line">	func();</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过g++编译上面的代码，运行打印如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">g++ -o test test.c -std=c++11</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(6).png" alt="本地png图片PictureTest.png"></p>
<p>解压压缩包muduo-master.zip</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">unzip muduo-master.zip</span><br></pre></td></tr></table></figure>

<p>解压完成后，进入muduo库的解压目录里面</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(7).png" alt="本地png图片PictureTest.png"></p>
<p><strong>注意</strong>，muduo库源码编译会编译很多unit_test测试用例代码，编译耗时长，我们也用不到，vim编辑上面源码目录里面的CMakeLists.txt文件，如下修改：</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(8).png" alt="本地png图片PictureTest.png"></p>
<p><strong>保存并退出</strong>，继续下面的步骤。</p>
<p><strong>看到有一个build.sh源码编译构建程序，运行该程序（注意：muduo是用cmake来构建的，需要先安装cmake，ubuntu下直接sudo apt-get install cmake就</strong></p>
<p><strong>可以，redhat或者centos可以从yum仓库直接安装</strong>）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apt-get install cmake</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(9).png" alt="本地png图片PictureTest.png"></p>
<p>然后执行build.sh程序</p>
<h4 id="1-2-1-错误"><a href="#1-2-1-错误" class="headerlink" title="1.2.1 错误"></a>1.2.1 错误</h4><p>出现的错误：今天在cmake的时候，报错&#x2F;usr&#x2F;bin&#x2F;cmake: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libcurl.so.4: no version information available (required by &#x2F;usr&#x2F;bin&#x2F;cmake)</p>
<p>解决方法:</p>
<p>第一步：输入命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">locate libcurl.so.4</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(10).png" alt="本地png图片PictureTest.png"></p>
<p>第二步：输入：ll &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libcurl.so.4 查看 libcurl.so.4的指向为 libcurl.so.4.4.0，删除错误指向，重新创建新的链接指向为：&#x2F;usr&#x2F;lib&#x2F;x86_64-linux-</p>
<p>gnu&#x2F;libcurl.so.4.5.0</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(11).png" alt="本地png图片PictureTest.png"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo rm -rf /usr/local/lib/libcurl.so.4</span><br><span class="line">sudo ln -s /usr/lib/x86_64-linux-gnu/libcurl.so.4.5.0 /usr/local/lib/libcurl.so.4</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(12).png" alt="本地png图片PictureTest.png"></p>
<p>解决问题完成后，在make一下</p>
<p><strong>编译完成后，在输入.&#x2F;build.sh install命令进行muduo库安装</strong></p>
<p>这个.&#x2F;build.sh install实际上把muduo的头文件和lib库文件放到了muduo-master同级目录下的build目录下的release-install-cpp11文件夹下面了：</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(13).png" alt="本地png图片PictureTest.png"></p>
<p>所以上面的install命令并没有把它们拷贝到系统路径下，导致我们每次编译程序都需要指定muduo库的头文件和库文件路径，很麻烦，所以我们选择直接把</p>
<p>inlcude（头文件）和lib（库文件）目录下的文件拷贝到系统目录下：</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(14).png" alt="本地png图片PictureTest.png"></p>
<p>拷贝完成以后使用muduo库编写C++网络程序，不用在指定头文件和lib库文件路径信息了，因为g++会自动从&#x2F;usr&#x2F;include和&#x2F;usr&#x2F;local&#x2F;lib路径下寻找所需要的文</p>
<p>件。写测试代码，测试muduo是否能够正常使用，如下：把muduo库的头文件和lib库文件拷贝完成以后，使用muduo库编写一个简单的echo回显服务器，测试</p>
<p>muduo库是否可以正常使用，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#include &lt;muduo/net/TcpServer.h&gt;</span><br><span class="line">#include &lt;muduo/base/Logging.h&gt;</span><br><span class="line">#include &lt;boost/bind.hpp&gt;</span><br><span class="line">#include &lt;muduo/net/EventLoop.h&gt;</span><br><span class="line"></span><br><span class="line">// 使用muduo开发回显服务器</span><br><span class="line">class EchoServer</span><br><span class="line">&#123;</span><br><span class="line"> public:</span><br><span class="line">  EchoServer(muduo::net::EventLoop* loop,</span><br><span class="line">             const muduo::net::InetAddress&amp; listenAddr);</span><br><span class="line"></span><br><span class="line">  void start(); </span><br><span class="line"></span><br><span class="line"> private:</span><br><span class="line">  void onConnection(const muduo::net::TcpConnectionPtr&amp; conn);</span><br><span class="line"></span><br><span class="line">  void onMessage(const muduo::net::TcpConnectionPtr&amp; conn,</span><br><span class="line">                 muduo::net::Buffer* buf,</span><br><span class="line">                 muduo::Timestamp time);</span><br><span class="line"></span><br><span class="line">  muduo::net::TcpServer server_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">EchoServer::EchoServer(muduo::net::EventLoop* loop,</span><br><span class="line">                       const muduo::net::InetAddress&amp; listenAddr)</span><br><span class="line">  : server_(loop, listenAddr, &quot;EchoServer&quot;)</span><br><span class="line">&#123;</span><br><span class="line">  server_.setConnectionCallback(</span><br><span class="line">      boost::bind(&amp;EchoServer::onConnection, this, _1));</span><br><span class="line">  server_.setMessageCallback(</span><br><span class="line">      boost::bind(&amp;EchoServer::onMessage, this, _1, _2, _3));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void EchoServer::start()</span><br><span class="line">&#123;</span><br><span class="line">  server_.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void EchoServer::onConnection(const muduo::net::TcpConnectionPtr&amp; conn)</span><br><span class="line">&#123;</span><br><span class="line">  LOG_INFO &lt;&lt; &quot;EchoServer - &quot; &lt;&lt; conn-&gt;peerAddress().toIpPort() &lt;&lt; &quot; -&gt; &quot;</span><br><span class="line">           &lt;&lt; conn-&gt;localAddress().toIpPort() &lt;&lt; &quot; is &quot;</span><br><span class="line">           &lt;&lt; (conn-&gt;connected() ? &quot;UP&quot; : &quot;DOWN&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void EchoServer::onMessage(const muduo::net::TcpConnectionPtr&amp; conn,</span><br><span class="line">                           muduo::net::Buffer* buf,</span><br><span class="line">                           muduo::Timestamp time)</span><br><span class="line">&#123;</span><br><span class="line">  // 接收到所有的消息，然后回显</span><br><span class="line">  muduo::string msg(buf-&gt;retrieveAllAsString());</span><br><span class="line">  LOG_INFO &lt;&lt; conn-&gt;name() &lt;&lt; &quot; echo &quot; &lt;&lt; msg.size() &lt;&lt; &quot; bytes, &quot;</span><br><span class="line">           &lt;&lt; &quot;data received at &quot; &lt;&lt; time.toString();</span><br><span class="line">  conn-&gt;send(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">  LOG_INFO &lt;&lt; &quot;pid = &quot; &lt;&lt; getpid();</span><br><span class="line">  muduo::net::EventLoop loop;</span><br><span class="line">  muduo::net::InetAddress listenAddr(8888);</span><br><span class="line">  EchoServer server(&amp;loop, listenAddr);</span><br><span class="line">  server.start();</span><br><span class="line">  loop.loop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用g++进行编译，注意链接muduo和pthread的库文件，编译命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">g++ main.cpp -lmuduo_net -lmuduo_base -lpthread -std=c++11</span><br></pre></td></tr></table></figure>

<p>编译链接完成，生成a.out可执行程序，上面的echo服务器监听8888端口，运行上面的a.out回显服务器如下：</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(15).png" alt="本地png图片PictureTest.png"></p>
<p>等待客户端连接，可以打开一个新的shell命令行用netcat命令模拟客户端连接echo服务器进行功能测试，命令如下：</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(16).png" alt="本地png图片PictureTest.png"></p>
<p>客户端数据回显正确，看看服务器接日志信息打印如下：</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-02(17).png" alt="本地png图片PictureTest.png"></p>
<h3 id="1-3-安装nginx"><a href="#1-3-安装nginx" class="headerlink" title="1.3 安装nginx"></a>1.3 安装nginx</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apt-get install nginx</span><br></pre></td></tr></table></figure>

<p>查看nginx是否安装成功</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nginx -v</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-03(1).png" alt="本地png图片PictureTest.png"></p>
<p>启动nginx</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">service nginx start</span><br></pre></td></tr></table></figure>

<p>启动后，在网页重输入ip地址，即可看到nginx的欢迎页面。至此nginx安装成功</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-03(2).png" alt="本地png图片PictureTest.png"></p>
<p>nginx文件安装完成之后的文件位置：</p>
<ul>
<li>&#x2F;usr&#x2F;sbin&#x2F;nginx：主程序</li>
<li>&#x2F;etc&#x2F;nginx：存放配置文件</li>
<li>&#x2F;usr&#x2F;share&#x2F;nginx：存放静态文件</li>
<li>&#x2F;var&#x2F;log&#x2F;nginx：存放日志</li>
</ul>
<p>在Ubuntu上卸载nginx</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 删除除了配置文件以外的所有文件。</span><br><span class="line">sudo apt-get remove nginx nginx-common</span><br><span class="line"># 删除所有与nginx有关的东西，包括配置文件。 </span><br><span class="line">sudo apt-get purge nginx nginx-common </span><br><span class="line"># 在上面命令结束后执行，主要是删除与Nginx有关的且不再被使用的依赖包。</span><br><span class="line">sudo apt-get autoremove </span><br><span class="line"># 删除两个主要的包。</span><br><span class="line">sudo apt-get remove nginx-full nginx-common </span><br></pre></td></tr></table></figure>

<p>验证是否成功卸载nginx</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#重启nginx,重启失败，说明已成功卸载nginx</span><br><span class="line">sudo service nginx restart</span><br></pre></td></tr></table></figure>

<h3 id="1-4-windows-vscode配置远程linux开发环境"><a href="#1-4-windows-vscode配置远程linux开发环境" class="headerlink" title="1.4 windows+vscode配置远程linux开发环境"></a>1.4 windows+vscode配置远程linux开发环境</h3><p> 要配置远程开发环境，首先要保证linux系统上安装了<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=openssh&spm=1001.2101.3001.7020">openssh</a>服务，可以通过netstat -tanp查看网络服务，有没有sshd这样一个进程名，如果PID&#x2F;Program </p>
<p>name不显示的话，是因为不是root用户</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-04(1).png" alt="本地png图片PictureTest.png"></p>
<p>从上图可以看出sshd进程监听在22号端口</p>
<p>在vscode上安装Remote Development插件，其它依赖插件会自动安装</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-04(2).png" alt="本地png图片PictureTest.png"></p>
<p> 安装完成之后建议重启一下vscode，让更改生效</p>
<p>快捷键：CTRL + SHITF + P，打开：“命令面板”，输入Reload Window即可</p>
<p>接下来配置远程Linux主机信息</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-04(3).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-04(4).png" alt="本地png图片PictureTest.png"></p>
<p>选择默认的配置文件</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-04(5).png" alt="本地png图片PictureTest.png"></p>
<p>此时可以打开windows的cmd ping一下远程linux主机的ip地址，看是否连通</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/1-04(6).png" alt="本地png图片PictureTest.png"></p>
<p>最后user就是登陆的用户ly， 填完之后cttl+s保存，左侧会出现如下图标，</p>
<h2 id="2-Json"><a href="#2-Json" class="headerlink" title="2 Json"></a>2 Json</h2><h3 id="2-1-Json介绍"><a href="#2-1-Json介绍" class="headerlink" title="2.1 Json介绍"></a>2.1 Json介绍</h3><p>Json是一种轻量级的数据交换格式（也叫数据序列化方式）。Json采用完全独立于编程语言的文本格式来存储和表示数据。简洁和清晰的层次结构使得 Json 成为</p>
<p>理想的数据交换语言。 易于人阅读和编写，同时也易于机器解析和生成，并有效地提升网络传输效率。  </p>
<p>JSON for Modern C++ 是一个由德国大牛 nlohmann 编写的在 C++ 下使用的 JSON 库。具有以下特点</p>
<ul>
<li><p>直观的语法</p>
</li>
<li><p>整个代码由一个头文件组成 json.hpp，没有子项目，没有依赖关系，没有复杂的构建系统，使用起来非常方便</p>
</li>
<li><p>使用 C++ 11 标准编写</p>
</li>
<li><p>使用 json 像使用 STL 容器一样</p>
</li>
<li><p>STL 和 json 容器之间可以相互转换</p>
</li>
<li><p>严谨的测试：所有类都经过严格的单元测试，覆盖了 100％ 的代码，包括所有特殊的行为。此外，还检查了 Valgrind 是否有内存泄漏。为了保持高质量，该</p>
</li>
</ul>
<p>项目遵循核心基础设施倡议(CII)的最佳实践  </p>
<h3 id="2-2-Json数据序列化"><a href="#2-2-Json数据序列化" class="headerlink" title="2.2 Json数据序列化"></a>2.2 Json数据序列化</h3><p>json数据序列化示例代码一如下：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    json js;</span><br><span class="line"></span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;;</span><br><span class="line"></span><br><span class="line">    js[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;zhangsan&quot;</span>;</span><br><span class="line"></span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>][<span class="string">&quot;zhangsan&quot;</span>] = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>][<span class="string">&quot;liu shuo&quot;</span>] = <span class="string">&quot;hello china&quot;</span>;</span><br><span class="line"></span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>] = &#123;&#123;<span class="string">&quot;zhangsan&quot;</span>,<span class="string">&quot;hello wordl&quot;</span>&#125;,&#123;<span class="string">&quot;liu shuo&quot;</span>,<span class="string">&quot;hello china&quot;</span>&#125;&#125;;</span><br><span class="line">    cout &lt;&lt; js &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">func1</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/2-02(1).png" alt="本地png图片PictureTest.png"></p>
<p>json数据序列化示例代码二如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#include &quot;json.hpp&quot;</span><br><span class="line">using json = nlohmann::json;</span><br><span class="line"></span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line">#include &lt;map&gt;</span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">void func1()</span><br><span class="line">&#123;</span><br><span class="line">    json js;</span><br><span class="line"></span><br><span class="line">    js[&quot;id&quot;] = &#123;1,2,3,4,5&#125;;</span><br><span class="line"></span><br><span class="line">    js[&quot;name&quot;] = &quot;zhangsan&quot;;</span><br><span class="line"></span><br><span class="line">    js[&quot;msg&quot;][&quot;zhangsan&quot;] = &quot;hello world&quot;;</span><br><span class="line">    js[&quot;msg&quot;][&quot;liu shuo&quot;] = &quot;hello china&quot;;</span><br><span class="line"></span><br><span class="line">    js[&quot;msg&quot;] = &#123;&#123;&quot;zhangsan&quot;,&quot;hello wordl&quot;&#125;,&#123;&quot;liu shuo&quot;,&quot;hello china&quot;&#125;&#125;;</span><br><span class="line">    cout &lt;&lt; js &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void func2()</span><br><span class="line">&#123;</span><br><span class="line">    json js;</span><br><span class="line">    // 直接序列化一个vector容器</span><br><span class="line">    vector&lt;int&gt; vec;</span><br><span class="line">    vec.push_back(1);</span><br><span class="line">    vec.push_back(2);</span><br><span class="line">    vec.push_back(5);</span><br><span class="line">    js[&quot;list&quot;] = vec;</span><br><span class="line">    // 直接序列化一个map容器</span><br><span class="line">    map&lt;int, string&gt; m;</span><br><span class="line">    m.insert(&#123;1, &quot;黄山&quot;&#125;);</span><br><span class="line">    m.insert(&#123;2, &quot;华山&quot;&#125;);</span><br><span class="line">    m.insert(&#123;3, &quot;泰山&quot;&#125;);</span><br><span class="line">    js[&quot;path&quot;] = m;</span><br><span class="line">    cout&lt;&lt;js&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">    string sendbuf = js.dump();</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; sendbuf &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    func1();</span><br><span class="line">    func2();</span><br><span class="line">    </span><br><span class="line">    return EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/2-02(2).png" alt="本地png图片PictureTest.png"></p>
<h3 id="2-3-Json数据反序列化"><a href="#2-3-Json数据反序列化" class="headerlink" title="2.3 Json数据反序列化"></a>2.3 Json数据反序列化</h3><p>json数据反序列化示例代码如下:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">func1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    json js;</span><br><span class="line"></span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;;</span><br><span class="line"></span><br><span class="line">    js[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;zhangsan&quot;</span>;</span><br><span class="line"></span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>][<span class="string">&quot;zhangsan&quot;</span>] = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>][<span class="string">&quot;liu shuo&quot;</span>] = <span class="string">&quot;hello china&quot;</span>;</span><br><span class="line"></span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>] = &#123;&#123;<span class="string">&quot;zhangsan&quot;</span>,<span class="string">&quot;hello wordl&quot;</span>&#125;,&#123;<span class="string">&quot;liu shuo&quot;</span>,<span class="string">&quot;hello china&quot;</span>&#125;&#125;;</span><br><span class="line">    </span><br><span class="line">    string sendbuf = js.<span class="built_in">dump</span>();</span><br><span class="line">    <span class="keyword">return</span> sendbuf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">func2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    json js;</span><br><span class="line">    <span class="comment">// 直接序列化一个vector容器</span></span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; vec;</span><br><span class="line">    vec.<span class="built_in">push_back</span>(<span class="number">1</span>);</span><br><span class="line">    vec.<span class="built_in">push_back</span>(<span class="number">2</span>);</span><br><span class="line">    vec.<span class="built_in">push_back</span>(<span class="number">5</span>);</span><br><span class="line">    js[<span class="string">&quot;list&quot;</span>] = vec;</span><br><span class="line">    <span class="comment">// 直接序列化一个map容器</span></span><br><span class="line">    map&lt;<span class="type">int</span>, string&gt; m;</span><br><span class="line">    m.<span class="built_in">insert</span>(&#123;<span class="number">1</span>, <span class="string">&quot;黄山&quot;</span>&#125;);</span><br><span class="line">    m.<span class="built_in">insert</span>(&#123;<span class="number">2</span>, <span class="string">&quot;华山&quot;</span>&#125;);</span><br><span class="line">    m.<span class="built_in">insert</span>(&#123;<span class="number">3</span>, <span class="string">&quot;泰山&quot;</span>&#125;);</span><br><span class="line">    js[<span class="string">&quot;path&quot;</span>] = m;</span><br><span class="line"></span><br><span class="line">    string sendbuf = js.<span class="built_in">dump</span>();</span><br><span class="line">    <span class="keyword">return</span> sendbuf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string jsonstr1 = <span class="built_in">func1</span>();</span><br><span class="line">    cout &lt;&lt; jsonstr1 &lt;&lt; endl;</span><br><span class="line">    string jsonstr2 = <span class="built_in">func2</span>();</span><br><span class="line">    cout &lt;&lt; jsonstr2 &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    json js1 = json::<span class="built_in">parse</span>(jsonstr1);</span><br><span class="line">    json js2 = json::<span class="built_in">parse</span>(jsonstr2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> arr = js1[<span class="string">&quot;id&quot;</span>];</span><br><span class="line">    string name = js1[<span class="string">&quot;name&quot;</span>];</span><br><span class="line">    <span class="keyword">auto</span> it = js1[<span class="string">&quot;msg&quot;</span>];</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; vec = js2[<span class="string">&quot;list&quot;</span>];</span><br><span class="line">    map&lt;<span class="type">int</span>,string&gt; mymap = js2[<span class="string">&quot;path&quot;</span>];</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; arr[<span class="number">0</span>] &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; name &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; it[<span class="string">&quot;zhangsan&quot;</span>] &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; it[<span class="string">&quot;liu shuo&quot;</span>] &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> val:vec)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; val &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> it = mymap.<span class="built_in">begin</span>() ; it != mymap.<span class="built_in">end</span>() ; it++)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; it-&gt;first &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; it-&gt;second &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/2-03(1).png" alt="本地png图片PictureTest.png"></p>
<h2 id="3-muduo网络库编程"><a href="#3-muduo网络库编程" class="headerlink" title="3 muduo网络库编程"></a>3 muduo网络库编程</h2><h3 id="3-1-基于muduo的客户端服务器编程"><a href="#3-1-基于muduo的客户端服务器编程" class="headerlink" title="3.1 基于muduo的客户端服务器编程"></a>3.1 基于muduo的客户端服务器编程</h3><p>代码如下:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">muduo网络库给用户提供了两个主要的类</span></span><br><span class="line"><span class="comment">TcpServer ： 用于编写服务器程序的</span></span><br><span class="line"><span class="comment">TcpClient ： 用于编写客户端程序的</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">epoll + 线程池</span></span><br><span class="line"><span class="comment">好处：能够把网络I/O的代码和业务代码区分开</span></span><br><span class="line"><span class="comment">                        用户的连接和断开       用户的可读写事件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*基于muduo网络库开发服务器程序</span></span><br><span class="line"><span class="comment">1.组合TcpServer对象</span></span><br><span class="line"><span class="comment">2.创建EventLoop事件循环对象的指针</span></span><br><span class="line"><span class="comment">3.明确TcpServer构造函数需要什么参数，输出ChatServer的构造函数</span></span><br><span class="line"><span class="comment">4.在当前服务器类的构造函数当中，注册处理连接的回调函数和处理读写时间的回调函数</span></span><br><span class="line"><span class="comment">5.设置合适的服务端线程数量，muduo库会自己分配I/O线程和worker线程</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/EventLoop.h&gt;</span><span class="comment">//事件循环 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span> <span class="comment">//绑定器 </span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//muduo的名字空间作用域</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> placeholders;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatServer</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ChatServer</span>(EventLoop *loop,               <span class="comment">// 事件循环</span></span><br><span class="line">               <span class="type">const</span> InetAddress &amp;listenAddr, <span class="comment">// IP+Port</span></span><br><span class="line">               <span class="type">const</span> string &amp;nameArg)         <span class="comment">// 服务器的名字</span></span><br><span class="line">        : _server(loop,listenAddr,nameArg),_loop(loop) <span class="comment">//没有默认构造函数</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 给服务器注册用户连接的创建和断开回调</span></span><br><span class="line">        _server.<span class="built_in">setConnectionCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onConnection,<span class="keyword">this</span>,_1));</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 给服务器注册用户读写事件回调</span></span><br><span class="line">        _server.<span class="built_in">setMessageCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onMessage,<span class="keyword">this</span>,_1,_2,_3));</span><br><span class="line">    </span><br><span class="line">          <span class="comment">//设置服务器端的线程数量 1个I/O线程（监听新用户的连接事件）， 3个worker线程</span></span><br><span class="line">        <span class="comment">//不设置的话，就1个线程而已，要处理连接又要处理业务 </span></span><br><span class="line">        _server.<span class="built_in">setThreadNum</span>(<span class="number">4</span>);<span class="comment">//设置4个线程，1个I/O线程，3个worker线程 </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span><span class="comment">//开启事件循环 </span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _server.<span class="built_in">start</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">//专门处理：用户的连接创建和断开 epoll listenfd accept</span></span><br><span class="line">    <span class="comment">//如果有新用户的连接或者断开，muduo库就会调用这个函数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (conn-&gt;<span class="built_in">connected</span>())<span class="comment">//连接 ， peerAddress()对端的地址 localAddress() 本地的地址 </span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; conn-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toIpPort</span>() &lt;&lt; <span class="string">&quot; -&gt; &quot;</span> &lt;&lt; conn-&gt;<span class="built_in">localAddress</span>().<span class="built_in">toIpPort</span>() &lt;&lt; <span class="string">&quot; state:online&quot;</span> &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//断开 </span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; conn-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toIpPort</span>() &lt;&lt; <span class="string">&quot; -&gt; &quot;</span> &lt;&lt; conn-&gt;<span class="built_in">localAddress</span>().<span class="built_in">toIpPort</span>() &lt;&lt; <span class="string">&quot; state:offline&quot;</span> &lt;&lt; endl;</span><br><span class="line">            conn-&gt;<span class="built_in">shutdown</span>();<span class="comment">//相当于这些close(fd)</span></span><br><span class="line">            <span class="comment">//_loop-&gt;quit();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//专门处理：用户的读写事件，muduo库去调用这个函数 </span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, <span class="comment">// 连接，通过这个连接可以读写数据 </span></span></span></span><br><span class="line"><span class="params"><span class="function">                   Buffer *buffer,               <span class="comment">// 缓冲区，提高数据收发的性能</span></span></span></span><br><span class="line"><span class="params"><span class="function">                   Timestamp time)</span>               <span class="comment">// 接收到数据的时间信息</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        string buf = buffer-&gt;<span class="built_in">retrieveAllAsString</span>();<span class="comment">//收到的数据放到这个字符串中 </span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;recv data:&quot;</span> &lt;&lt; buf &lt;&lt; <span class="string">&quot; time:&quot;</span> &lt;&lt; time.<span class="built_in">toFormattedString</span>() &lt;&lt; endl;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(buf);<span class="comment">//返回 ，收到什么发送什么 </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TcpServer _server; <span class="comment">// 第一步</span></span><br><span class="line">    EventLoop *_loop;  <span class="comment">//第二步相当于 epoll 事件循环的指针，有事件发生，loop上报 </span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    EventLoop loop;  <span class="comment">//相当于像是创建了epoll</span></span><br><span class="line">    <span class="function">InetAddress <span class="title">addr</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">6000</span>)</span></span>; <span class="comment">//IP地址，端口号</span></span><br><span class="line">    <span class="function">ChatServer <span class="title">server</span><span class="params">(&amp;loop,addr,<span class="string">&quot;ChatServer&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    server.<span class="built_in">start</span>();  <span class="comment">//listenfd通过 epoll_ctl 添加到 epoll </span></span><br><span class="line">    loop.<span class="built_in">loop</span>();    <span class="comment">//相当于epoll_wait，以阻塞方式等待新用户连接，已连接用户的读写事件等</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用命令进行编译，我们依赖muduo库链接写的函数，链接的时候要这样写</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">g++ muduo_server.cpp -o server -lmuduo_net -lmuduo_base -lpthread</span><br></pre></td></tr></table></figure>

<p>我们再开启一个终端输入命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">telnet 127.0.0.1 6000</span><br></pre></td></tr></table></figure>

<p>连接了</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/3-01(1).png" alt="本地png图片PictureTest.png"></p>
<p>退出连接</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/3-01(2).png" alt="本地png图片PictureTest.png"></p>
<h2 id="4-CMake"><a href="#4-CMake" class="headerlink" title="4 CMake"></a>4 CMake</h2><h3 id="4-1-CMake简介"><a href="#4-1-CMake简介" class="headerlink" title="4.1 CMake简介"></a>4.1 CMake简介</h3><p>​	使用简单方便，可以跨平台，构建项目编译环境。尤其比直接写<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Makefile&spm=1001.2101.3001.7020">Makefile</a>简单（在构建大型工程编译时，需要写大量的文件依赖关</p>
<p>系），可以通过简单的CMake生成负责的Makefile文件。</p>
<h3 id="4-2-CMake安装"><a href="#4-2-CMake安装" class="headerlink" title="4.2 CMake安装"></a>4.2 CMake安装</h3><p>首先使用命令查看，ubuntu系统是否安装CMake</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmake --version</span><br></pre></td></tr></table></figure>

<p>如果没有出现以上结果，就没有安装CMake，直接使用命令安装CMake</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apt-get install cmake</span><br></pre></td></tr></table></figure>

<h3 id="4-3-CMake在Ubuntu的VScode安装插件"><a href="#4-3-CMake在Ubuntu的VScode安装插件" class="headerlink" title="4.3 CMake在Ubuntu的VScode安装插件"></a>4.3 CMake在Ubuntu的<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=VScode&spm=1001.2101.3001.7020">VScode</a>安装插件</h3><p>首先下载CMake和CMake tool，如图所示</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/4-03(1).png" alt="本地png图片PictureTest.png"></p>
<p>在进入CMake Tools的设置，进入settings.json，添加图片中的内容</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/4-03(2).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/4-03(3).png" alt="本地png图片PictureTest.png"></p>
<h3 id="4-4-CMake构建集成编译环境-1"><a href="#4-4-CMake构建集成编译环境-1" class="headerlink" title="4.4 CMake构建集成编译环境(1)"></a>4.4 CMake构建集成编译环境(1)</h3><p><strong>我们在编译出可执行文件需要执行下面这个命令行</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">g++ -o server -g muduo_server.cpp xxx.cpp -I/usr.include -L/usr/lib -lmuduo_net -lmuduo_base -lpthread</span><br><span class="line">	可执行文件</span><br><span class="line">	*.a</span><br><span class="line">	*.so</span><br></pre></td></tr></table></figure>

<p><strong>涉及到 可执行文件，编译参数（-g）（优化级别-O)(这些是编译选项），源文件，头文件的搜索路径，库文件的搜索路径，要链接的库</strong></p>
<p><strong>我们首先在test_muduo下创建CMakeLists.txt</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.10)</span><br><span class="line">project(demo)</span><br><span class="line"></span><br><span class="line"># 配置编译选项</span><br><span class="line">set(CMAKE_CXX_FLAGS $&#123;CMAKE_CXX_FLAGS&#125; -g)</span><br><span class="line"></span><br><span class="line"># 配置头文件搜索路径</span><br><span class="line"># include_directories()</span><br><span class="line"># 配置库文件搜索路径</span><br><span class="line"># link_directories()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 设置需要编译的源文件列表</span><br><span class="line">set(SRC_LIST muduo_server.cpp)</span><br><span class="line"></span><br><span class="line"># 把当前路径下的所有源文件名字放入变量名SRC_LIST里面</span><br><span class="line"># aux_source_directory(. SRC_LIST)</span><br><span class="line"></span><br><span class="line"># 表示生成可执行文件server，由SRC_LIST变量所定义的源文件</span><br><span class="line">add_executable(server $&#123;SRC_LIST&#125;)</span><br><span class="line"># 表示server这个目标程序，需要连接muduo_net muduo_base pthread这三个库文件</span><br><span class="line">target_link_libraries(server muduo_net muduo_base pthread)</span><br></pre></td></tr></table></figure>

<p>我们在test_muduo下编译CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmake .</span><br><span class="line">make</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/4-04(1).png" alt="本地png图片PictureTest.png"></p>
<h3 id="4-5-CMake构建集成编译环境-2"><a href="#4-5-CMake构建集成编译环境-2" class="headerlink" title="4.5 CMake构建集成编译环境(2)"></a>4.5 CMake构建集成编译环境(2)</h3><p>我们在项目中应该这么做：<br>在项目下创建一个bin目录：生成的可执行文件<br>lib目录：生成的库文件<br>include：生成的头文件<br>src:源文件<br>build：编译过程中产生的临时的中间文件<br>test：测试文件<br>example：示例<br>thirdparty：依赖的第三方库<br>然后再放一个：CMakeLists.txt<br>然后我们可以再放一个：autobuild.sh一键编译</p>
<p>首先把上一节生产的编译文件删除，然后创建一个文件夹build</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/4-05(1).png" alt="本地png图片PictureTest.png"></p>
<p>我们在build下编译CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmake ..</span><br><span class="line">make</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/4-05(2).png" alt="本地png图片PictureTest.png"></p>
<p>但是发现所生的可执行也在这个文件夹中，我们需要放在bin文件夹中，我们需要对CMakeLists.txt添加以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 设置可执行文件最终存储的路径</span><br><span class="line">set(EXECUTABLE_OUTPUT_PATH $&#123;PROJECT_SOURCE_DIR&#125;/bin)</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/4-05(3).png" alt="本地png图片PictureTest.png"></p>
<h2 id="5-项目数据库以及表的设计"><a href="#5-项目数据库以及表的设计" class="headerlink" title="5 项目数据库以及表的设计"></a>5 项目数据库以及表的设计</h2><h3 id="5-1-MySQL环境安装设置"><a href="#5-1-MySQL环境安装设置" class="headerlink" title="5.1 MySQL环境安装设置"></a>5.1 MySQL环境安装设置</h3><p>ubuntu环境安装mysql-server和mysql开发包，包括mysql头文件和动态库文件，命令如下 :</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install mysql-server</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/5-01(1).png" alt="本地png图片PictureTest.png"></p>
<p>重新用root和123456登录mysql-server  </p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/5-01(2).png" alt="本地png图片PictureTest.png"></p>
<p>设置MySQL字符编码utf-8，可以支持中文操作  </p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/5-01(3).png" alt="本地png图片PictureTest.png"></p>
<h3 id="5-2-MySQL数据库编程"><a href="#5-2-MySQL数据库编程" class="headerlink" title="5.2 MySQL数据库编程"></a>5.2 MySQL数据库编程</h3><p>新建目录<strong>test_mysql</strong>，新建<strong>Connetion.cpp Connetion.h public.h main.cpp</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/5-02(1).png" alt="本地png图片PictureTest.png"></p>
<p><strong>Connection.h</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">数据库操作代码、增删该查代码实现</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mysql/mysql.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.h&quot;</span></span></span><br><span class="line"><span class="comment">// 数据库操作类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Connection</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// 初始化数据库连接</span></span><br><span class="line">	<span class="built_in">Connection</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 释放数据库连接资源</span></span><br><span class="line">	~<span class="built_in">Connection</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 连接数据库</span></span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">connect</span><span class="params">(string ip,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="type">unsigned</span> <span class="type">short</span> port,</span></span></span><br><span class="line"><span class="params"><span class="function">		string user,</span></span></span><br><span class="line"><span class="params"><span class="function">		string password,</span></span></span><br><span class="line"><span class="params"><span class="function">		string dbname)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 更新操作 insert、delete、update</span></span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">update</span><span class="params">(string sql)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 查询操作 select</span></span><br><span class="line">	<span class="function">MYSQL_RES* <span class="title">query</span><span class="params">(string sql)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	MYSQL* _conn; <span class="comment">// 表示和MySQL Server的一条连接</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注意头文件需要修改为#include &lt;mysql&#x2F;mysql.h&gt;</p>
<p>如果在上面的目录没有找到mysql.h文件，那么你需要安装mysql-devel   在ubuntu下安装mysql-devel命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install libmysqld-dev</span><br></pre></td></tr></table></figure>

<p>需要在c_cpp_properties.json中includePath添加以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;/usr/include&quot; </span><br></pre></td></tr></table></figure>

<p><strong>Connection.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Connection.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">Connection::<span class="built_in">Connection</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		_conn = <span class="built_in">mysql_init</span>(<span class="literal">nullptr</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 释放数据库连接资源</span></span><br><span class="line">Connection::~<span class="built_in">Connection</span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (_conn != <span class="literal">nullptr</span>)</span><br><span class="line">		<span class="built_in">mysql_close</span>(_conn);</span><br><span class="line">&#125;</span><br><span class="line">	<span class="comment">// 连接数据库</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Connection::connect</span><span class="params">(string ip, <span class="type">unsigned</span> <span class="type">short</span> port, string user, string password,</span></span></span><br><span class="line"><span class="params"><span class="function">		string dbname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MYSQL* p = <span class="built_in">mysql_real_connect</span>(_conn, ip.<span class="built_in">c_str</span>(), user.<span class="built_in">c_str</span>(),</span><br><span class="line">		password.<span class="built_in">c_str</span>(), dbname.<span class="built_in">c_str</span>(), port, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> p != <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 更新操作 insert、delete、update</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Connection::update</span><span class="params">(string sql)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">mysql_query</span>(_conn, sql.<span class="built_in">c_str</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">LOG</span>(<span class="string">&quot;更新失败:&quot;</span> + sql);</span><br><span class="line">		cout &lt;&lt; <span class="built_in">mysql_errno</span>(_conn) &lt;&lt; endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">	<span class="comment">// 查询操作 select</span></span><br><span class="line"><span class="function">MYSQL_RES* <span class="title">Connection::query</span><span class="params">(string sql)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">mysql_query</span>(_conn, sql.<span class="built_in">c_str</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">LOG</span>(<span class="string">&quot;查询失败:&quot;</span> + sql);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">mysql_use_result</span>(_conn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>main.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Connection.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	Connection conn;</span><br><span class="line"></span><br><span class="line">	string sql = <span class="string">&quot;insert into employee(sid,name,sex,salary) values(4,&#x27;caiwei&#x27;,&#x27;male&#x27;,11111)&quot;</span>;</span><br><span class="line"></span><br><span class="line">	conn.<span class="built_in">connect</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">3306</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;myb1&quot;</span>);</span><br><span class="line"></span><br><span class="line">	conn.<span class="built_in">update</span>(sql);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后创建数据库，创建表格</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/5-02(2).png" alt="本地png图片PictureTest.png"></p>
<p>然后进行编译，要链接动态库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">g++ -o main main.cpp Connection.cpp Connection.h public.h -L/usr/lib/x86_64-linux-gnu/ -lmysqlclient</span><br></pre></td></tr></table></figure>

<h3 id="5-3-数据库设计"><a href="#5-3-数据库设计" class="headerlink" title="5.3 数据库设计"></a>5.3 数据库设计</h3><p>先新建一个数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create database chat</span><br><span class="line">use chat</span><br></pre></td></tr></table></figure>

<p><strong>设计User表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE user</span><br><span class="line">(</span><br><span class="line">id INT AUTO_INCREMENT,</span><br><span class="line">name VARCHAR(50) NOT NULL UNIQUE,</span><br><span class="line">`password` VARCHAR(50) NOT NULL,</span><br><span class="line">state ENUM(&#x27;online&#x27;,&#x27;offline&#x27;) DEFAULT&#x27;offline&#x27;,</span><br><span class="line">PRIMARY KEY(id)</span><br><span class="line">)ENGINE=INNODB;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/5-03(1).png" alt="本地png图片PictureTest.png"></p>
<p><strong>设计Friend表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE friend</span><br><span class="line">(</span><br><span class="line">`userid` INT NOT NULL,</span><br><span class="line">`friendid` INT NOT NULL,</span><br><span class="line">PRIMARY KEY(`userid`,`friendid`)</span><br><span class="line">)ENGINE=INNODB;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/5-03(2).png" alt="本地png图片PictureTest.png"></p>
<p><strong>设计AllGroup表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE allgroup</span><br><span class="line">(</span><br><span class="line">id INT AUTO_INCREMENT,</span><br><span class="line">groupname VARCHAR(50) NOT NULL UNIQUE,</span><br><span class="line">groupdesc VARCHAR(200) DEFAULT&#x27;&#x27;,</span><br><span class="line">PRIMARY KEY(id)</span><br><span class="line">)ENGINE=INNODB;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/5-03(3).png" alt="本地png图片PictureTest.png"></p>
<p><strong>设计GroupUser表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE groupuser</span><br><span class="line">(</span><br><span class="line">groupid INT NOT NULL,</span><br><span class="line">userid INT NOT NULL,</span><br><span class="line">grouprole enum(&#x27;creator&#x27;,&#x27;normal&#x27;) DEFAULT&#x27;normal&#x27;,</span><br><span class="line">PRIMARY KEY(groupid,userid)</span><br><span class="line">)ENGINE=INNODB;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/5-03(4).png" alt="本地png图片PictureTest.png"></p>
<p><strong>设计OfflineMessage表</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE offlinemessage</span><br><span class="line">(</span><br><span class="line">userid INT NOT NULL,</span><br><span class="line">message VARCHAR(500) NOT NULL</span><br><span class="line">)ENGINE=INNODB;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/5-03(5).png" alt="本地png图片PictureTest.png"></p>
<h2 id="6-集群聊天项目工程目录创建"><a href="#6-集群聊天项目工程目录创建" class="headerlink" title="6 集群聊天项目工程目录创建"></a>6 集群聊天项目工程目录创建</h2><p>目录如下:</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/6-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><strong>我们的聊天服务器程序和客户端程序都在一个工程里面，最后在bin生成2个可执行文件，一个是服务器，一个是客户端。</strong></p>
<p><strong>配置chatserver(根)下的CMakeLists.txt</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.10)</span><br><span class="line">project(chat)</span><br><span class="line"></span><br><span class="line"># 配置编译选项</span><br><span class="line">set(CMAKE_CXX_FLAGS $&#123;CMAKE_CXX_FLAGS&#125; -g)</span><br><span class="line"></span><br><span class="line"># 设置可执行文件最终存储的路径</span><br><span class="line">set(EXECUTABLE_OUTPUT_PATH $&#123;PROJECT_SOURCE_DIR&#125;/bin)</span><br><span class="line"></span><br><span class="line"># 配置头文件的搜索路径</span><br><span class="line">include_directories($&#123;PROJECT_SOURCE_DIR&#125;/include)</span><br><span class="line">include_directories($&#123;PROJECT_SOURCE_DIR&#125;/include/server)</span><br><span class="line"></span><br><span class="line">set(CMAKE_EXPORT_COMPILE_COMMANDS ON)</span><br><span class="line"></span><br><span class="line">add_subdirectory(src)</span><br></pre></td></tr></table></figure>

<p><strong>它就会跑去src目录下找CMakeLists.txt文件。所以，我们在src下创建CMakeLists.txt</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">add_subdirectory(server)</span><br></pre></td></tr></table></figure>

<p><strong>因为我们先开发server，所以先不添加客户端client，我们还要在server下创建CMakeLists.txt</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 把当前路径下的所有源文件名字放入变量名SRC_LIST里面</span><br><span class="line">aux_source_directory(. SRC_LIST)</span><br><span class="line"></span><br><span class="line"># 表示生成可执行文件ChatServer，由SRC_LIST变量所定义的源文件</span><br><span class="line">add_executable(ChatServer $&#123;SRC_LIST&#125;)</span><br><span class="line"></span><br><span class="line"># 指定可执行文件链接时需要依赖的库文件</span><br><span class="line">target_link_libraries(ChatServer muduo_net muduo_base  pthread)</span><br></pre></td></tr></table></figure>

<h2 id="7-网络模块代码ChatServer"><a href="#7-网络模块代码ChatServer" class="headerlink" title="7 网络模块代码ChatServer"></a>7 网络模块代码ChatServer</h2><p><strong>首先我们在include&#x2F;server下创建chatserver.hpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">muduo网络库给用户提供了两个主要的类</span></span><br><span class="line"><span class="comment">TcpServer ： 用于编写服务器程序的</span></span><br><span class="line"><span class="comment">TcpClient ： 用于编写客户端程序的</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">epoll + 线程池</span></span><br><span class="line"><span class="comment">好处：能够把网络I/O的代码和业务代码区分开</span></span><br><span class="line"><span class="comment">                        用户的连接和断开       用户的可读写事件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*基于muduo网络库开发服务器程序</span></span><br><span class="line"><span class="comment">1.组合TcpServer对象</span></span><br><span class="line"><span class="comment">2.创建EventLoop事件循环对象的指针</span></span><br><span class="line"><span class="comment">3.明确TcpServer构造函数需要什么参数，输出ChatServer的构造函数</span></span><br><span class="line"><span class="comment">4.在当前服务器类的构造函数当中，注册处理连接的回调函数和处理读写时间的回调函数</span></span><br><span class="line"><span class="comment">5.设置合适的服务端线程数量，muduo库会自己分配I/O线程和worker线程</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/EventLoop.h&gt;</span><span class="comment">//事件循环 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span> <span class="comment">//绑定器 </span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//muduo的名字空间作用域</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> placeholders;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatServer</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ChatServer</span>(EventLoop *loop,               <span class="comment">// 事件循环</span></span><br><span class="line">               <span class="type">const</span> InetAddress &amp;listenAddr, <span class="comment">// IP+Port</span></span><br><span class="line">               <span class="type">const</span> string &amp;nameArg);         <span class="comment">// 服务器的名字</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>;<span class="comment">//开启事件循环 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">//专门处理：用户的连接创建和断开 epoll listenfd accept</span></span><br><span class="line">    <span class="comment">//如果有新用户的连接或者断开，muduo库就会调用这个函数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//专门处理：用户的读写事件，muduo库去调用这个函数 </span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, <span class="comment">// 连接，通过这个连接可以读写数据 </span></span></span></span><br><span class="line"><span class="params"><span class="function">                   Buffer *buffer,               <span class="comment">// 缓冲区，提高数据收发的性能</span></span></span></span><br><span class="line"><span class="params"><span class="function">                   Timestamp time)</span> </span>;              <span class="comment">// 接收到数据的时间信息</span></span><br><span class="line"></span><br><span class="line">    TcpServer _server; <span class="comment">// 第一步</span></span><br><span class="line">    EventLoop *_loop;  <span class="comment">//第二步相当于 epoll 事件循环的指针，有事件发生，loop上报 </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>在src&#x2F;server下创建chatserver.cpp main.cpp</strong></p>
<p><strong>charserver.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatserver.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line">ChatServer::<span class="built_in">ChatServer</span>(EventLoop *loop,               <span class="comment">// 事件循环</span></span><br><span class="line">               <span class="type">const</span> InetAddress &amp;listenAddr, <span class="comment">// IP+Port</span></span><br><span class="line">               <span class="type">const</span> string &amp;nameArg)</span><br><span class="line">            : _server(loop,listenAddr,nameArg),_loop(loop)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 给服务器注册用户连接的创建和断开回调</span></span><br><span class="line">    _server.<span class="built_in">setConnectionCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onConnection,<span class="keyword">this</span>,_1));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给服务器注册用户读写事件回调</span></span><br><span class="line">    _server.<span class="built_in">setMessageCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onMessage,<span class="keyword">this</span>,_1,_2,_3));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置服务器端的线程数量 1个I/O线程（监听新用户的连接事件）， 3个worker线程</span></span><br><span class="line">    <span class="comment">//不设置的话，就1个线程而已，要处理连接又要处理业务 </span></span><br><span class="line">    _server.<span class="built_in">setThreadNum</span>(<span class="number">4</span>);<span class="comment">//设置4个线程，1个I/O线程，3个worker线程 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _server.<span class="built_in">start</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::onConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, </span></span></span><br><span class="line"><span class="params"><span class="function">                   Buffer *buffer,              </span></span></span><br><span class="line"><span class="params"><span class="function">                   Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>main.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatserver.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    EventLoop loop;  <span class="comment">//相当于像是创建了epoll</span></span><br><span class="line">    <span class="function">InetAddress <span class="title">addr</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">6000</span>)</span></span>; <span class="comment">//IP地址，端口号</span></span><br><span class="line">    <span class="function">ChatServer <span class="title">server</span><span class="params">(&amp;loop,addr,<span class="string">&quot;ChatServer&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    server.<span class="built_in">start</span>();  <span class="comment">//listenfd通过 epoll_ctl 添加到 epoll </span></span><br><span class="line">    loop.<span class="built_in">loop</span>();    <span class="comment">//相当于epoll_wait，以阻塞方式等待新用户连接，已连接用户的读写事件等</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-业务模块代码ChatService"><a href="#8-业务模块代码ChatService" class="headerlink" title="8 业务模块代码ChatService"></a>8 业务模块代码ChatService</h2><p><strong>首先我们对&#x2F;src&#x2F;server&#x2F;chatserver.cpp继续完善</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;include/server/chatserver.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ChatServer::<span class="built_in">ChatServer</span>(EventLoop *loop,               <span class="comment">// 事件循环</span></span><br><span class="line">               <span class="type">const</span> InetAddress &amp;listenAddr, <span class="comment">// IP+Port</span></span><br><span class="line">               <span class="type">const</span> string &amp;nameArg)</span><br><span class="line">            : _server(loop,listenAddr,nameArg),_loop(loop)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 给服务器注册用户连接的创建和断开回调</span></span><br><span class="line">    _server.<span class="built_in">setConnectionCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onConnection,<span class="keyword">this</span>,_1));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给服务器注册用户读写事件回调</span></span><br><span class="line">    _server.<span class="built_in">setMessageCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onMessage,<span class="keyword">this</span>,_1,_2,_3));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置服务器端的线程数量 1个I/O线程（监听新用户的连接事件）， 3个worker线程</span></span><br><span class="line">    <span class="comment">//不设置的话，就1个线程而已，要处理连接又要处理业务 </span></span><br><span class="line">    _server.<span class="built_in">setThreadNum</span>(<span class="number">4</span>);<span class="comment">//设置4个线程，1个I/O线程，3个worker线程 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _server.<span class="built_in">start</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::onConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//客户端断开连接</span></span><br><span class="line">    <span class="keyword">if</span> (!conn-&gt;<span class="built_in">connected</span>()) </span><br><span class="line">    &#123;</span><br><span class="line">        conn-&gt;<span class="built_in">shutdown</span>();<span class="comment">//相当于这些close(fd)</span></span><br><span class="line">        <span class="comment">//_loop-&gt;quit();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, </span></span></span><br><span class="line"><span class="params"><span class="function">                   Buffer *buffer,              </span></span></span><br><span class="line"><span class="params"><span class="function">                   Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string buf = buffer-&gt;<span class="built_in">retrieveAllAsString</span>();<span class="comment">//收到的数据放到这个字符串中 </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//数据的反序列化</span></span><br><span class="line">    json js = json::<span class="built_in">parse</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>我们在include下的server创建头文件：chatservice.hpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;thirdparty/json.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>我们在include下定义一个文件：public.hpp（公共的文件）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifndef PUBLIC_H</span><br><span class="line">#define PUBLIC_H</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">是属于server和client的公共文件</span><br><span class="line">*/</span><br><span class="line">enum EnMsgType</span><br><span class="line">&#123;</span><br><span class="line">    LOGIN_MSG = 1,//登录消息</span><br><span class="line">    REG_MSG, //注册消息</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#endif // !PUBLIC_H</span><br></pre></td></tr></table></figure>

<h2 id="9-网络模块和业务模块耦合度降级代码处理"><a href="#9-网络模块和业务模块耦合度降级代码处理" class="headerlink" title="9 网络模块和业务模块耦合度降级代码处理"></a>9 网络模块和业务模块耦合度降级代码处理</h2><p><strong>我们在src的server下创建一个文件：chatservice.cpp</strong>（服务）</p>
<p>增加对获取消息对应的处理器函数编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LOG_INFO&lt;&lt;<span class="string">&quot;do login service!!!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LOG_INFO&lt;&lt;<span class="string">&quot;do reg service!!!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>我们对&#x2F;include&#x2F;server&#x2F;chatservice.hpp继续完善</strong></p>
<p>增加对获取消息对应的处理器函数声明</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span> <span class="comment">//一个消息ID映射一个事件处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;thirdparty/json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>我们对&#x2F;src&#x2F;server&#x2F;chatserver.cpp继续完善</strong></p>
<p>增加对解耦网络模块的代码和业务模块的代码编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;include/server/chatserver.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ChatServer::<span class="built_in">ChatServer</span>(EventLoop *loop,               <span class="comment">// 事件循环</span></span><br><span class="line">               <span class="type">const</span> InetAddress &amp;listenAddr, <span class="comment">// IP+Port</span></span><br><span class="line">               <span class="type">const</span> string &amp;nameArg)</span><br><span class="line">            : _server(loop,listenAddr,nameArg),_loop(loop)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 给服务器注册用户连接的创建和断开回调</span></span><br><span class="line">    _server.<span class="built_in">setConnectionCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onConnection,<span class="keyword">this</span>,_1));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给服务器注册用户读写事件回调</span></span><br><span class="line">    _server.<span class="built_in">setMessageCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onMessage,<span class="keyword">this</span>,_1,_2,_3));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置服务器端的线程数量 1个I/O线程（监听新用户的连接事件）， 3个worker线程</span></span><br><span class="line">    <span class="comment">//不设置的话，就1个线程而已，要处理连接又要处理业务 </span></span><br><span class="line">    _server.<span class="built_in">setThreadNum</span>(<span class="number">4</span>);<span class="comment">//设置4个线程，1个I/O线程，3个worker线程 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _server.<span class="built_in">start</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::onConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//客户端断开连接</span></span><br><span class="line">    <span class="keyword">if</span> (!conn-&gt;<span class="built_in">connected</span>()) </span><br><span class="line">    &#123;</span><br><span class="line">        conn-&gt;<span class="built_in">shutdown</span>();<span class="comment">//相当于这些close(fd)</span></span><br><span class="line">        <span class="comment">//_loop-&gt;quit();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, </span></span></span><br><span class="line"><span class="params"><span class="function">                   Buffer *buffer,              </span></span></span><br><span class="line"><span class="params"><span class="function">                   Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string buf = buffer-&gt;<span class="built_in">retrieveAllAsString</span>();<span class="comment">//收到的数据放到这个字符串中 </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//数据的反序列化</span></span><br><span class="line">    json js = json::<span class="built_in">parse</span>(buf);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//达到的目的：完全解耦网络模块的代码和业务模块的代码</span></span><br><span class="line">    <span class="comment">//通过js[&quot;msgid&quot;] 获取=》业务handler处理器（在业务模块事先绑定好的）=》conn  js  time传给你 </span></span><br><span class="line">    <span class="keyword">auto</span> msgHandler = ChatService::<span class="built_in">instance</span>()-&gt;<span class="built_in">getHandler</span>(js[<span class="string">&quot;msgid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());<span class="comment">//转成整型 </span></span><br><span class="line">    <span class="comment">//回调消息绑定好的事件处理器，来执行相应的业务处理，一个ID一个操作 </span></span><br><span class="line">    <span class="built_in">msgHandler</span>(conn, js, time);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-网络模块分发业务事件回调操作功能测试"><a href="#10-网络模块分发业务事件回调操作功能测试" class="headerlink" title="10 网络模块分发业务事件回调操作功能测试"></a>10 网络模块分发业务事件回调操作功能测试</h2><p><strong>写完代码我们测试一下，首先cmake一下，然后make，产生二进制文件Chatserver</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/10-01(1).png" alt="本地png图片PictureTest.png"></p>
<h2 id="11-MySQL数据库代码封装"><a href="#11-MySQL数据库代码封装" class="headerlink" title="11 MySQL数据库代码封装"></a>11 MySQL数据库代码封装</h2><p><strong>我们在上一节中把网络模块和业务模块的代码通过事件回调完全地拆分开。现在我们需要把业务模块的和数据层的代码区分开。</strong></p>
<p><strong>我们在include下的server下创建一个文件夹：db，然后完善项目工程目录上的CMakeLists.txt</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.10)</span><br><span class="line">project(chat)</span><br><span class="line"></span><br><span class="line"># 配置编译选项</span><br><span class="line">set(CMAKE_CXX_FLAGS $&#123;CMAKE_CXX_FLAGS&#125; -g)</span><br><span class="line"></span><br><span class="line"># 设置可执行文件最终存储的路径</span><br><span class="line">set(EXECUTABLE_OUTPUT_PATH $&#123;PROJECT_SOURCE_DIR&#125;/bin)</span><br><span class="line"></span><br><span class="line"># 配置头文件的搜索路径</span><br><span class="line">include_directories($&#123;PROJECT_SOURCE_DIR&#125;/include)</span><br><span class="line">include_directories($&#123;PROJECT_SOURCE_DIR&#125;/include/server)</span><br><span class="line">include_directories($&#123;PROJECT_SOURCE_DIR&#125;/thirdparty)</span><br><span class="line">include_directories($&#123;PROJECT_SOURCE_DIR&#125;/include/server/db)</span><br><span class="line"></span><br><span class="line">add_subdirectory(src)</span><br></pre></td></tr></table></figure>

<p><strong>然后我们完善src下的server下的CMakeLists.txt</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 把当前路径下的所有源文件名字放入变量名SRC_LIST里面</span><br><span class="line">aux_source_directory(. SRC_LIST)</span><br><span class="line"></span><br><span class="line"># 表示生成可执行文件ChatServer，由SRC_LIST变量所定义的源文件</span><br><span class="line">add_executable(ChatServer $&#123;SRC_LIST&#125;)</span><br><span class="line"></span><br><span class="line"># 指定可执行文件链接时需要依赖的库文件</span><br><span class="line">target_link_libraries(ChatServer muduo_net muduo_base  pthread mysqlclient)</span><br></pre></td></tr></table></figure>

<p><strong>我们在include下的server下的db下，创建头文件:db.hpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DB_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DB_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mysql/mysql.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据库操作类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MySQL</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// 初始化数据库连接</span></span><br><span class="line">	<span class="built_in">MySQL</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 释放数据库连接资源</span></span><br><span class="line">	~<span class="built_in">MySQL</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 连接数据库</span></span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">connect</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 更新操作 insert、delete、update</span></span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">update</span><span class="params">(string sql)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 查询操作 select</span></span><br><span class="line">	<span class="function">MYSQL_RES* <span class="title">query</span><span class="params">(string sql)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	MYSQL* _conn; <span class="comment">// 表示和MySQL Server的一条连接</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !DB_H</span></span></span><br></pre></td></tr></table></figure>

<p><strong>我们在src下的server下创建文件夹：db</strong><br><strong>我们在src下的server下的db下创建文件：db.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;db.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//数据库配置信息</span></span><br><span class="line"><span class="type">static</span> string server = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="type">static</span> string user = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="type">static</span> string password = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"><span class="type">static</span> string dbname = <span class="string">&quot;chat&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化数据库连接</span></span><br><span class="line">MySQL::<span class="built_in">MySQL</span>()</span><br><span class="line">&#123;</span><br><span class="line">    _conn = <span class="built_in">mysql_init</span>(<span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//释放数据库连接资源</span></span><br><span class="line">MySQL::~<span class="built_in">MySQL</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_conn != <span class="literal">nullptr</span>)</span><br><span class="line">        <span class="built_in">mysql_close</span>(_conn);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//连接数据库</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MySQL::connect</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   MYSQL *p = <span class="built_in">mysql_real_connect</span>(_conn, server.<span class="built_in">c_str</span>(), user.<span class="built_in">c_str</span>(),</span><br><span class="line">                                  password.<span class="built_in">c_str</span>(), dbname.<span class="built_in">c_str</span>(), <span class="number">3306</span>, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//C和C++代码默认的编码字符是ASCII，如果不设置，从MySQL上拉下来的中文显示？</span></span><br><span class="line">        <span class="built_in">mysql_query</span>(_conn, <span class="string">&quot;set names gbk&quot;</span>);</span><br><span class="line">        LOG_INFO &lt;&lt; <span class="string">&quot;connect mysql success!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LOG_INFO &lt;&lt; <span class="string">&quot;connect mysql fail!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新操作</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MySQL::update</span><span class="params">(string sql)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">mysql_query</span>(_conn, sql.<span class="built_in">c_str</span>()))</span><br><span class="line">    &#123;</span><br><span class="line">        LOG_INFO &lt;&lt; __FILE__ &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; __LINE__ &lt;&lt; <span class="string">&quot;:&quot;</span></span><br><span class="line">                 &lt;&lt; sql &lt;&lt; <span class="string">&quot;更新失败!&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询操作</span></span><br><span class="line"><span class="function">MYSQL_RES * <span class="title">MySQL::query</span><span class="params">(string sql)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">mysql_query</span>(_conn, sql.<span class="built_in">c_str</span>()))</span><br><span class="line">    &#123;</span><br><span class="line">        LOG_INFO &lt;&lt; __FILE__ &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; __LINE__ &lt;&lt; <span class="string">&quot;:&quot;</span></span><br><span class="line">                 &lt;&lt; sql &lt;&lt; <span class="string">&quot;查询失败!&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">mysql_use_result</span>(_conn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>我们完善src下的server的CMakeLists.txt</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 把当前路径下的所有源文件名字放入变量名SRC_LIST里面</span><br><span class="line">aux_source_directory(. SRC_LIST)</span><br><span class="line">aux_source_directory(./db DB_LIST)</span><br><span class="line"></span><br><span class="line"># 表示生成可执行文件ChatServer，由SRC_LIST变量所定义的源文件</span><br><span class="line">add_executable(ChatServer $&#123;SRC_LIST&#125; $&#123;DB_LIST&#125;)</span><br><span class="line"></span><br><span class="line"># 指定可执行文件链接时需要依赖的库文件</span><br><span class="line">target_link_libraries(ChatServer muduo_net muduo_base  pthread mysqlclient)</span><br></pre></td></tr></table></figure>

<p><strong>保存，编译成功</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/11-01(1).png" alt="本地png图片PictureTest.png"></p>
<h2 id="12-Model数据层代码框架设计"><a href="#12-Model数据层代码框架设计" class="headerlink" title="12 Model数据层代码框架设计"></a>12 Model数据层代码框架设计</h2><p><strong>数据库的操作和业务代码分离开，在业务层看到对象，在数据库层看到数据库的操作。我们要定义相关的一些类，和数据库的表一一对应的，才能把数据库读出来的字段合成一个对象提供给业务方去使用！</strong></p>
<p><strong>我们在include下的server下的创建文件：user.hpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> USER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">User</span>(<span class="type">int</span> id = <span class="number">-1</span>,string name = <span class="string">&quot;&quot;</span>,string pwd = <span class="string">&quot;&quot;</span>,string state = <span class="string">&quot;offline&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;id = id;</span><br><span class="line">        <span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">        <span class="keyword">this</span>-&gt;password = pwd;</span><br><span class="line">        <span class="keyword">this</span>-&gt;state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setId</span><span class="params">(<span class="type">int</span> id)</span> </span>&#123; <span class="keyword">this</span>-&gt;id = id; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setName</span><span class="params">(string name)</span> </span>&#123; <span class="keyword">this</span>-&gt;name = name; &#125;  </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setPassword</span><span class="params">(string pwd)</span> </span>&#123; <span class="keyword">this</span>-&gt;password = pwd; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setState</span><span class="params">(string state)</span> </span>&#123; <span class="keyword">this</span>-&gt;state = state; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;id; &#125;</span><br><span class="line">    <span class="function">string <span class="title">getName</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;name; &#125; </span><br><span class="line">    <span class="function">string <span class="title">getPassword</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;password; &#125;</span><br><span class="line">    <span class="function">string <span class="title">getState</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;state; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    string name;</span><br><span class="line">    string password;</span><br><span class="line">    string state;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><strong>我们在include下的server下的创建文件：usermodel.hpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> USERMODEL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USERMODEL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;db.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserModel</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">insert</span><span class="params">(User &amp;user)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><strong>我们在src下的server下的创建文件：usermodel.cpp</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#include &quot;usermodel.hpp&quot;</span><br><span class="line"></span><br><span class="line">//User表的增加方法</span><br><span class="line">bool UserModel::insert(User &amp;user)</span><br><span class="line">&#123;</span><br><span class="line">    //1.组装sql语句</span><br><span class="line">    char sql[1024] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    sprintf(sql,&quot;insert into user(name,passsword,state) values(%d,&#x27;%s&#x27;,&#x27;%s&#x27;)&quot;,</span><br><span class="line">    user.getName().c_str(), user.getPassword().c_str(), user.getState().c_str());</span><br><span class="line"></span><br><span class="line">    MySQL mysql;//定义一个mysql对象</span><br><span class="line"></span><br><span class="line">    if(mysql.connect())//连接成功了 </span><br><span class="line">    &#123;</span><br><span class="line">        if(mysql.update(sql))//更新这个sql语句传进去 </span><br><span class="line">        &#123;</span><br><span class="line">              //获取插入成功的用户数据生成的主键id</span><br><span class="line">              //这里需要完善一下dp.hpp,dp.cpp，增加一个函数，获取连接。</span><br><span class="line">            user.setId(mysql_insert_id(mysql.getConnection()));</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="13-用户注册业务代码编写和测试"><a href="#13-用户注册业务代码编写和测试" class="headerlink" title="13 用户注册业务代码编写和测试"></a>13 用户注册业务代码编写和测试</h2><p><strong>我们先完善&#x2F;include&#x2F;server&#x2F;chatservice.hpp</strong></p>
<p>声明数据操作类对象</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span> <span class="comment">//一个消息ID映射一个事件处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据操作类对象</span></span><br><span class="line">    UserModel _userModel;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善一下&#x2F;include&#x2F;public.hpp</strong></p>
<p>增加注册回应消息</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PUBLIC_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUBLIC_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">是属于server和client的公共文件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">EnMsgType</span></span><br><span class="line">&#123;</span><br><span class="line">    LOGIN_MSG = <span class="number">1</span>,<span class="comment">//登录消息</span></span><br><span class="line">    REG_MSG, <span class="comment">//注册消息</span></span><br><span class="line">    REG_MSG_ACK, <span class="comment">//注册回应消息</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !PUBLIC_H</span></span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;src&#x2F;server&#x2F;chatservice.cpp</strong></p>
<p>完成处理注册业务函数的编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LOG_INFO&lt;&lt;<span class="string">&quot;do login service!!!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];  <span class="comment">//获取名字 </span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码</span></span><br><span class="line"></span><br><span class="line">    User user;  <span class="comment">//创建用户对象 </span></span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_userModel.<span class="built_in">insert</span>(user)) <span class="comment">//插入成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册成功</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>保存，编译成功</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/13-01(1).png" alt="本地png图片PictureTest.png"></p>
<h2 id="14-用户登录业务代码编写和测试"><a href="#14-用户登录业务代码编写和测试" class="headerlink" title="14 用户登录业务代码编写和测试"></a>14 用户登录业务代码编写和测试</h2><p><strong>我们完善&#x2F;src&#x2F;server&#x2F;chatservice.cpp</strong></p>
<p>增加对登录业务代码的编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取id号</span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码 </span></span><br><span class="line"></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id); <span class="comment">//查找 这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getPassword</span>() == password) <span class="comment">//查出来了，登录成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>) <span class="comment">//该用户已经登录，不允许重复登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;this account is using,input another&quot;</span>;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串            </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">             <span class="comment">//登录成功，更新用户状态信息 state offline=&gt;online</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">&quot;online&quot;</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user); <span class="comment">//这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">            response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串 </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//该用户不存在，用户存在但是密码错误，登录失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;id or password is invalid&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];  <span class="comment">//获取名字 </span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码</span></span><br><span class="line"></span><br><span class="line">    User user;  <span class="comment">//创建用户对象 </span></span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_userModel.<span class="built_in">insert</span>(user)) <span class="comment">//插入成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册成功</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>这里要完善&#x2F;src&#x2F;server&#x2F;usermodel.cpp &#x2F;include&#x2F;server&#x2F;usermodel.hpp</strong></p>
<p>增加对updateState函数的声明，对updateState函数的编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> USERMODEL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USERMODEL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;db.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//User表的数据操作类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserModel</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//User表的增加方法</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">insert</span><span class="params">(User &amp;user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据用户号码查询用户信息</span></span><br><span class="line">    <span class="function">User <span class="title">query</span><span class="params">(<span class="type">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新用户的信息</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">updateState</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//User表的增加方法</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UserModel::insert</span><span class="params">(User &amp;user)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1.组装sql语句</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;insert into user(name,password,state) values(&#x27;%s&#x27;,&#x27;%s&#x27;,&#x27;%s&#x27;)&quot;</span>,</span><br><span class="line">    user.<span class="built_in">getName</span>().<span class="built_in">c_str</span>(), user.<span class="built_in">getPassword</span>().<span class="built_in">c_str</span>(), user.<span class="built_in">getState</span>().<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    MySQL mysql;<span class="comment">//定义一个mysql对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())<span class="comment">//连接成功了 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mysql.<span class="built_in">update</span>(sql))<span class="comment">//更新这个sql语句传进去 </span></span><br><span class="line">        &#123;</span><br><span class="line">              <span class="comment">//获取插入成功的用户数据生成的主键id</span></span><br><span class="line">            user.<span class="built_in">setId</span>(<span class="built_in">mysql_insert_id</span>(mysql.<span class="built_in">getConnection</span>()));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据用户号码查询用户信息</span></span><br><span class="line"><span class="function">User <span class="title">UserModel::query</span><span class="params">(<span class="type">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="comment">//1.组装sql语句</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;select * from user where id = &#x27;%d&#x27;&quot;</span>,id);</span><br><span class="line"></span><br><span class="line">    MySQL mysql;<span class="comment">//定义一个mysql对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())<span class="comment">//连接成功了 </span></span><br><span class="line">    &#123;</span><br><span class="line">        MYSQL_RES * res = mysql.<span class="built_in">query</span>(sql); <span class="comment">//调用mysql数据库的查询 </span></span><br><span class="line">        <span class="keyword">if</span>(res != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            MYSQL_ROW  row = <span class="built_in">mysql_fetch_row</span>(res); <span class="comment">//获取行，用主键查的，查一行</span></span><br><span class="line">            <span class="keyword">if</span>(row != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                User user;</span><br><span class="line">                user.<span class="built_in">setId</span>(<span class="built_in">atoi</span>(row[<span class="number">0</span>]));</span><br><span class="line">                user.<span class="built_in">setName</span>(row[<span class="number">1</span>]);</span><br><span class="line">                user.<span class="built_in">setPassword</span>(row[<span class="number">2</span>]);</span><br><span class="line">                user.<span class="built_in">setState</span>(row[<span class="number">3</span>]);</span><br><span class="line">                <span class="built_in">mysql_free_result</span>(res);  <span class="comment">//释放资源 </span></span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    else</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        return User();  //当没有查询到的时候，没有返回任何值，这是错误的。</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">User</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UserModel::updateState</span><span class="params">(User user)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="comment">//1.组装sql语句</span></span><br><span class="line">    <span class="type">int</span> id = user.<span class="built_in">getId</span>();</span><br><span class="line">    string state = user.<span class="built_in">getState</span>();</span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;update user set state = &#x27;%s&#x27; where id = &#x27;%d&#x27;&quot;</span>,state.<span class="built_in">c_str</span>(),id);</span><br><span class="line"></span><br><span class="line">    MySQL mysql;<span class="comment">//定义一个mysql对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())<span class="comment">//连接成功了 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mysql.<span class="built_in">update</span>(sql))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/14-01(1).png" alt="本地png图片PictureTest.png"></p>
<h2 id="15-记录用户的连接信息以及线程安全问题"><a href="#15-记录用户的连接信息以及线程安全问题" class="headerlink" title="15 记录用户的连接信息以及线程安全问题"></a>15 记录用户的连接信息以及线程安全问题</h2><p>假设有2个用户，用户1把它的id号和要说的内容发过去，服务器要主动地去给用户2推送这个消息，但是用户2又不知道什么时候谁会给他说话，他不可能去服务器</p>
<p>上拉取消息，所以这个聊天 肯定得是服务器推送给用户2，所以聊天服务器也必须是长连接，不仅仅是客户端请求，服务端被动接收，而且服务端还要主动推送消</p>
<p>息到客户端，所以我们拿到用户2的id号，怎么知道这个用户的连接connection在哪里，所以，我们在业务层要想办法，一个用户一个connection，登录成功，连</p>
<p>接就建立成功了，这个连接就可以存储下来。</p>
<p><strong>我们先完善&#x2F;include&#x2F;server&#x2F;chatservice.hpp</strong></p>
<p>增加存储在线用户的通信连接，用unordered_map存储</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span> <span class="comment">//一个消息ID映射一个事件处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储在线用户的通信连接，用户的id， TcpConnectionPtr</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,TcpConnectionPtr&gt; __userConnMap;</span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据操作类对象</span></span><br><span class="line">    UserModel _userModel;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;src&#x2F;server&#x2F;chatservice.cpp</strong></p>
<p>增加登录成功后，记录用户连接信息</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取id号</span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码 </span></span><br><span class="line"></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id); <span class="comment">//查找 这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getPassword</span>() == password) <span class="comment">//查出来了，登录成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>) <span class="comment">//该用户已经登录，不允许重复登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;this account is using,input another&quot;</span>;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串            </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//登录成功，记录用户连接信息，当多个用户登录时，都会操作这个_userConnMap</span></span><br><span class="line">            __userConnMap.<span class="built_in">insert</span>(&#123;id,conn&#125;);</span><br><span class="line"></span><br><span class="line">             <span class="comment">//登录成功，更新用户状态信息 state offline=&gt;online</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">&quot;online&quot;</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user); <span class="comment">//这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">            response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串 </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//该用户不存在，用户存在但是密码错误，登录失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;id or password is invalid&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];  <span class="comment">//获取名字 </span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码</span></span><br><span class="line"></span><br><span class="line">    User user;  <span class="comment">//创建用户对象 </span></span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_userModel.<span class="built_in">insert</span>(user)) <span class="comment">//插入成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册成功</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当多个用户登录时，都会操作这个_userConnMap，所以需要保证一下线程安全。</p>
<p><strong>我们在&#x2F;include&#x2F;server&#x2F;chatservice.hpp添加一把互斥锁</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span> <span class="comment">//一个消息ID映射一个事件处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储在线用户的通信连接，用户的id， TcpConnectionPtr</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,TcpConnectionPtr&gt; _userConnMap;</span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据操作类对象</span></span><br><span class="line">    UserModel _userModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义互斥锁，保证_userConnMap的线程安全</span></span><br><span class="line">    mutex _connMutex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;src&#x2F;server&#x2F;chatservice.cpp</strong></p>
<p>为了_userConnMap的线程，需要加一把互斥锁。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取id号</span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码 </span></span><br><span class="line"></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id); <span class="comment">//查找 这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getPassword</span>() == password) <span class="comment">//查出来了，登录成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>) <span class="comment">//该用户已经登录，不允许重复登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;this account is using,input another&quot;</span>;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串            </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//登录成功，记录用户连接信息，当多个用户登录时，都会操作这个_userConnMap</span></span><br><span class="line">            &#123;</span><br><span class="line">                lock_guard&lt;mutex&gt; <span class="built_in">lock</span>(_connMutex);</span><br><span class="line">                _userConnMap.<span class="built_in">insert</span>(&#123;id,conn&#125;);</span><br><span class="line">            &#125;<span class="comment">//加个作用域，出了这个右括号就自动解锁</span></span><br><span class="line">            </span><br><span class="line">             <span class="comment">//登录成功，更新用户状态信息 state offline=&gt;online</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">&quot;online&quot;</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user); <span class="comment">//这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">            response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串 </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//该用户不存在，用户存在但是密码错误，登录失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;id or password is invalid&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];  <span class="comment">//获取名字 </span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码</span></span><br><span class="line"></span><br><span class="line">    User user;  <span class="comment">//创建用户对象 </span></span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_userModel.<span class="built_in">insert</span>(user)) <span class="comment">//插入成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册成功</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编译一下</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/15-01(1).png" alt="本地png图片PictureTest.png"></p>
<h2 id="16-客户端异常退出业务代码编写和测试"><a href="#16-客户端异常退出业务代码编写和测试" class="headerlink" title="16 客户端异常退出业务代码编写和测试"></a>16 客户端异常退出业务代码编写和测试</h2><p>我们要处理一下客户端的异常退出，客户端在没有任何响应的情况下，直接给异常退出了，它在目前的代码下，退出没有合法的json<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%AD%97%E7%AC%A6%E4%B8%B2&spm=1001.2101.3001.7020">字符串</a>，json请求，而只是网</p>
<p>络连接断开了，我们还要修改用户的状态为offline。</p>
<p><strong>我们先完善&#x2F;src&#x2F;server&#x2F;chatserver.cpp</strong></p>
<p>客户端断开连接代码上增加客户端异常关闭的代码</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatserver.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line">ChatServer::<span class="built_in">ChatServer</span>(EventLoop *loop,               <span class="comment">// 事件循环</span></span><br><span class="line">               <span class="type">const</span> InetAddress &amp;listenAddr, <span class="comment">// IP+Port</span></span><br><span class="line">               <span class="type">const</span> string &amp;nameArg)</span><br><span class="line">            : _server(loop,listenAddr,nameArg),_loop(loop)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 给服务器注册用户连接的创建和断开回调</span></span><br><span class="line">    _server.<span class="built_in">setConnectionCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onConnection,<span class="keyword">this</span>,_1));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给服务器注册用户读写事件回调</span></span><br><span class="line">    _server.<span class="built_in">setMessageCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onMessage,<span class="keyword">this</span>,_1,_2,_3));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置服务器端的线程数量 1个I/O线程（监听新用户的连接事件）， 3个worker线程</span></span><br><span class="line">    <span class="comment">//不设置的话，就1个线程而已，要处理连接又要处理业务 </span></span><br><span class="line">    _server.<span class="built_in">setThreadNum</span>(<span class="number">4</span>);<span class="comment">//设置4个线程，1个I/O线程，3个worker线程 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _server.<span class="built_in">start</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::onConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//客户端断开连接</span></span><br><span class="line">    <span class="keyword">if</span> (!conn-&gt;<span class="built_in">connected</span>()) </span><br><span class="line">    &#123;</span><br><span class="line">        ChatService::<span class="built_in">instance</span>()-&gt;<span class="built_in">clientCloseException</span>(conn); <span class="comment">//客户端异常关闭 </span></span><br><span class="line">        conn-&gt;<span class="built_in">shutdown</span>();<span class="comment">//相当于这些close(fd)</span></span><br><span class="line">        <span class="comment">//_loop-&gt;quit();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, </span></span></span><br><span class="line"><span class="params"><span class="function">                   Buffer *buffer,              </span></span></span><br><span class="line"><span class="params"><span class="function">                   Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string buf = buffer-&gt;<span class="built_in">retrieveAllAsString</span>();<span class="comment">//收到的数据放到这个字符串中 </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//数据的反序列化</span></span><br><span class="line">    json js = json::<span class="built_in">parse</span>(buf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//达到的目的：完全解耦网络模块的代码和业务模块的代码</span></span><br><span class="line">    <span class="comment">//通过js[&quot;msgid&quot;] 获取=》业务handler处理器（在业务模块事先绑定好的）=》conn  js  time传给你 </span></span><br><span class="line">    <span class="keyword">auto</span> msgHandler = ChatService::<span class="built_in">instance</span>()-&gt;<span class="built_in">getHandler</span>(js[<span class="string">&quot;msgid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());<span class="comment">//转成整型 </span></span><br><span class="line">    <span class="comment">//回调消息绑定好的事件处理器，来执行相应的业务处理，一个ID一个操作 </span></span><br><span class="line">    <span class="built_in">msgHandler</span>(conn, js, time);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在完善一下&#x2F;include&#x2F;server&#x2F;chatservice.hpp</strong></p>
<p>增加异常关闭代码的声明</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span> <span class="comment">//一个消息ID映射一个事件处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line">    <span class="comment">//处理客户端异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储在线用户的通信连接，用户的id， TcpConnectionPtr</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,TcpConnectionPtr&gt; _userConnMap;</span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据操作类对象</span></span><br><span class="line">    UserModel _userModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义互斥锁，保证_userConnMap的线程安全</span></span><br><span class="line">    mutex _connMutex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>在完善一下&#x2F;src&#x2F;server&#x2F;chatservice.cpp</strong></p>
<p>增加异常关闭代码函数的编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取id号</span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码 </span></span><br><span class="line"></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id); <span class="comment">//查找 这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getPassword</span>() == password) <span class="comment">//查出来了，登录成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>) <span class="comment">//该用户已经登录，不允许重复登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;this account is using,input another&quot;</span>;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串            </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//登录成功，记录用户连接信息，当多个用户登录时，都会操作这个_userConnMap</span></span><br><span class="line">            &#123;</span><br><span class="line">                lock_guard&lt;mutex&gt; <span class="built_in">lock</span>(_connMutex);</span><br><span class="line">                _userConnMap.<span class="built_in">insert</span>(&#123;id,conn&#125;);</span><br><span class="line">            &#125;<span class="comment">//加个作用域，出了这个右括号就自动解锁</span></span><br><span class="line"></span><br><span class="line">             <span class="comment">//登录成功，更新用户状态信息 state offline=&gt;online</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">&quot;online&quot;</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user); <span class="comment">//这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">            response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串 </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//该用户不存在，用户存在但是密码错误，登录失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;id or password is invalid&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];  <span class="comment">//获取名字 </span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码</span></span><br><span class="line"></span><br><span class="line">    User user;  <span class="comment">//创建用户对象 </span></span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_userModel.<span class="built_in">insert</span>(user)) <span class="comment">//插入成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册成功</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理客户端异常退出</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    User user;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> it = _userConnMap.<span class="built_in">begin</span>(); it != _userConnMap.<span class="built_in">end</span>();it++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(it-&gt;second == conn)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//从map表删除用户的链接信息</span></span><br><span class="line">                user.<span class="built_in">setId</span>(it-&gt;first);</span><br><span class="line">                _userConnMap.<span class="built_in">erase</span>(it);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新用户的状态信息</span></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        user.<span class="built_in">setState</span>(<span class="string">&quot;offline&quot;</span>);</span><br><span class="line">        _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写完成之后，我们测试一下</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/16-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/16-01(2).png" alt="本地png图片PictureTest.png"></p>
<h2 id="17-点对点聊天业务代码编写和测试"><a href="#17-点对点聊天业务代码编写和测试" class="headerlink" title="17 点对点聊天业务代码编写和测试"></a><strong>17 点对点聊天业务代码编写和测试</strong></h2><p><strong>首先我们修改&#x2F;include&#x2F;public.hpp</strong></p>
<p>增加聊天消息</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PUBLIC_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUBLIC_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">是属于server和client的公共文件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">EnMsgType</span></span><br><span class="line">&#123;</span><br><span class="line">    LOGIN_MSG = <span class="number">1</span>,<span class="comment">//登录消息</span></span><br><span class="line">    LOGIN_MSG_ACK, <span class="comment">//登录回应消息</span></span><br><span class="line">    REG_MSG, <span class="comment">//注册消息</span></span><br><span class="line">    REG_MSG_ACK, <span class="comment">//注册回应消息</span></span><br><span class="line">    ONE_CHAT_MSG, <span class="comment">//聊天消息</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !PUBLIC_H</span></span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;include&#x2F;server&#x2F;chatservice.hpp</strong></p>
<p>增加对处理一对一聊天业务函数的声明</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span> <span class="comment">//一个消息ID映射一个事件处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理一对一聊天业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line">    <span class="comment">//处理客户端异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储在线用户的通信连接，用户的id， TcpConnectionPtr</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,TcpConnectionPtr&gt; _userConnMap;</span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据操作类对象</span></span><br><span class="line">    UserModel _userModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义互斥锁，保证_userConnMap的线程安全</span></span><br><span class="line">    mutex _connMutex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;src&#x2F;server&#x2F;chatservice.cpp</strong></p>
<p>增加对处理一对一聊天业务函数的编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::oneChat,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取id号</span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码 </span></span><br><span class="line"></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id); <span class="comment">//查找 这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getPassword</span>() == password) <span class="comment">//查出来了，登录成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>) <span class="comment">//该用户已经登录，不允许重复登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;this account is using,input another&quot;</span>;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串            </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//登录成功，记录用户连接信息，当多个用户登录时，都会操作这个_userConnMap</span></span><br><span class="line">            &#123;</span><br><span class="line">                lock_guard&lt;mutex&gt; <span class="built_in">lock</span>(_connMutex);</span><br><span class="line">                _userConnMap.<span class="built_in">insert</span>(&#123;id,conn&#125;);</span><br><span class="line">            &#125;<span class="comment">//加个作用域，出了这个右括号就自动解锁</span></span><br><span class="line"></span><br><span class="line">             <span class="comment">//登录成功，更新用户状态信息 state offline=&gt;online</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">&quot;online&quot;</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user); <span class="comment">//这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">            response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串 </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//该用户不存在，用户存在但是密码错误，登录失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;id or password is invalid&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];  <span class="comment">//获取名字 </span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码</span></span><br><span class="line"></span><br><span class="line">    User user;  <span class="comment">//创建用户对象 </span></span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_userModel.<span class="built_in">insert</span>(user)) <span class="comment">//插入成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册成功</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理客户端异常退出</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    User user;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> it = _userConnMap.<span class="built_in">begin</span>(); it != _userConnMap.<span class="built_in">end</span>();it++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(it-&gt;second == conn)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//从map表删除用户的链接信息</span></span><br><span class="line">                user.<span class="built_in">setId</span>(it-&gt;first);</span><br><span class="line">                _userConnMap.<span class="built_in">erase</span>(it);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新用户的状态信息</span></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        user.<span class="built_in">setState</span>(<span class="string">&quot;offline&quot;</span>);</span><br><span class="line">        _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理一对一聊天业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> toid = js[<span class="string">&quot;toid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取对方的id号 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>; <span class="comment">//访问连接信息表，要保证线程安全 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(toid);  <span class="comment">//查找对方id号 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>()) <span class="comment">//找到了</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//toid在线，转发消息  服务器主动推送消息给toid用户</span></span><br><span class="line">            it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写完成之后，我们测试一下</strong></p>
<p><strong>我们先注册一个新用户</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/17-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><strong>注册成功，id号为2</strong></p>
<p><strong>我们打开mysql数据库查看一下</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/17-01(2).png" alt="本地png图片PictureTest.png"></p>
<p><strong>我们登录caiwei用户、zouzeyu用户</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/17-01(3).png" alt="本地png图片PictureTest.png"></p>
<p><strong>我们打开mysql数据库查看一下</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/17-01(4).png" alt="本地png图片PictureTest.png"></p>
<p><strong>我们让zouzeyu给caiwei发送hello!然后caiwei给zouzeyu发送消息OK</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/17-01(5).png" alt="本地png图片PictureTest.png"></p>
<h2 id="18-离线消息业务代码编写和测试"><a href="#18-离线消息业务代码编写和测试" class="headerlink" title="18 离线消息业务代码编写和测试"></a>18 离线消息业务代码编写和测试</h2><p><strong>我们在&#x2F;include&#x2F;server&#x2F;下创建offlinemsgmodel.hpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> OFFLINEMSGEMODEL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OFFLINEMSGEMODEL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//提供离线消息表的操作接口方法</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OfflineMsgModel</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//存储用户的离线消息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(<span class="type">int</span> userid,string msg)</span></span>;</span><br><span class="line">    <span class="comment">//删除用户的离线消息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(<span class="type">int</span> userid)</span></span>;</span><br><span class="line">    <span class="comment">//查询用户的离线消息</span></span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">query</span><span class="params">(<span class="type">int</span> userid)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !OFFLINEMSGEMODEL_H</span></span></span><br></pre></td></tr></table></figure>

<p><strong>我们在&#x2F;src&#x2F;server&#x2F;下创建offlinemsgmodel.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;offlinemsgmodel.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//存储用户的离线消息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OfflineMsgModel::insert</span><span class="params">(<span class="type">int</span> userid,string msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1.组装sql语句</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;insert into offlinemessage(userid,message) values(&#x27;%d&#x27;,&#x27;%s&#x27;)&quot;</span>,</span><br><span class="line">    userid,msg.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    MySQL mysql;<span class="comment">//定义一个mysql对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>()) <span class="comment">//连接成功了 </span></span><br><span class="line">    &#123;</span><br><span class="line">        mysql.<span class="built_in">update</span>(sql);<span class="comment">//更新这个sql语句传进去</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除用户的离线消息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OfflineMsgModel::remove</span><span class="params">(<span class="type">int</span> userid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1.组装sql语句</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;delete from offlinemessage where userid=&#x27;%d&#x27;&quot;</span>,userid);</span><br><span class="line"></span><br><span class="line">    MySQL mysql;<span class="comment">//定义一个mysql对象</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>()) <span class="comment">//连接成功了 </span></span><br><span class="line">    &#123;</span><br><span class="line">        mysql.<span class="built_in">update</span>(sql);<span class="comment">//更新这个sql语句传进去</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询用户的离线消息</span></span><br><span class="line"><span class="function">vector&lt;string&gt; <span class="title">OfflineMsgModel::query</span><span class="params">(<span class="type">int</span> userid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1.组装sql语句</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;select message from offlinemessage where userid=&#x27;%d&#x27;&quot;</span>,userid);</span><br><span class="line"></span><br><span class="line">    MySQL mysql;<span class="comment">//定义一个mysql对象</span></span><br><span class="line">    vector&lt;string&gt; vec;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>()) <span class="comment">//连接成功了 </span></span><br><span class="line">    &#123;</span><br><span class="line">        MYSQL_RES * res = mysql.<span class="built_in">query</span>(sql);<span class="comment">//调用mysql数据库的查询</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(res != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            MYSQL_ROW row = <span class="built_in">mysql_fetch_row</span>(res); <span class="comment">//获取行，用主键查的，查一行</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span>(row != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                vec.<span class="built_in">push_back</span>(row[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">mysql_free_result</span>(res);</span><br><span class="line">            <span class="keyword">return</span> vec;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vec;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;include&#x2F;server&#x2F;下的chatservice.hpp</strong></p>
<p>增加数据操作类对象_offlineMsgModel</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span> <span class="comment">//一个消息ID映射一个事件处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;offlinemsgmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理一对一聊天业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line">    <span class="comment">//处理客户端异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储在线用户的通信连接，用户的id， TcpConnectionPtr</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,TcpConnectionPtr&gt; _userConnMap;</span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据操作类对象</span></span><br><span class="line">    UserModel _userModel;</span><br><span class="line">    OfflineMsgModel _offlineMsgModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义互斥锁，保证_userConnMap的线程安全</span></span><br><span class="line">    mutex _connMutex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;src&#x2F;server&#x2F;chatservice.cpp</strong></p>
<p>增加登录成功之后，查询该用户是否有离线消息</p>
<p>增加聊天一对一业务中不在线把消息存储在offlinemessag中</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ONE_CHAT_MSG,<span class="built_in">bind</span>(&amp;ChatService::oneChat,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取id号</span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码 </span></span><br><span class="line"></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id); <span class="comment">//查找 这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getPassword</span>() == password) <span class="comment">//查出来了，登录成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>) <span class="comment">//该用户已经登录，不允许重复登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;this account is using,input another&quot;</span>;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串            </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//登录成功，记录用户连接信息，当多个用户登录时，都会操作这个_userConnMap</span></span><br><span class="line">            &#123;</span><br><span class="line">                lock_guard&lt;mutex&gt; <span class="built_in">lock</span>(_connMutex);</span><br><span class="line">                _userConnMap.<span class="built_in">insert</span>(&#123;id,conn&#125;);</span><br><span class="line">            &#125;<span class="comment">//加个作用域，出了这个右括号就自动解锁</span></span><br><span class="line"></span><br><span class="line">             <span class="comment">//登录成功，更新用户状态信息 state offline=&gt;online</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">&quot;online&quot;</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user); <span class="comment">//这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">            response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//查询该用户是否有离线消息</span></span><br><span class="line">            vector&lt;string&gt; vec = _offlineMsgModel.<span class="built_in">query</span>(id); <span class="comment">//查询用户ID</span></span><br><span class="line">            <span class="keyword">if</span>(!vec.<span class="built_in">empty</span>()) <span class="comment">//不为空</span></span><br><span class="line">            &#123;</span><br><span class="line">                response[<span class="string">&quot;offlinemsg&quot;</span>] = vec; <span class="comment">//json库可以和容器之间序列化和反序列化 </span></span><br><span class="line">                <span class="comment">//读取该用户的离线消息后，把该用户的所有离线消息删除掉</span></span><br><span class="line">                _offlineMsgModel.<span class="built_in">remove</span>(id);</span><br><span class="line">            &#125;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串  </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//该用户不存在，用户存在但是密码错误，登录失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;id or password is invalid&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];  <span class="comment">//获取名字 </span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码</span></span><br><span class="line"></span><br><span class="line">    User user;  <span class="comment">//创建用户对象 </span></span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_userModel.<span class="built_in">insert</span>(user)) <span class="comment">//插入成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册成功</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理客户端异常退出</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    User user;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> it = _userConnMap.<span class="built_in">begin</span>(); it != _userConnMap.<span class="built_in">end</span>();it++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(it-&gt;second == conn)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//从map表删除用户的链接信息</span></span><br><span class="line">                user.<span class="built_in">setId</span>(it-&gt;first);</span><br><span class="line">                _userConnMap.<span class="built_in">erase</span>(it);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新用户的状态信息</span></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        user.<span class="built_in">setState</span>(<span class="string">&quot;offline&quot;</span>);</span><br><span class="line">        _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理一对一聊天业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> toid = js[<span class="string">&quot;toid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取对方的id号 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>; <span class="comment">//访问连接信息表，要保证线程安全 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(toid);  <span class="comment">//查找对方id号 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>()) <span class="comment">//找到了</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//toid在线，转发消息  服务器主动推送消息给toid用户</span></span><br><span class="line">            it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//toid不在线，存储离线消息</span></span><br><span class="line">    _offlineMsgModel.<span class="built_in">insert</span>(toid,js.<span class="built_in">dump</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>首先我们登录ID为1的用户，向ID为2的用户连发3条消息，ID为2的用户不在线，那么offlinemessage就会存储3条消息</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/18-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/18-01(2).png" alt="本地png图片PictureTest.png"></p>
<p><strong>登录ID为2的用户，收到3条来自ID为1的用户，offlinemessage没有存储数据</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/18-01(3).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/18-01(4).png" alt="本地png图片PictureTest.png"></p>
<h2 id="19-服务器异常退出处理代码编写和测试"><a href="#19-服务器异常退出处理代码编写和测试" class="headerlink" title="19 服务器异常退出处理代码编写和测试"></a>19 服务器异常退出处理代码编写和测试</h2><p>在之前，我完成看客户端异常退出的处理代码，客户端异常退出是因为它没有发出json字符串，是通过连接异常断开进行用户的connection的删除和用户表状态的</p>
<p>更改。但是服务器异常退出了，user表的用户的状态还是online，这个问题还没有解决。因为我们Ctrl C强制退出服务器的时候，服务器根本没有机会去数据库里</p>
<p>更改用户的状态信息。</p>
<p><strong>我们完善&#x2F;src&#x2F;server&#x2F;main.cpp</strong></p>
<p>增加处理服务器ctrl+c结束后，进行重置user的状态信息</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatserver.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理服务器ctrl+c结束后，进行重置user的状态信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">resetHandler</span><span class="params">(<span class="type">int</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ChatService::<span class="built_in">instance</span>()-&gt;<span class="built_in">reset</span>(); <span class="comment">//调用重置 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">signal</span>(SIGINT,resetHandler);</span><br><span class="line"></span><br><span class="line">    EventLoop loop;  <span class="comment">//相当于像是创建了epoll</span></span><br><span class="line">    <span class="function">InetAddress <span class="title">addr</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">6000</span>)</span></span>; <span class="comment">//IP地址，端口号</span></span><br><span class="line">    <span class="function">ChatServer <span class="title">server</span><span class="params">(&amp;loop,addr,<span class="string">&quot;ChatServer&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    server.<span class="built_in">start</span>();  <span class="comment">//listenfd通过 epoll_ctl 添加到 epoll </span></span><br><span class="line">    loop.<span class="built_in">loop</span>();    <span class="comment">//相当于epoll_wait，以阻塞方式等待新用户连接，已连接用户的读写事件等</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;include&#x2F;server&#x2F;chatservice.hpp</strong></p>
<p>增加对处理服务器异常退出函数的声明</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span> <span class="comment">//一个消息ID映射一个事件处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;offlinemsgmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理一对一聊天业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line">    <span class="comment">//处理客户端异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span>;</span><br><span class="line">    <span class="comment">//处理服务器异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储在线用户的通信连接，用户的id， TcpConnectionPtr</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,TcpConnectionPtr&gt; _userConnMap;</span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据操作类对象</span></span><br><span class="line">    UserModel _userModel;</span><br><span class="line">    OfflineMsgModel _offlineMsgModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义互斥锁，保证_userConnMap的线程安全</span></span><br><span class="line">    mutex _connMutex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;src&#x2F;server&#x2F;chatservice.cpp</strong></p>
<p>增加对处理服务器异常退出函数的编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ONE_CHAT_MSG,<span class="built_in">bind</span>(&amp;ChatService::oneChat,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务器异常，业务重置方法</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//把online状态的用户，设置成offline</span></span><br><span class="line">    _userModel.<span class="built_in">resetState</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取id号</span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码 </span></span><br><span class="line"></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id); <span class="comment">//查找 这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getPassword</span>() == password) <span class="comment">//查出来了，登录成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>) <span class="comment">//该用户已经登录，不允许重复登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;this account is using,input another&quot;</span>;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串            </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//登录成功，记录用户连接信息，当多个用户登录时，都会操作这个_userConnMap</span></span><br><span class="line">            &#123;</span><br><span class="line">                lock_guard&lt;mutex&gt; <span class="built_in">lock</span>(_connMutex);</span><br><span class="line">                _userConnMap.<span class="built_in">insert</span>(&#123;id,conn&#125;);</span><br><span class="line">            &#125;<span class="comment">//加个作用域，出了这个右括号就自动解锁</span></span><br><span class="line"></span><br><span class="line">             <span class="comment">//登录成功，更新用户状态信息 state offline=&gt;online</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">&quot;online&quot;</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user); <span class="comment">//这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">            response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//查询该用户是否有离线消息</span></span><br><span class="line">            vector&lt;string&gt; vec = _offlineMsgModel.<span class="built_in">query</span>(id); <span class="comment">//查询用户ID</span></span><br><span class="line">            <span class="keyword">if</span>(!vec.<span class="built_in">empty</span>()) <span class="comment">//不为空</span></span><br><span class="line">            &#123;</span><br><span class="line">                response[<span class="string">&quot;offlinemsg&quot;</span>] = vec; <span class="comment">//json库可以和容器之间序列化和反序列化 </span></span><br><span class="line">                <span class="comment">//读取该用户的离线消息后，把该用户的所有离线消息删除掉</span></span><br><span class="line">                _offlineMsgModel.<span class="built_in">remove</span>(id);</span><br><span class="line">            &#125;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串  </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//该用户不存在，用户存在但是密码错误，登录失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;id or password is invalid&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];  <span class="comment">//获取名字 </span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码</span></span><br><span class="line"></span><br><span class="line">    User user;  <span class="comment">//创建用户对象 </span></span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_userModel.<span class="built_in">insert</span>(user)) <span class="comment">//插入成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册成功</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理客户端异常退出</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    User user;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> it = _userConnMap.<span class="built_in">begin</span>(); it != _userConnMap.<span class="built_in">end</span>();it++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(it-&gt;second == conn)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//从map表删除用户的链接信息</span></span><br><span class="line">                user.<span class="built_in">setId</span>(it-&gt;first);</span><br><span class="line">                _userConnMap.<span class="built_in">erase</span>(it);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新用户的状态信息</span></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        user.<span class="built_in">setState</span>(<span class="string">&quot;offline&quot;</span>);</span><br><span class="line">        _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理一对一聊天业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> toid = js[<span class="string">&quot;toid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取对方的id号 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>; <span class="comment">//访问连接信息表，要保证线程安全 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(toid);  <span class="comment">//查找对方id号 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>()) <span class="comment">//找到了</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//toid在线，转发消息  服务器主动推送消息给toid用户</span></span><br><span class="line">            it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//toid不在线，存储离线消息</span></span><br><span class="line">    _offlineMsgModel.<span class="built_in">insert</span>(toid,js.<span class="built_in">dump</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;include&#x2F;server&#x2F;usermodel.hpp</strong></p>
<p>增加对函数重置用户信息的函数声明</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> USERMODEL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USERMODEL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;db.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//User表的数据操作类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserModel</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//User表的增加方法</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">insert</span><span class="params">(User &amp;user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据用户号码查询用户信息</span></span><br><span class="line">    <span class="function">User <span class="title">query</span><span class="params">(<span class="type">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新用户的信息</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">updateState</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重置用户信息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">resetState</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;src&#x2F;server&#x2F;usermodel.cpp</strong></p>
<p>增加对函数重置用户信息的函数编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//User表的增加方法</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UserModel::insert</span><span class="params">(User &amp;user)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1.组装sql语句</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;insert into user(name,password,state) values(&#x27;%s&#x27;,&#x27;%s&#x27;,&#x27;%s&#x27;)&quot;</span>,</span><br><span class="line">    user.<span class="built_in">getName</span>().<span class="built_in">c_str</span>(), user.<span class="built_in">getPassword</span>().<span class="built_in">c_str</span>(), user.<span class="built_in">getState</span>().<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    MySQL mysql;<span class="comment">//定义一个mysql对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())<span class="comment">//连接成功了 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mysql.<span class="built_in">update</span>(sql))<span class="comment">//更新这个sql语句传进去 </span></span><br><span class="line">        &#123;</span><br><span class="line">              <span class="comment">//获取插入成功的用户数据生成的主键id</span></span><br><span class="line">            user.<span class="built_in">setId</span>(<span class="built_in">mysql_insert_id</span>(mysql.<span class="built_in">getConnection</span>()));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据用户号码查询用户信息</span></span><br><span class="line"><span class="function">User <span class="title">UserModel::query</span><span class="params">(<span class="type">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="comment">//1.组装sql语句</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;select * from user where id = &#x27;%d&#x27;&quot;</span>,id);</span><br><span class="line"></span><br><span class="line">    MySQL mysql;<span class="comment">//定义一个mysql对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())<span class="comment">//连接成功了 </span></span><br><span class="line">    &#123;</span><br><span class="line">        MYSQL_RES * res = mysql.<span class="built_in">query</span>(sql); <span class="comment">//调用mysql数据库的查询 </span></span><br><span class="line">        <span class="keyword">if</span>(res != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            MYSQL_ROW row = <span class="built_in">mysql_fetch_row</span>(res); <span class="comment">//获取行，用主键查的，查一行</span></span><br><span class="line">            <span class="keyword">if</span>(row != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                User user;</span><br><span class="line">                user.<span class="built_in">setId</span>(<span class="built_in">atoi</span>(row[<span class="number">0</span>]));</span><br><span class="line">                user.<span class="built_in">setName</span>(row[<span class="number">1</span>]);</span><br><span class="line">                user.<span class="built_in">setPassword</span>(row[<span class="number">2</span>]);</span><br><span class="line">                user.<span class="built_in">setState</span>(row[<span class="number">3</span>]);</span><br><span class="line">                <span class="built_in">mysql_free_result</span>(res);  <span class="comment">//释放资源 </span></span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">User</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UserModel::updateState</span><span class="params">(User user)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="comment">//1.组装sql语句</span></span><br><span class="line">    <span class="type">int</span> id = user.<span class="built_in">getId</span>();</span><br><span class="line">    string state = user.<span class="built_in">getState</span>();</span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;update user set state = &#x27;%s&#x27; where id = &#x27;%d&#x27;&quot;</span>,state.<span class="built_in">c_str</span>(),id);</span><br><span class="line"></span><br><span class="line">    MySQL mysql;<span class="comment">//定义一个mysql对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())<span class="comment">//连接成功了 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mysql.<span class="built_in">update</span>(sql))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserModel::resetState</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="comment">//1.组装sql语句</span></span><br><span class="line">    string sql = <span class="string">&quot;update user set state = &#x27;offline&#x27;;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    MySQL mysql; <span class="comment">//定义mysql对象 </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>()) <span class="comment">//连接成功</span></span><br><span class="line">    &#123;</span><br><span class="line">        mysql.<span class="built_in">update</span>(sql); <span class="comment">//更新</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/19-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/19-01(2).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/19-01(3).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/19-01(4).png" alt="本地png图片PictureTest.png"></p>
<h2 id="20-添加好友业务代码编写和测试"><a href="#20-添加好友业务代码编写和测试" class="headerlink" title="20 添加好友业务代码编写和测试"></a>20 添加好友业务代码编写和测试</h2><p><strong>我们完善public.hpp</strong></p>
<p>添加对添加好友消息</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PUBLIC_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUBLIC_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">是属于server和client的公共文件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">EnMsgType</span></span><br><span class="line">&#123;</span><br><span class="line">    LOGIN_MSG = <span class="number">1</span>,<span class="comment">//登录消息</span></span><br><span class="line">    LOGIN_MSG_ACK, <span class="comment">//登录回应消息</span></span><br><span class="line">    REG_MSG, <span class="comment">//注册消息</span></span><br><span class="line">    REG_MSG_ACK, <span class="comment">//注册回应消息</span></span><br><span class="line">    ONE_CHAT_MSG, <span class="comment">//聊天消息</span></span><br><span class="line">    ADD_FRIEND_MSG,<span class="comment">//添加好友消息</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !PUBLIC_H</span></span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;include&#x2F;server&#x2F;chatservice.hpp</strong></p>
<p>增加头文件#include “friendmodel.hpp”的声明</p>
<p>增加对添加好友业务函数的声明</p>
<p>增加数据类操作对象</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span> <span class="comment">//一个消息ID映射一个事件处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;offlinemsgmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;friendmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">//处理一对一聊天业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line">    <span class="comment">//处理客户端异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span>;</span><br><span class="line">    <span class="comment">//处理服务器异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//添加好友业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addFriend</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储在线用户的通信连接，用户的id， TcpConnectionPtr</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,TcpConnectionPtr&gt; _userConnMap;</span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据操作类对象</span></span><br><span class="line">    UserModel _userModel;</span><br><span class="line">    OfflineMsgModel _offlineMsgModel;</span><br><span class="line">    FriendModel _friendModel;</span><br><span class="line">    <span class="comment">//定义互斥锁，保证_userConnMap的线程安全</span></span><br><span class="line">    mutex _connMutex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善&#x2F;src&#x2F;server&#x2F;chatservice.cpp</strong></p>
<p>增加对添加好友业务函数的编写</p>
<p>增加对登录成功后查询是否有好友</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ONE_CHAT_MSG,<span class="built_in">bind</span>(&amp;ChatService::oneChat,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ADD_FRIEND_MSG,<span class="built_in">bind</span>(&amp;ChatService::addFriend,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务器异常，业务重置方法</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//把online状态的用户，设置成offline</span></span><br><span class="line">    _userModel.<span class="built_in">resetState</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取id号</span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码 </span></span><br><span class="line"></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id); <span class="comment">//查找 这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getPassword</span>() == password) <span class="comment">//查出来了，登录成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>) <span class="comment">//该用户已经登录，不允许重复登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;this account is using,input another&quot;</span>;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串            </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//登录成功，记录用户连接信息，当多个用户登录时，都会操作这个_userConnMap</span></span><br><span class="line">            &#123;</span><br><span class="line">                lock_guard&lt;mutex&gt; <span class="built_in">lock</span>(_connMutex);</span><br><span class="line">                _userConnMap.<span class="built_in">insert</span>(&#123;id,conn&#125;);</span><br><span class="line">            &#125;<span class="comment">//加个作用域，出了这个右括号就自动解锁</span></span><br><span class="line"></span><br><span class="line">             <span class="comment">//登录成功，更新用户状态信息 state offline=&gt;online</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">&quot;online&quot;</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user); <span class="comment">//这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">            response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//查询该用户是否有离线消息</span></span><br><span class="line">            vector&lt;string&gt; vec = _offlineMsgModel.<span class="built_in">query</span>(id); <span class="comment">//查询用户ID</span></span><br><span class="line">            <span class="keyword">if</span>(!vec.<span class="built_in">empty</span>()) <span class="comment">//不为空</span></span><br><span class="line">            &#123;</span><br><span class="line">                response[<span class="string">&quot;offlinemsg&quot;</span>] = vec; <span class="comment">//json库可以和容器之间序列化和反序列化 </span></span><br><span class="line">                <span class="comment">//读取该用户的离线消息后，把该用户的所有离线消息删除掉</span></span><br><span class="line">                _offlineMsgModel.<span class="built_in">remove</span>(id);</span><br><span class="line">            &#125;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串  </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//该用户不存在，用户存在但是密码错误，登录失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;id or password is invalid&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];  <span class="comment">//获取名字 </span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码</span></span><br><span class="line"></span><br><span class="line">    User user;  <span class="comment">//创建用户对象 </span></span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_userModel.<span class="built_in">insert</span>(user)) <span class="comment">//插入成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册成功</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理客户端异常退出</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    User user;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> it = _userConnMap.<span class="built_in">begin</span>(); it != _userConnMap.<span class="built_in">end</span>();it++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(it-&gt;second == conn)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//从map表删除用户的链接信息</span></span><br><span class="line">                user.<span class="built_in">setId</span>(it-&gt;first);</span><br><span class="line">                _userConnMap.<span class="built_in">erase</span>(it);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新用户的状态信息</span></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        user.<span class="built_in">setState</span>(<span class="string">&quot;offline&quot;</span>);</span><br><span class="line">        _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理一对一聊天业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> toid = js[<span class="string">&quot;toid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取对方的id号 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>; <span class="comment">//访问连接信息表，要保证线程安全 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(toid);  <span class="comment">//查找对方id号 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>()) <span class="comment">//找到了</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//toid在线，转发消息  服务器主动推送消息给toid用户</span></span><br><span class="line">            it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//toid不在线，存储离线消息</span></span><br><span class="line">    _offlineMsgModel.<span class="built_in">insert</span>(toid,js.<span class="built_in">dump</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::addFriend</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;userid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    <span class="type">int</span> friendid = js[<span class="string">&quot;friendid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取对方的id号 </span></span><br><span class="line"></span><br><span class="line">    _friendModel.<span class="built_in">insert</span>(userid,friendid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>我们在include的server下创建文件：friendmodel.hpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FRIENDMODEL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FRIENDMODEL_#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;db.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FriendModel</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//添加好友关系</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(<span class="type">int</span> userId,<span class="type">int</span> friendId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回用户好友列表</span></span><br><span class="line">    <span class="function">vector&lt;User&gt; <span class="title">query</span><span class="params">(<span class="type">int</span> userId)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !FRIENDMODEL_H</span></span></span><br></pre></td></tr></table></figure>

<p><strong>我们在src的server下创建文件：friendmodel.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;friendmodel.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//添加好友关系</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FriendModel::insert</span><span class="params">(<span class="type">int</span> userId,<span class="type">int</span> friendId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="comment">//1.组装sql语句</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;insert into friend values(userid,friendid) values(&#x27;%d&#x27;,&#x27;%d&#x27;);&quot;</span>,</span><br><span class="line">    userId,friendId);</span><br><span class="line"></span><br><span class="line">    MySQL mysql;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        mysql.<span class="built_in">update</span>(sql);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//返回用户好友列表</span></span><br><span class="line"><span class="function">vector&lt;User&gt; <span class="title">FriendModel::query</span><span class="params">(<span class="type">int</span> userId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="comment">//1.组装sql语句</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;select a.id,a.name,a.state from user a inner join friend b on b.friendid = a.id where b.userid = &#x27;%d&#x27;&quot;</span>,</span><br><span class="line">    userId);</span><br><span class="line"></span><br><span class="line">    MySQL mysql;</span><br><span class="line">    vector&lt;User&gt; vec;</span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        MYSQL_RES * res = mysql.<span class="built_in">query</span>(sql);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(res != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            MYSQL_ROW row;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>((row = <span class="built_in">mysql_fetch_row</span>(res)) != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                User user;</span><br><span class="line">                user.<span class="built_in">setId</span>(<span class="built_in">atoi</span>(row[<span class="number">0</span>]));</span><br><span class="line">                user.<span class="built_in">setName</span>(row[<span class="number">1</span>]);</span><br><span class="line">                user.<span class="built_in">setState</span>(row[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">                vec.<span class="built_in">push_back</span>(user);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">mysql_free_result</span>(res);  <span class="comment">//释放资源 </span></span><br><span class="line">            <span class="keyword">return</span> vec;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vec; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试一下</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/20-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/20-01(2).png" alt="本地png图片PictureTest.png"></p>
<p><strong>然后现在用户1先退出，然后重新登录</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/20-01(3).png" alt="本地png图片PictureTest.png"></p>
<h3 id="20-1-问题"><a href="#20-1-问题" class="headerlink" title="20.1 问题"></a>20.1 问题</h3><p>**问题一:**添加新文件之后，出现未定义的情况</p>
<p>**解决方法:**重新cmake一下</p>
<p><strong>找到的bug：</strong>不是自己id号也可以给别人发消息</p>
<p>解决方法：在一对一聊天业务增加判断只有自己的ID的号才可以去发送消息，不是自己ID号返回只有本ID号才可以发消息给别人或者自己”</p>
<h2 id="21-群组业务代码编写"><a href="#21-群组业务代码编写" class="headerlink" title="21 群组业务代码编写"></a>21 群组业务代码编写</h2><p>我们在&#x2F;include&#x2F;server&#x2F;下创建新文件夹model，将数据层的头文件移动进去，在&#x2F;src&#x2F;server下创建新文件夹model，见数据层的文件移动进去</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/21-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/21-01(2).png" alt="本地png图片PictureTest.png"></p>
<p><strong>在&#x2F;include&#x2F;server&#x2F;model下创建group.hpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> GROUP_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GROUP_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;groupuser.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Allgroup表的ORM类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Group</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Group</span>(<span class="type">int</span> id = <span class="number">-1</span>,string name = <span class="string">&quot;&quot;</span>,string desc = <span class="string">&quot;&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;id = id;</span><br><span class="line">        <span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">        <span class="keyword">this</span>-&gt;desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setId</span><span class="params">(<span class="type">int</span> id)</span> </span>&#123;<span class="keyword">this</span>-&gt;id = id; &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setName</span><span class="params">(string name)</span> </span>&#123;<span class="keyword">this</span>-&gt;name = name;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setDesc</span><span class="params">(string desc)</span> </span>&#123;<span class="keyword">this</span>-&gt;desc = desc;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;id;&#125;</span><br><span class="line">    <span class="function">string <span class="title">getName</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;name;&#125;</span><br><span class="line">    <span class="function">string <span class="title">getDesc</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;desc;&#125;   </span><br><span class="line"></span><br><span class="line">    <span class="function">vector&lt;GroupUser&gt; &amp;<span class="title">getUsers</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;users;&#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    string name;</span><br><span class="line">    string desc;   <span class="comment">//组的功能描述</span></span><br><span class="line">    vector&lt;GroupUser&gt; users;  <span class="comment">//组的成员</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !GROUP_H</span></span></span><br></pre></td></tr></table></figure>

<p><strong>在&#x2F;include&#x2F;server&#x2F;model下创建groupuser.hpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> GROUPUSER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GROUPUSER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GroupUser</span> : <span class="keyword">public</span> User</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setRole</span><span class="params">(string role)</span> </span>&#123;<span class="keyword">this</span>-&gt;grouprole = role;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">string <span class="title">getRole</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>-&gt;grouprole;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    string grouprole;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><strong>在&#x2F;include&#x2F;server&#x2F;model下创建groupmodel.hpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> GROUPMODEL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GROUPMODEL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;groupuser.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gruop.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;db.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GroupModel</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//创建群组</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">createGroup</span><span class="params">(Group &amp; group)</span></span>;</span><br><span class="line">    <span class="comment">//加入群组</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addGroup</span><span class="params">(<span class="type">int</span> userid,<span class="type">int</span> groupid,string role)</span></span>;</span><br><span class="line">    <span class="comment">//查询用户所在群组信息  在客户端呈现</span></span><br><span class="line">    <span class="function">vector&lt;Group&gt; <span class="title">queryGroups</span><span class="params">(<span class="type">int</span> userid)</span></span>;</span><br><span class="line">    <span class="comment">//群聊。根据指定的groupid查询群组用户id列表，</span></span><br><span class="line">    <span class="comment">//除userid自己，主要用户群聊业务给群组其它成员群发消息</span></span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">queryGroupUsers</span><span class="params">(<span class="type">int</span> userid,<span class="type">int</span> groupid)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><strong>在&#x2F;src&#x2F;server&#x2F;model下创建groupmodel.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;groupmodel.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建群组</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">GroupModel::createGroup</span><span class="params">(Group &amp;group)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;insert into group(groupname,groupdesc) values(&#x27;%s&#x27;,&#x27;%s&#x27;)&quot;</span>,</span><br><span class="line">    group.<span class="built_in">getName</span>().<span class="built_in">c_str</span>(),group.<span class="built_in">getDesc</span>().<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    MySQL mysql;</span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mysql.<span class="built_in">update</span>(sql))</span><br><span class="line">        &#123;</span><br><span class="line">            group.<span class="built_in">setId</span>(<span class="built_in">mysql_insert_id</span>(mysql.<span class="built_in">getConnection</span>()));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//加入群组</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">GroupModel::addGroup</span><span class="params">(<span class="type">int</span> userid,<span class="type">int</span> groupid,string role)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;insert into groupuser(groupid,userid,grouprole)\ </span></span><br><span class="line"><span class="string">    values(&#x27;%d&#x27;,&#x27;%d&#x27;,&#x27;%s&#x27;)&quot;</span>,groupid,userid,role);</span><br><span class="line"></span><br><span class="line">    MySQL mysql;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        mysql.<span class="built_in">update</span>(sql);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//查询用户所在群组信息  在客户端呈现 </span></span><br><span class="line"><span class="function">vector&lt;Group&gt; <span class="title">GroupModel::queryGroups</span><span class="params">(<span class="type">int</span> userid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    1. 先根据userid在groupuser表中查询出该用户所属的群组信息</span></span><br><span class="line"><span class="comment">    2. 在根据群组信息，查询属于该群组的所有用户的userid，并且和user表进行多表联合查询，查出用户的详细信息</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(sql,<span class="string">&quot;select a.id,a.groupname,a.groupdesc from allgroup a inner\</span></span><br><span class="line"><span class="string">    join groupuser b on a.id = b.groupid where b.userid = &#x27;%d&#x27;&quot;</span>,userid);</span><br><span class="line">    <span class="comment">//把指定用户的所在的群组信息全部描述出来</span></span><br><span class="line">    MySQL mysql;</span><br><span class="line"></span><br><span class="line">    vector&lt;Group&gt; groupVec;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        MYSQL_RES * res = mysql.<span class="built_in">query</span>(sql);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(res != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            MYSQL_ROW row;</span><br><span class="line">            <span class="comment">//查出userid所有的群组的信息</span></span><br><span class="line">            <span class="keyword">while</span>((row = <span class="built_in">mysql_fetch_row</span>(res)) != <span class="literal">nullptr</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                Group group;</span><br><span class="line"></span><br><span class="line">                group.<span class="built_in">setId</span>(<span class="built_in">atoi</span>(row[<span class="number">0</span>]));</span><br><span class="line">                group.<span class="built_in">setName</span>(row[<span class="number">1</span>]);</span><br><span class="line">                group.<span class="built_in">setDesc</span>(row[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">                groupVec.<span class="built_in">push_back</span>(group);  </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">mysql_free_result</span>(res); <span class="comment">//释放资源 </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询群组的用户信息</span></span><br><span class="line">    <span class="keyword">for</span>(Group &amp;group : groupVec)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sprintf</span>(sql,<span class="string">&quot;select a.id,a.name,a.state,b.grouprole from user \</span></span><br><span class="line"><span class="string">        a inner join groupuser b on a.id = b.userid where b.groupid\</span></span><br><span class="line"><span class="string">        = &#x27;%d&#x27;&quot;</span>,group.<span class="built_in">getId</span>());</span><br><span class="line"></span><br><span class="line">        MySQL mysql;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            MYSQL_RES *res = mysql.<span class="built_in">query</span>(sql);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(res != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                MYSQL_ROW row;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>((row = <span class="built_in">mysql_fetch_row</span>(res)) != <span class="literal">nullptr</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    GroupUser user;</span><br><span class="line">                    user.<span class="built_in">setId</span>(<span class="built_in">atoi</span>(row[<span class="number">0</span>]));</span><br><span class="line">                    user.<span class="built_in">setName</span>(row[<span class="number">1</span>]);</span><br><span class="line">                    user.<span class="built_in">setState</span>(row[<span class="number">2</span>]);</span><br><span class="line">                    user.<span class="built_in">setRole</span>(row[<span class="number">3</span>]);</span><br><span class="line">                    group.<span class="built_in">getUsers</span>().<span class="built_in">push_back</span>(user);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">mysql_free_result</span>(res); <span class="comment">//释放资源</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> groupVec;<span class="comment">//这个东西存着用户的所有群组和所有群组里的用户信息 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据指定的groupid查询群组用户id列表</span></span><br><span class="line"><span class="comment">//除userid自己，主要用户群聊业务给群组其它成员群发消息</span></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">GroupModel::queryGroupUsers</span><span class="params">(<span class="type">int</span> userid,<span class="type">int</span> groupid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(sql, <span class="string">&quot;select userid from groupuser \</span></span><br><span class="line"><span class="string">    where groupid = %d and userid != %d&quot;</span>, groupid, userid);</span><br><span class="line"></span><br><span class="line">    MySQL mysql;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; idVec;</span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        MYSQL_RES *res = mysql.<span class="built_in">query</span>(sql);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(res != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            MYSQL_ROW row;</span><br><span class="line">            <span class="keyword">while</span>((row = <span class="built_in">mysql_fetch_row</span>(res)) != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                idVec.<span class="built_in">push_back</span>(<span class="built_in">atoi</span>(row[<span class="number">0</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">mysql_free_result</span>(res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> idVec;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>完善&#x2F;include&#x2F;public.hpp</strong></p>
<p>增加创建群组、加入群组、群聊天枚举</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PUBLIC_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUBLIC_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">是属于server和client的公共文件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">EnMsgType</span></span><br><span class="line">&#123;</span><br><span class="line">    LOGIN_MSG = <span class="number">1</span>,<span class="comment">//登录消息</span></span><br><span class="line">    LOGIN_MSG_ACK, <span class="comment">//登录回应消息</span></span><br><span class="line">    REG_MSG, <span class="comment">//注册消息</span></span><br><span class="line">    REG_MSG_ACK, <span class="comment">//注册回应消息</span></span><br><span class="line">    ONE_CHAT_MSG, <span class="comment">//聊天消息</span></span><br><span class="line">    ADD_FRIEND_MSG,<span class="comment">//添加好友消息</span></span><br><span class="line"></span><br><span class="line">    CREATE_GROUP_MSG,<span class="comment">//创建群组</span></span><br><span class="line">    ADD_GROUP_MSG,<span class="comment">//加入群组</span></span><br><span class="line">    GROUP_CHAT_MSG,<span class="comment">//群聊天</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !PUBLIC_H</span></span></span><br></pre></td></tr></table></figure>

<p><strong>完善&#x2F;include&#x2F;server&#x2F;chatservice.hpp</strong></p>
<p>增加对创建群组业务、加入群组业务、群组聊天业务的声明、数据操作类对象</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span> <span class="comment">//一个消息ID映射一个事件处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;offlinemsgmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;friendmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;groupmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理一对一聊天业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理客户端异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理服务器异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加好友业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addFriend</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建群组业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">createGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加入群组业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//群组聊天业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">groupChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储在线用户的通信连接，用户的id， TcpConnectionPtr</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,TcpConnectionPtr&gt; _userConnMap;</span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据操作类对象</span></span><br><span class="line">    UserModel _userModel;</span><br><span class="line">    OfflineMsgModel _offlineMsgModel;</span><br><span class="line">    FriendModel _friendModel;</span><br><span class="line">    GroupModel _groupModel;</span><br><span class="line">    <span class="comment">//定义互斥锁，保证_userConnMap的线程安全</span></span><br><span class="line">    mutex _connMutex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>完善&#x2F;src&#x2F;server&#x2F;chatservice.hpp</strong></p>
<p>增加对创建群组业务、加入群组业务、群组聊天业务的编写</p>
<p>增加登录成功后查询该用户的群组信息并返回</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ONE_CHAT_MSG,<span class="built_in">bind</span>(&amp;ChatService::oneChat,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ADD_FRIEND_MSG,<span class="built_in">bind</span>(&amp;ChatService::addFriend,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;CREATE_GROUP_MSG,<span class="built_in">bind</span>(&amp;ChatService::createGroup,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ADD_GROUP_MSG,<span class="built_in">bind</span>(&amp;ChatService::addGroup,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;GROUP_CHAT_MSG,<span class="built_in">bind</span>(&amp;ChatService::groupChat,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务器异常，业务重置方法</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//把online状态的用户，设置成offline</span></span><br><span class="line">    _userModel.<span class="built_in">resetState</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取id号</span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码 </span></span><br><span class="line"></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id); <span class="comment">//查找 这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getPassword</span>() == password) <span class="comment">//查出来了，登录成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>) <span class="comment">//该用户已经登录，不允许重复登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;this account is using,input another&quot;</span>;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串            </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//登录成功，记录用户连接信息，当多个用户登录时，都会操作这个_userConnMap</span></span><br><span class="line">            &#123;</span><br><span class="line">                lock_guard&lt;mutex&gt; <span class="built_in">lock</span>(_connMutex);</span><br><span class="line">                _userConnMap.<span class="built_in">insert</span>(&#123;id,conn&#125;);</span><br><span class="line">            &#125;<span class="comment">//加个作用域，出了这个右括号就自动解锁</span></span><br><span class="line"></span><br><span class="line">             <span class="comment">//登录成功，更新用户状态信息 state offline=&gt;online</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">&quot;online&quot;</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user); <span class="comment">//这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">            response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//查询该用户是否有离线消息</span></span><br><span class="line">            vector&lt;string&gt; vec = _offlineMsgModel.<span class="built_in">query</span>(id); <span class="comment">//查询用户ID</span></span><br><span class="line">            <span class="keyword">if</span>(!vec.<span class="built_in">empty</span>()) <span class="comment">//不为空</span></span><br><span class="line">            &#123;</span><br><span class="line">                response[<span class="string">&quot;offlinemsg&quot;</span>] = vec; <span class="comment">//json库可以和容器之间序列化和反序列化 </span></span><br><span class="line">                <span class="comment">//读取该用户的离线消息后，把该用户的所有离线消息删除掉</span></span><br><span class="line">                _offlineMsgModel.<span class="built_in">remove</span>(id);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//查询该用户的好友信息并返回</span></span><br><span class="line">            vector&lt;User&gt; userVec = _friendModel.<span class="built_in">query</span>(id);</span><br><span class="line">            <span class="keyword">if</span>(!userVec.<span class="built_in">empty</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                vector&lt;string&gt; vec2;</span><br><span class="line">                <span class="keyword">for</span>(User &amp;user:userVec)</span><br><span class="line">                &#123;</span><br><span class="line">                    json js;</span><br><span class="line">                    js[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">                    js[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">                    js[<span class="string">&quot;state&quot;</span>] = user.<span class="built_in">getState</span>();</span><br><span class="line">                    vec2.<span class="built_in">push_back</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">                &#125;</span><br><span class="line">                response[<span class="string">&quot;friends&quot;</span>] = vec2;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//查询该用户的群组信息并返回</span></span><br><span class="line">            vector&lt;Group&gt; groupuserVec = _groupModel.<span class="built_in">queryGroups</span>(id);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!groupuserVec.<span class="built_in">empty</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                vector&lt;string&gt; groupV;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(Group &amp;group:groupuserVec)</span><br><span class="line">                &#123;</span><br><span class="line">                    json grpjson;</span><br><span class="line">                    grpjson[<span class="string">&quot;id&quot;</span>] = group.<span class="built_in">getId</span>();</span><br><span class="line">                    grpjson[<span class="string">&quot;groupname&quot;</span>] = group.<span class="built_in">getName</span>();</span><br><span class="line">                    grpjson[<span class="string">&quot;groupdesc&quot;</span>] = group.<span class="built_in">getDesc</span>();</span><br><span class="line"></span><br><span class="line">                    vector&lt;string&gt; userV;</span><br><span class="line">                    <span class="keyword">for</span>(GroupUser &amp;user:group.<span class="built_in">getUsers</span>())</span><br><span class="line">                    &#123;</span><br><span class="line">                        json js;</span><br><span class="line">                        js[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">                        js[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">                        js[<span class="string">&quot;state&quot;</span>] = user.<span class="built_in">getState</span>();</span><br><span class="line">                        js[<span class="string">&quot;role&quot;</span>] = user.<span class="built_in">getRole</span>();</span><br><span class="line">                        userV.<span class="built_in">push_back</span>(js);</span><br><span class="line">                    &#125;</span><br><span class="line">                    grpjson[<span class="string">&quot;users&quot;</span>] = userV;</span><br><span class="line">                    groupV.<span class="built_in">push_back</span>(grpjson);</span><br><span class="line">                &#125;</span><br><span class="line">                response[<span class="string">&quot;groups&quot;</span>] = groupV;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串 </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//该用户不存在，用户存在但是密码错误，登录失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;id or password is invalid&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];  <span class="comment">//获取名字 </span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码</span></span><br><span class="line"></span><br><span class="line">    User user;  <span class="comment">//创建用户对象 </span></span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_userModel.<span class="built_in">insert</span>(user)) <span class="comment">//插入成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册成功</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理客户端异常退出</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    User user;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> it = _userConnMap.<span class="built_in">begin</span>(); it != _userConnMap.<span class="built_in">end</span>();it++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(it-&gt;second == conn)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//从map表删除用户的链接信息</span></span><br><span class="line">                user.<span class="built_in">setId</span>(it-&gt;first);</span><br><span class="line">                _userConnMap.<span class="built_in">erase</span>(it);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新用户的状态信息</span></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        user.<span class="built_in">setState</span>(<span class="string">&quot;offline&quot;</span>);</span><br><span class="line">        _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理一对一聊天业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取本人的id号</span></span><br><span class="line">    <span class="type">int</span> toid = js[<span class="string">&quot;toid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取对方的id号</span></span><br><span class="line">    </span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只有自己的ID的号才可以去发送消息</span></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>; <span class="comment">//访问连接信息表，要保证线程安全 </span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(toid);  <span class="comment">//查找对方id号 </span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>()) <span class="comment">//找到了</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//toid在线，转发消息  服务器主动推送消息给toid用户</span></span><br><span class="line">                it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//toid不在线，存储离线消息</span></span><br><span class="line">        _offlineMsgModel.<span class="built_in">insert</span>(toid,js.<span class="built_in">dump</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;只有本ID号才可以发消息给别人或者自己&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串        </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加好友业务 格式： msgid id friendid</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::addFriend</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//当前用户的id </span></span><br><span class="line">    <span class="type">int</span> friendid = js[<span class="string">&quot;friendid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取对方的id号 </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储好友信息</span></span><br><span class="line">    _friendModel.<span class="built_in">insert</span>(userid,friendid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建群组业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::createGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//创建群的用户的id </span></span><br><span class="line">    string name = js[<span class="string">&quot;groupname&quot;</span>];</span><br><span class="line">    string desc = js[<span class="string">&quot;groupdesc&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储新创建的群组信息</span></span><br><span class="line">    Group group;</span><br><span class="line">    group.<span class="built_in">setName</span>(name);</span><br><span class="line">    group.<span class="built_in">setDesc</span>(desc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_groupModel.<span class="built_in">createGroup</span>(group))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//存储群组创建人信息</span></span><br><span class="line">        _groupModel.<span class="built_in">addGroup</span>(userid,group.<span class="built_in">getId</span>(),<span class="string">&quot;creator&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//加入群组业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::addGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    <span class="type">int</span> groupid = js[<span class="string">&quot;groupid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    _groupModel.<span class="built_in">addGroup</span>(userid,groupid,<span class="string">&quot;normal&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//群组聊天业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::groupChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    <span class="type">int</span> groupid = js[<span class="string">&quot;groupid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; useridVec = _groupModel.<span class="built_in">queryGroupUsers</span>(userid, groupid);</span><br><span class="line">    <span class="comment">//查询这个用户所在群组的其他用户id </span></span><br><span class="line"></span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;<span class="comment">//不允许其他人在map里面增删改查 </span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> id:useridVec)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(id);</span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            _offlineMsgModel.<span class="built_in">insert</span>(id,js.<span class="built_in">dump</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/21-01(3).png" alt="本地png图片PictureTest.png"></p>
<h2 id="22-客户端开发一首页功能开发以及测试"><a href="#22-客户端开发一首页功能开发以及测试" class="headerlink" title="22 客户端开发一首页功能开发以及测试"></a>22 客户端开发一首页功能开发以及测试</h2><p><strong>我们增加一个文件夹&#x2F;src&#x2F;client</strong></p>
<p><strong>我们对&#x2F;src下的CMakeLists.txt进行修改</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">add_subdirectory</span>(server)</span><br><span class="line"><span class="built_in">add_subdirectory</span>(client)</span><br></pre></td></tr></table></figure>

<p><strong>我们在&#x2F;src&#x2F;client&#x2F;创建CMakeLists.txt</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 把当前路径下的所有源文件名字放入变量名SRC_LIST里面</span><br><span class="line">aux_source_directory(. SRC_LIST)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 表示生成可执行文件ChatServer，由SRC_LIST变量所定义的源文件</span><br><span class="line">add_executable(ChatClient $&#123;SRC_LIST&#125;)</span><br><span class="line"></span><br><span class="line"># 指定可执行文件链接时需要依赖的库文件</span><br><span class="line">target_link_libraries(ChatClient pthread)</span><br></pre></td></tr></table></figure>

<p><strong>我们在&#x2F;src&#x2F;client下创建main.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gruop.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;groupuser.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录当前登录用户的信息</span></span><br><span class="line">User g_currentUser;</span><br><span class="line"><span class="comment">// 记录当前用户朋友的信息</span></span><br><span class="line">vector&lt;User&gt; g_currentFriendList; </span><br><span class="line"><span class="comment">// 记录当前用户群组的信息</span></span><br><span class="line">vector&lt;Group&gt; g_currentGroupList;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">showCurrentUserData</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聊天客户端程序实现，main线程用作发送线程，子线程用作接受线程</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;command invalid example : ./ChatClient 127.0.0.1 6000&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建client端的socket</span></span><br><span class="line">    <span class="type">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM , <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == clientfd)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;socket create error&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">uint16_t</span> port = <span class="built_in">atoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//填写client需要连接的server信息ip+port</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serv;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv,<span class="number">0</span>,<span class="built_in">sizeof</span>(sockaddr_in));</span><br><span class="line">    serv.sin_family = AF_INET;</span><br><span class="line">    serv.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    serv.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client和server进行连接</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">connect</span>(clientfd,(<span class="type">const</span> sockaddr *)&amp;serv,<span class="built_in">sizeof</span>(sockaddr_in)))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect server error&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">close</span>(clientfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//main线程用于接受用户输入，负责发送数据</span></span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 显示首页面菜单 登录、注册、退出</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;========================&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;1.login&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;2.register&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;3.quit&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;========================&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;choice:&quot;</span>;</span><br><span class="line">        <span class="type">int</span> choice = <span class="number">0</span>;</span><br><span class="line">        cin &gt;&gt; choice;</span><br><span class="line">        cin.<span class="built_in">get</span>(); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (choice)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> id = <span class="number">0</span>;</span><br><span class="line">            <span class="type">char</span> password[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;userid:&quot;</span>;</span><br><span class="line">            cin &gt;&gt; id;</span><br><span class="line">            cin.<span class="built_in">get</span>();  <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;userpassword:&quot;</span>;</span><br><span class="line">            cin.<span class="built_in">getline</span>(password,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">            json js;</span><br><span class="line">            js[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG;</span><br><span class="line">            js[<span class="string">&quot;id&quot;</span>] = id;</span><br><span class="line">            js[<span class="string">&quot;password&quot;</span>] = password;</span><br><span class="line">            string request = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,request.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(request.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;send login msg error:&quot;</span> &lt;&lt; request &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">recv</span>(clientfd,buffer,<span class="number">1024</span>,<span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;recv login msg error&quot;</span> &lt;&lt; endl;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    json responsejs = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(<span class="number">0</span> != responsejs[<span class="string">&quot;errno&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;()) <span class="comment">//登录失败</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; responsejs[<span class="string">&quot;errmsg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="comment">//登录成功</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; responsejs[<span class="string">&quot;errmsg&quot;</span>] &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 记录当前用户的id和name</span></span><br><span class="line">                        g_currentUser.<span class="built_in">setId</span>(responsejs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                        g_currentUser.<span class="built_in">setName</span>(responsejs[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 记录当前用户的好友列表信息</span></span><br><span class="line">                        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;friends&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            vector&lt;string&gt; vec = responsejs[<span class="string">&quot;friends&quot;</span>];</span><br><span class="line">                            <span class="keyword">for</span>(string &amp;str:vec)</span><br><span class="line">                            &#123;</span><br><span class="line">                                json js = json::<span class="built_in">parse</span>(str);</span><br><span class="line">                                User user;</span><br><span class="line">                                user.<span class="built_in">setId</span>(js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                                user.<span class="built_in">setName</span>(js[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">                                user.<span class="built_in">setState</span>(js[<span class="string">&quot;state&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                                g_currentFriendList.<span class="built_in">push_back</span>(user);</span><br><span class="line">                            &#125;  </span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;groups&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            vector&lt;string&gt; vec1 = responsejs[<span class="string">&quot;groups&quot;</span>];</span><br><span class="line">                            <span class="keyword">for</span>(string &amp;str1:vec1)</span><br><span class="line">                            &#123;</span><br><span class="line">                                json grpjs = json::<span class="built_in">parse</span>(str1);</span><br><span class="line">                                Group group;</span><br><span class="line">                                group.<span class="built_in">setId</span>(grpjs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                                group.<span class="built_in">setName</span>(grpjs[<span class="string">&quot;groupname&quot;</span>]);</span><br><span class="line">                                group.<span class="built_in">setDesc</span>(grpjs[<span class="string">&quot;groupdesc&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                                vector&lt;string&gt; vec2 = grpjs[<span class="string">&quot;users&quot;</span>];</span><br><span class="line">                                <span class="keyword">for</span>(string &amp;str2:vec2)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    json js = json::<span class="built_in">parse</span>(str2);</span><br><span class="line">                                    GroupUser user;</span><br><span class="line">                                    user.<span class="built_in">setId</span>(js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                                    user.<span class="built_in">setName</span>(js[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">                                    user.<span class="built_in">setState</span>(js[<span class="string">&quot;state&quot;</span>]);</span><br><span class="line">                                    user.<span class="built_in">setRole</span>(js[<span class="string">&quot;role&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                                    group.<span class="built_in">getUsers</span>().<span class="built_in">push_back</span>(user);</span><br><span class="line">                                &#125;</span><br><span class="line">                                g_currentGroupList.<span class="built_in">push_back</span>(group);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line">                        <span class="built_in">showCurrentUserData</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;   </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cin.<span class="built_in">get</span>();</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;clear&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">char</span> name[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="type">char</span> password[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;name:&quot;</span> ;</span><br><span class="line">            cin.<span class="built_in">getline</span>(name,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;password:&quot;</span>;</span><br><span class="line">            cin.<span class="built_in">getline</span>(password,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">            json js;</span><br><span class="line">            js[<span class="string">&quot;msgid&quot;</span>] = REG_MSG;</span><br><span class="line">            js[<span class="string">&quot;name&quot;</span>] = name;</span><br><span class="line">            js[<span class="string">&quot;password&quot;</span>] = password;</span><br><span class="line">            string request = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,request.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(request.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;send reg msg error:&quot;</span> &lt;&lt; request &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="type">int</span> len = <span class="built_in">recv</span>(clientfd,buffer,<span class="number">1024</span>,<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">-1</span> == len)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;recv reg response error&quot;</span> &lt;&lt; endl;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> </span><br><span class="line">                &#123;</span><br><span class="line">                    json responsejs = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line">                    <span class="keyword">if</span>(<span class="number">0</span> != responsejs[<span class="string">&quot;errno&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;())</span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; name &lt;&lt; <span class="string">&quot; is already exist , register error !&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="comment">//注册成功</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;register success , userid is &quot;</span> </span><br><span class="line">                        &lt;&lt; responsejs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;() &lt;&lt; </span><br><span class="line">                        <span class="string">&quot; , dot not forget it !&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;     </span><br><span class="line">        &#125;</span><br><span class="line">        cin.<span class="built_in">get</span>();</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;clear&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">//quit业务</span></span><br><span class="line">            <span class="built_in">close</span>(clientfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">break</span>;            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;invalid input!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">showCurrentUserData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;======================login user======================&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;current login user =&gt; id:&quot;</span> &lt;&lt; g_currentUser.<span class="built_in">getId</span>() &lt;&lt; <span class="string">&quot; name:&quot;</span> </span><br><span class="line">    &lt;&lt; g_currentUser.<span class="built_in">getName</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;----------------------friend list---------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span>(!g_currentFriendList.<span class="built_in">empty</span>()) <span class="comment">//如果好友列表不为空</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(User &amp;user:g_currentFriendList)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;第&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;个好友信息:&quot;</span> &lt;&lt; user.<span class="built_in">getId</span>() </span><br><span class="line">            &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getState</span>() &lt;&lt; endl;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;----------------------group list---------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span>(!g_currentGroupList.<span class="built_in">empty</span>())<span class="comment">//群组信息不为空，才打印出来</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(Group &amp;group:g_currentGroupList)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; group.<span class="built_in">getId</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; group.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> </span><br><span class="line">            &lt;&lt; group.<span class="built_in">getDesc</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span>(GroupUser &amp;user:group.<span class="built_in">getUsers</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;第&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;个人信息:&quot;</span> &lt;&lt; user.<span class="built_in">getId</span>() </span><br><span class="line">                &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getState</span>() &lt;&lt; endl;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<p><strong>首先向mysql中的allgroup和groupuserc插入数据</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/22-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/22-01(2).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/22-01(3).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/22-01(4).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/22-01(5).png" alt="本地png图片PictureTest.png"></p>
<h3 id="22-1-问题"><a href="#22-1-问题" class="headerlink" title="22.1 问题"></a>22.1 问题</h3><p><strong>1 strlen和sizeof的区别</strong></p>
<p>(1)strlen 是函数，sizeof 是运算符。</p>
<p>(2)strlen 测量的是字符的实际长度，以’\0’ 结束（不包含’\0’ ）。而sizeof 测量的是字符的分配大小，如果未分配大小，则遇到’\0’ 结束（包含’\0’ ，也就是strlen</p>
<p>测量的长度加1），如果已经分配内存大小，返回的就是分配的内存大小。</p>
<p><strong>2 linux不能使用system(“pause”)可以用cin.get()但还是没有system(“pause”)好</strong></p>
<p><strong>3 注意cin.get()和cin.getline()的区别</strong></p>
<p><strong>4 传输至网路层需要序列化，千万不要忘记</strong></p>
<h2 id="23-客户端开发二添加好友和聊天功能开发"><a href="#23-客户端开发二添加好友和聊天功能开发" class="headerlink" title="23 客户端开发二添加好友和聊天功能开发"></a><strong>23 客户端开发二添加好友和聊天功能开发</strong></h2><p><strong>在src&#x2F;client&#x2F;main.cpp下</strong></p>
<p>启动新线程负责接受数据，然后进入聊天主菜单页面。完善对新线程接受数据代码的编写，对聊天主菜单页面的编写。聊天主菜单页面，首先将系统所支持的命令</p>
<p>打印出来，再根据输入的命令，分别调用相应的函数进行处理。完成对添加好友、聊天功能、help函数的编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gruop.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;groupuser.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录当前登录用户的信息</span></span><br><span class="line">User g_currentUser;</span><br><span class="line"><span class="comment">// 记录当前用户朋友的信息</span></span><br><span class="line">vector&lt;User&gt; g_currentFriendList; </span><br><span class="line"><span class="comment">// 记录当前用户群组的信息</span></span><br><span class="line">vector&lt;Group&gt; g_currentGroupList;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取系统时间（聊天信息需要添加时间信息）</span></span><br><span class="line"><span class="function">string <span class="title">getCurrentTime</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">showCurrentUserData</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接收线程 控制台应用程序，接收用户的手动输入，用户不输入cin就阻塞住，所以要2个线程 </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">readTaskHandler</span><span class="params">(<span class="type">int</span> clientfd)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//显示主菜单</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainMenu</span><span class="params">(<span class="type">int</span> clientfd)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聊天客户端程序实现，main线程用作发送线程，子线程用作接受线程</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;command invalid example : ./ChatClient 127.0.0.1 6000&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建client端的socket</span></span><br><span class="line">    <span class="type">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM , <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == clientfd)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;socket create error&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">uint16_t</span> port = <span class="built_in">atoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//填写client需要连接的server信息ip+port</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serv;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv,<span class="number">0</span>,<span class="built_in">sizeof</span>(sockaddr_in));</span><br><span class="line">    serv.sin_family = AF_INET;</span><br><span class="line">    serv.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    serv.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client和server进行连接</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">connect</span>(clientfd,(<span class="type">const</span> sockaddr *)&amp;serv,<span class="built_in">sizeof</span>(sockaddr_in)))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect server error&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">close</span>(clientfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//main线程用于接受用户输入，负责发送数据</span></span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 显示首页面菜单 登录、注册、退出</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;========================&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;1.login&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;2.register&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;3.quit&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;========================&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;choice:&quot;</span>;</span><br><span class="line">        <span class="type">int</span> choice = <span class="number">0</span>;</span><br><span class="line">        cin &gt;&gt; choice;</span><br><span class="line">        cin.<span class="built_in">get</span>(); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (choice)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> id = <span class="number">0</span>;</span><br><span class="line">            <span class="type">char</span> password[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;userid:&quot;</span>;</span><br><span class="line">            cin &gt;&gt; id;</span><br><span class="line">            cin.<span class="built_in">get</span>();  <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;userpassword:&quot;</span>;</span><br><span class="line">            cin.<span class="built_in">getline</span>(password,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">            json js;</span><br><span class="line">            js[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG;</span><br><span class="line">            js[<span class="string">&quot;id&quot;</span>] = id;</span><br><span class="line">            js[<span class="string">&quot;password&quot;</span>] = password;</span><br><span class="line">            string request = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,request.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(request.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;send login msg error:&quot;</span> &lt;&lt; request &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">recv</span>(clientfd,buffer,<span class="number">1024</span>,<span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;recv login msg error&quot;</span> &lt;&lt; endl;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    json responsejs = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(<span class="number">0</span> != responsejs[<span class="string">&quot;errno&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;()) <span class="comment">//登录失败</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; responsejs[<span class="string">&quot;errmsg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="comment">//登录成功</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; responsejs[<span class="string">&quot;errmsg&quot;</span>] &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 记录当前用户的id和name</span></span><br><span class="line">                        g_currentUser.<span class="built_in">setId</span>(responsejs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                        g_currentUser.<span class="built_in">setName</span>(responsejs[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 记录当前用户的好友列表信息</span></span><br><span class="line">                        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;friends&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            vector&lt;string&gt; vec = responsejs[<span class="string">&quot;friends&quot;</span>];</span><br><span class="line">                            <span class="keyword">for</span>(string &amp;str:vec)</span><br><span class="line">                            &#123;</span><br><span class="line">                                json js = json::<span class="built_in">parse</span>(str);</span><br><span class="line">                                User user;</span><br><span class="line">                                user.<span class="built_in">setId</span>(js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                                user.<span class="built_in">setName</span>(js[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">                                user.<span class="built_in">setState</span>(js[<span class="string">&quot;state&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                                g_currentFriendList.<span class="built_in">push_back</span>(user);</span><br><span class="line">                            &#125;  </span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;groups&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            vector&lt;string&gt; vec1 = responsejs[<span class="string">&quot;groups&quot;</span>];</span><br><span class="line">                            <span class="keyword">for</span>(string &amp;str1:vec1)</span><br><span class="line">                            &#123;</span><br><span class="line">                                json grpjs = json::<span class="built_in">parse</span>(str1);</span><br><span class="line">                                Group group;</span><br><span class="line">                                group.<span class="built_in">setId</span>(grpjs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                                group.<span class="built_in">setName</span>(grpjs[<span class="string">&quot;groupname&quot;</span>]);</span><br><span class="line">                                group.<span class="built_in">setDesc</span>(grpjs[<span class="string">&quot;groupdesc&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                                vector&lt;string&gt; vec2 = grpjs[<span class="string">&quot;users&quot;</span>];</span><br><span class="line">                                <span class="keyword">for</span>(string &amp;str2:vec2)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    json js = json::<span class="built_in">parse</span>(str2);</span><br><span class="line">                                    GroupUser user;</span><br><span class="line">                                    user.<span class="built_in">setId</span>(js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                                    user.<span class="built_in">setName</span>(js[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">                                    user.<span class="built_in">setState</span>(js[<span class="string">&quot;state&quot;</span>]);</span><br><span class="line">                                    user.<span class="built_in">setRole</span>(js[<span class="string">&quot;role&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                                    group.<span class="built_in">getUsers</span>().<span class="built_in">push_back</span>(user);</span><br><span class="line">                                &#125;</span><br><span class="line">                                g_currentGroupList.<span class="built_in">push_back</span>(group);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line">                        <span class="built_in">showCurrentUserData</span>();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;offlinemsg&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            vector&lt;string&gt; vec = responsejs[<span class="string">&quot;offlinemsg&quot;</span>];</span><br><span class="line">                            <span class="keyword">for</span>(string &amp;str: vec)</span><br><span class="line">                            &#123;</span><br><span class="line">                                json js = json::<span class="built_in">parse</span>(str);</span><br><span class="line">                                <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">                                cout &lt;&lt; js[<span class="string">&quot;time&quot;</span>] &lt;&lt; <span class="string">&quot; [ &quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot; ] &quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] </span><br><span class="line">                                &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">                            &#125;                            </span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//登陆成功，启动接受线程负责接受数据</span></span><br><span class="line">                        <span class="function">std::thread <span class="title">readTask</span><span class="params">(readTaskHandler,clientfd)</span></span>;</span><br><span class="line">                        readTask.<span class="built_in">detach</span>();</span><br><span class="line">                        <span class="comment">// 进入聊天主菜单页面</span></span><br><span class="line">                        <span class="built_in">mainMenu</span>(clientfd);                        </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;   </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cin.<span class="built_in">get</span>();</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;clear&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">char</span> name[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="type">char</span> password[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;name:&quot;</span> ;</span><br><span class="line">            cin.<span class="built_in">getline</span>(name,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;password:&quot;</span>;</span><br><span class="line">            cin.<span class="built_in">getline</span>(password,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">            json js;</span><br><span class="line">            js[<span class="string">&quot;msgid&quot;</span>] = REG_MSG;</span><br><span class="line">            js[<span class="string">&quot;name&quot;</span>] = name;</span><br><span class="line">            js[<span class="string">&quot;password&quot;</span>] = password;</span><br><span class="line">            string request = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,request.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(request.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;send reg msg error:&quot;</span> &lt;&lt; request &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="type">int</span> len = <span class="built_in">recv</span>(clientfd,buffer,<span class="number">1024</span>,<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">-1</span> == len)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;recv reg response error&quot;</span> &lt;&lt; endl;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> </span><br><span class="line">                &#123;</span><br><span class="line">                    json responsejs = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line">                    <span class="keyword">if</span>(<span class="number">0</span> != responsejs[<span class="string">&quot;errno&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;())</span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; name &lt;&lt; <span class="string">&quot; is already exist , register error !&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="comment">//注册成功</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;register success , userid is &quot;</span> </span><br><span class="line">                        &lt;&lt; responsejs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;() &lt;&lt; </span><br><span class="line">                        <span class="string">&quot; , dot not forget it !&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;     </span><br><span class="line">        &#125;</span><br><span class="line">        cin.<span class="built_in">get</span>();</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;clear&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">//quit业务</span></span><br><span class="line">            <span class="built_in">close</span>(clientfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">break</span>;            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;invalid input!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">showCurrentUserData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;======================login user======================&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;current login user =&gt; id:&quot;</span> &lt;&lt; g_currentUser.<span class="built_in">getId</span>() &lt;&lt; <span class="string">&quot; name:&quot;</span> </span><br><span class="line">    &lt;&lt; g_currentUser.<span class="built_in">getName</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;----------------------friend list---------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span>(!g_currentFriendList.<span class="built_in">empty</span>()) <span class="comment">//如果好友列表不为空</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(User &amp;user:g_currentFriendList)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;第&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;个好友信息:&quot;</span> &lt;&lt; user.<span class="built_in">getId</span>() </span><br><span class="line">            &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getState</span>() &lt;&lt; endl;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;----------------------group list---------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span>(!g_currentGroupList.<span class="built_in">empty</span>())<span class="comment">//群组信息不为空，才打印出来</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(Group &amp;group:g_currentGroupList)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; group.<span class="built_in">getId</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; group.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> </span><br><span class="line">            &lt;&lt; group.<span class="built_in">getDesc</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span>(GroupUser &amp;user:group.<span class="built_in">getUsers</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;第&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;个人信息:&quot;</span> &lt;&lt; user.<span class="built_in">getId</span>() </span><br><span class="line">                &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getState</span>() &lt;&lt; endl;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接受线程</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">readTaskHandler</span><span class="params">(<span class="type">int</span> clientfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">int</span> len = <span class="built_in">recv</span>(clientfd, buffer, <span class="number">1024</span> , <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == len || <span class="number">0</span> == len)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">close</span>(clientfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接受ChatServer转发的数据，反序列化生产json数据对象</span></span><br><span class="line">        json js = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line">        <span class="keyword">if</span>(ONE_CHAT_MSG == js[<span class="string">&quot;msgid&quot;</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">            cout &lt;&lt; js[<span class="string">&quot;time&quot;</span>] &lt;&lt; <span class="string">&quot; [ &quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot; ] &quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] </span><br><span class="line">            &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;help&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">help</span><span class="params">(<span class="type">int</span> fd = <span class="number">0</span> , string str = <span class="string">&quot; &quot;</span>)</span></span>;</span><br><span class="line"><span class="comment">// &quot;chat&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">chat</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">// &quot;addfriend&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addfriend</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统支持的客户端命令列表</span></span><br><span class="line">unordered_map&lt;string,string&gt; commandMap = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;help&quot;</span>,<span class="string">&quot;显示所有支持的命令,格式help&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,<span class="string">&quot;一对一聊天,格式chat:friendid:message&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addfriend&quot;</span>,<span class="string">&quot;添加好友,格式addfriend:friendid&quot;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册系统支持的客户端命令处理</span></span><br><span class="line">unordered_map&lt;string,function&lt;<span class="type">void</span>(<span class="type">int</span>,string)&gt;&gt; commandHandlerMap = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;help&quot;</span>,help&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,chat&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addfriend&quot;</span>,addfriend&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">help</span><span class="params">(<span class="type">int</span>, string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;show command list &gt;&gt;&gt;&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;it:commandMap)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; it.first &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; it.second &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainMenu</span><span class="params">(<span class="type">int</span> clientfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">help</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        cin.<span class="built_in">getline</span>(buffer, <span class="number">1024</span>);</span><br><span class="line">        <span class="function">string <span class="title">commandbuf</span><span class="params">(buffer)</span></span>;</span><br><span class="line">        string command;</span><br><span class="line">        <span class="type">int</span> idx = commandbuf.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == idx)</span><br><span class="line">        &#123;</span><br><span class="line">            command = commandbuf;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            command = commandbuf.<span class="built_in">substr</span>(<span class="number">0</span>,idx);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = commandHandlerMap.<span class="built_in">find</span>(command);</span><br><span class="line">        <span class="keyword">if</span>(it == commandHandlerMap.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;invalid command&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用相应命令的事件处理回调,mainMenu对修改封闭,添加新功能</span></span><br><span class="line">        it-&gt;<span class="built_in">second</span>(clientfd,commandbuf.<span class="built_in">substr</span>(idx+<span class="number">1</span>,commandbuf.<span class="built_in">size</span>()-idx));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">chat</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> idx = str.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="type">int</span> friendid = <span class="built_in">atoi</span>((str.<span class="built_in">substr</span>(<span class="number">0</span>,idx)).<span class="built_in">c_str</span>());</span><br><span class="line">    string message = str.<span class="built_in">substr</span>(idx+<span class="number">1</span>,str.<span class="built_in">size</span>()-idx);</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = ONE_CHAT_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;name&quot;</span>] = g_currentUser.<span class="built_in">getName</span>();</span><br><span class="line">    js[<span class="string">&quot;toid&quot;</span>] = friendid;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>] = message;</span><br><span class="line">    js[<span class="string">&quot;time&quot;</span>] = <span class="built_in">getCurrentTime</span>();</span><br><span class="line"></span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send chat msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addfriend</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> friendid = <span class="built_in">atoi</span>(str.<span class="built_in">c_str</span>());</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = ADD_FRIEND_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;friendid&quot;</span>] = friendid;</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == len)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send addfriend msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取系统时间（聊天信息需要添加时间信息）</span></span><br><span class="line"><span class="function">string <span class="title">getCurrentTime</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> tt = std::chrono::system_clock::<span class="built_in">to_time_t</span>(std::chrono::system_clock::<span class="built_in">now</span>());</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> *ptm = <span class="built_in">localtime</span>(&amp;tt);</span><br><span class="line">    <span class="type">char</span> date[<span class="number">60</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(date, <span class="string">&quot;%d-%02d-%02d %02d:%02d:%02d&quot;</span>,</span><br><span class="line">            (<span class="type">int</span>)ptm-&gt;tm_year + <span class="number">1900</span>, (<span class="type">int</span>)ptm-&gt;tm_mon + <span class="number">1</span>, (<span class="type">int</span>)ptm-&gt;tm_mday,</span><br><span class="line">            (<span class="type">int</span>)ptm-&gt;tm_hour, (<span class="type">int</span>)ptm-&gt;tm_min, (<span class="type">int</span>)ptm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">string</span>(date);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/23-01(1).png" alt="本地png图片PictureTest.png"></p>
<h3 id="23-1-问题"><a href="#23-1-问题" class="headerlink" title="23.1 问题"></a>23.1 问题</h3><p>将src&#x2F;server&#x2F;chatservice.cpp中的聊天业务修改一下，登录之后，也只有本id才能去发消息。将20.1中的问题解决</p>
<h2 id="24-客户端开发三群组功能开发"><a href="#24-客户端开发三群组功能开发" class="headerlink" title="24 客户端开发三群组功能开发"></a>24 客户端开发三群组功能开发</h2><p><strong>在src&#x2F;client&#x2F;main.cpp下</strong></p>
<p>完成对创建群组、加入群组、群组聊天功能函数的编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gruop.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;groupuser.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录当前登录用户的信息</span></span><br><span class="line">User g_currentUser;</span><br><span class="line"><span class="comment">// 记录当前用户朋友的信息</span></span><br><span class="line">vector&lt;User&gt; g_currentFriendList; </span><br><span class="line"><span class="comment">// 记录当前用户群组的信息</span></span><br><span class="line">vector&lt;Group&gt; g_currentGroupList;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取系统时间（聊天信息需要添加时间信息）</span></span><br><span class="line"><span class="function">string <span class="title">getCurrentTime</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">showCurrentUserData</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接收线程 控制台应用程序，接收用户的手动输入，用户不输入cin就阻塞住，所以要2个线程 </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">readTaskHandler</span><span class="params">(<span class="type">int</span> clientfd)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//显示主菜单</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainMenu</span><span class="params">(<span class="type">int</span> clientfd)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聊天客户端程序实现，main线程用作发送线程，子线程用作接受线程</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;command invalid example : ./ChatClient 127.0.0.1 6000&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建client端的socket</span></span><br><span class="line">    <span class="type">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM , <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == clientfd)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;socket create error&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">uint16_t</span> port = <span class="built_in">atoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//填写client需要连接的server信息ip+port</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serv;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv,<span class="number">0</span>,<span class="built_in">sizeof</span>(sockaddr_in));</span><br><span class="line">    serv.sin_family = AF_INET;</span><br><span class="line">    serv.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    serv.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client和server进行连接</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">connect</span>(clientfd,(<span class="type">const</span> sockaddr *)&amp;serv,<span class="built_in">sizeof</span>(sockaddr_in)))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect server error&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">close</span>(clientfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//main线程用于接受用户输入，负责发送数据</span></span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 显示首页面菜单 登录、注册、退出</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;========================&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;1.login&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;2.register&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;3.quit&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;========================&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;choice:&quot;</span>;</span><br><span class="line">        <span class="type">int</span> choice = <span class="number">0</span>;</span><br><span class="line">        cin &gt;&gt; choice;</span><br><span class="line">        cin.<span class="built_in">get</span>(); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (choice)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> id = <span class="number">0</span>;</span><br><span class="line">            <span class="type">char</span> password[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;userid:&quot;</span>;</span><br><span class="line">            cin &gt;&gt; id;</span><br><span class="line">            cin.<span class="built_in">get</span>();  <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;userpassword:&quot;</span>;</span><br><span class="line">            cin.<span class="built_in">getline</span>(password,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">            json js;</span><br><span class="line">            js[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG;</span><br><span class="line">            js[<span class="string">&quot;id&quot;</span>] = id;</span><br><span class="line">            js[<span class="string">&quot;password&quot;</span>] = password;</span><br><span class="line">            string request = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,request.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(request.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;send login msg error:&quot;</span> &lt;&lt; request &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">recv</span>(clientfd,buffer,<span class="number">1024</span>,<span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;recv login msg error&quot;</span> &lt;&lt; endl;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    json responsejs = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(<span class="number">0</span> != responsejs[<span class="string">&quot;errno&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;()) <span class="comment">//登录失败</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; responsejs[<span class="string">&quot;errmsg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="comment">//登录成功</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; responsejs[<span class="string">&quot;errmsg&quot;</span>] &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 记录当前用户的id和name</span></span><br><span class="line">                        g_currentUser.<span class="built_in">setId</span>(responsejs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                        g_currentUser.<span class="built_in">setName</span>(responsejs[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 记录当前用户的好友列表信息</span></span><br><span class="line">                        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;friends&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            vector&lt;string&gt; vec = responsejs[<span class="string">&quot;friends&quot;</span>];</span><br><span class="line">                            <span class="keyword">for</span>(string &amp;str:vec)</span><br><span class="line">                            &#123;</span><br><span class="line">                                json js = json::<span class="built_in">parse</span>(str);</span><br><span class="line">                                User user;</span><br><span class="line">                                user.<span class="built_in">setId</span>(js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                                user.<span class="built_in">setName</span>(js[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">                                user.<span class="built_in">setState</span>(js[<span class="string">&quot;state&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                                g_currentFriendList.<span class="built_in">push_back</span>(user);</span><br><span class="line">                            &#125;  </span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;groups&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            vector&lt;string&gt; vec1 = responsejs[<span class="string">&quot;groups&quot;</span>];</span><br><span class="line">                            <span class="keyword">for</span>(string &amp;str1:vec1)</span><br><span class="line">                            &#123;</span><br><span class="line">                                json grpjs = json::<span class="built_in">parse</span>(str1);</span><br><span class="line">                                Group group;</span><br><span class="line">                                group.<span class="built_in">setId</span>(grpjs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                                group.<span class="built_in">setName</span>(grpjs[<span class="string">&quot;groupname&quot;</span>]);</span><br><span class="line">                                group.<span class="built_in">setDesc</span>(grpjs[<span class="string">&quot;groupdesc&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                                vector&lt;string&gt; vec2 = grpjs[<span class="string">&quot;users&quot;</span>];</span><br><span class="line">                                <span class="keyword">for</span>(string &amp;str2:vec2)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    json js = json::<span class="built_in">parse</span>(str2);</span><br><span class="line">                                    GroupUser user;</span><br><span class="line">                                    user.<span class="built_in">setId</span>(js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                                    user.<span class="built_in">setName</span>(js[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">                                    user.<span class="built_in">setState</span>(js[<span class="string">&quot;state&quot;</span>]);</span><br><span class="line">                                    user.<span class="built_in">setRole</span>(js[<span class="string">&quot;role&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                                    group.<span class="built_in">getUsers</span>().<span class="built_in">push_back</span>(user);</span><br><span class="line">                                &#125;</span><br><span class="line">                                g_currentGroupList.<span class="built_in">push_back</span>(group);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line">                        <span class="built_in">showCurrentUserData</span>();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;offlinemsg&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            vector&lt;string&gt; vec = responsejs[<span class="string">&quot;offlinemsg&quot;</span>];</span><br><span class="line">                            <span class="keyword">for</span>(string &amp;str: vec)</span><br><span class="line">                            &#123;</span><br><span class="line">                                json js = json::<span class="built_in">parse</span>(str);</span><br><span class="line">                                <span class="keyword">if</span>(ONE_CHAT_MSG == js[<span class="string">&quot;msgid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;())</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">                                    cout &lt;&lt; js[<span class="string">&quot;time&quot;</span>] &lt;&lt; <span class="string">&quot; [ &quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot; ] &quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] </span><br><span class="line">                                    &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span> <span class="keyword">if</span>(GROUP_CHAT_MSG == js[<span class="string">&quot;msgid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;())</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">                                    cout &lt;&lt; <span class="string">&quot;群消息[&quot;</span> &lt;&lt; js[<span class="string">&quot;groupid&quot;</span>] &lt;&lt; <span class="string">&quot;]:&quot;</span> &lt;&lt; js[<span class="string">&quot;time&quot;</span>] </span><br><span class="line">                                    &lt;&lt; <span class="string">&quot; [&quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot;]&quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] </span><br><span class="line">                                    &lt;&lt; endl;</span><br><span class="line">                                    <span class="keyword">continue</span>;             </span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;                            </span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//登陆成功，启动接受线程负责接受数据</span></span><br><span class="line">                        <span class="function">std::thread <span class="title">readTask</span><span class="params">(readTaskHandler,clientfd)</span></span>;</span><br><span class="line">                        readTask.<span class="built_in">detach</span>();</span><br><span class="line">                        <span class="comment">// 进入聊天主菜单页面</span></span><br><span class="line">                        <span class="built_in">mainMenu</span>(clientfd);                        </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;   </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cin.<span class="built_in">get</span>();</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;clear&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">char</span> name[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="type">char</span> password[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;name:&quot;</span> ;</span><br><span class="line">            cin.<span class="built_in">getline</span>(name,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;password:&quot;</span>;</span><br><span class="line">            cin.<span class="built_in">getline</span>(password,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">            json js;</span><br><span class="line">            js[<span class="string">&quot;msgid&quot;</span>] = REG_MSG;</span><br><span class="line">            js[<span class="string">&quot;name&quot;</span>] = name;</span><br><span class="line">            js[<span class="string">&quot;password&quot;</span>] = password;</span><br><span class="line">            string request = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,request.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(request.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;send reg msg error:&quot;</span> &lt;&lt; request &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="type">int</span> len = <span class="built_in">recv</span>(clientfd,buffer,<span class="number">1024</span>,<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">-1</span> == len)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;recv reg response error&quot;</span> &lt;&lt; endl;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> </span><br><span class="line">                &#123;</span><br><span class="line">                    json responsejs = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line">                    <span class="keyword">if</span>(<span class="number">0</span> != responsejs[<span class="string">&quot;errno&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;())</span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; name &lt;&lt; <span class="string">&quot; is already exist , register error !&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="comment">//注册成功</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;register success , userid is &quot;</span> </span><br><span class="line">                        &lt;&lt; responsejs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;() &lt;&lt; </span><br><span class="line">                        <span class="string">&quot; , dot not forget it !&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;     </span><br><span class="line">        &#125;</span><br><span class="line">        cin.<span class="built_in">get</span>();</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;clear&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">//quit业务</span></span><br><span class="line">            <span class="built_in">close</span>(clientfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">break</span>;            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;invalid input!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">showCurrentUserData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;======================login user======================&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;current login user =&gt; id:&quot;</span> &lt;&lt; g_currentUser.<span class="built_in">getId</span>() &lt;&lt; <span class="string">&quot; name:&quot;</span> </span><br><span class="line">    &lt;&lt; g_currentUser.<span class="built_in">getName</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;----------------------friend list---------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span>(!g_currentFriendList.<span class="built_in">empty</span>()) <span class="comment">//如果好友列表不为空</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(User &amp;user:g_currentFriendList)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;第&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;个好友信息:&quot;</span> &lt;&lt; user.<span class="built_in">getId</span>() </span><br><span class="line">            &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getState</span>() &lt;&lt; endl;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;----------------------group list---------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span>(!g_currentGroupList.<span class="built_in">empty</span>())<span class="comment">//群组信息不为空，才打印出来</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(Group &amp;group:g_currentGroupList)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; group.<span class="built_in">getId</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; group.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> </span><br><span class="line">            &lt;&lt; group.<span class="built_in">getDesc</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span>(GroupUser &amp;user:group.<span class="built_in">getUsers</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;第&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;个人信息:&quot;</span> &lt;&lt; user.<span class="built_in">getId</span>() </span><br><span class="line">                &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getState</span>() &lt;&lt; endl;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接受线程</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">readTaskHandler</span><span class="params">(<span class="type">int</span> clientfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">int</span> len = <span class="built_in">recv</span>(clientfd, buffer, <span class="number">1024</span> , <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == len || <span class="number">0</span> == len)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">close</span>(clientfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接受ChatServer转发的数据，反序列化生产json数据对象</span></span><br><span class="line">        json js = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line">        <span class="type">int</span> msgtype = js[<span class="string">&quot;msgid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">        <span class="keyword">if</span>(ONE_CHAT_MSG == msgtype)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">            cout &lt;&lt; js[<span class="string">&quot;time&quot;</span>] &lt;&lt; <span class="string">&quot; [ &quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot; ] &quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] </span><br><span class="line">            &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(GROUP_CHAT_MSG == msgtype)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;群消息[&quot;</span> &lt;&lt; js[<span class="string">&quot;groupid&quot;</span>] &lt;&lt; <span class="string">&quot;]:&quot;</span> &lt;&lt; js[<span class="string">&quot;time&quot;</span>] </span><br><span class="line">            &lt;&lt; <span class="string">&quot; [&quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot;]&quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] </span><br><span class="line">            &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;             </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;help&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">help</span><span class="params">(<span class="type">int</span> fd = <span class="number">0</span> , string str = <span class="string">&quot; &quot;</span>)</span></span>;</span><br><span class="line"><span class="comment">// &quot;chat&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">chat</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">// &quot;addfriend&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addfriend</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">// &quot;creategroup&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">creategroup</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">//&quot;addgroup&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addgroup</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">//&quot;groupchat&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">groupchat</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统支持的客户端命令列表</span></span><br><span class="line">unordered_map&lt;string,string&gt; commandMap = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;help&quot;</span>,<span class="string">&quot;显示所有支持的命令,格式help&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,<span class="string">&quot;一对一聊天,格式chat:friendid:message&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addfriend&quot;</span>,<span class="string">&quot;添加好友,格式addfriend:friendid&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;creategroup&quot;</span>,<span class="string">&quot;创建群组,格式creategroup:groupname:groupdesc&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addgroup&quot;</span>,<span class="string">&quot;加入群组,格式addgroup:groupid&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;groupchat&quot;</span>, <span class="string">&quot;群聊,格式groupchat:groupid:message&quot;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册系统支持的客户端命令处理</span></span><br><span class="line">unordered_map&lt;string,function&lt;<span class="type">void</span>(<span class="type">int</span>,string)&gt;&gt; commandHandlerMap = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;help&quot;</span>,help&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,chat&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addfriend&quot;</span>,addfriend&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;creategroup&quot;</span>,creategroup&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addgroup&quot;</span>,addgroup&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;groupchat&quot;</span>,groupchat&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;help&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">help</span><span class="params">(<span class="type">int</span>, string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;show command list &gt;&gt;&gt;&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;it:commandMap)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; it.first &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; it.second &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//主聊天页面程序，先显示一下系统支持的命令 </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainMenu</span><span class="params">(<span class="type">int</span> clientfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">help</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        cin.<span class="built_in">getline</span>(buffer, <span class="number">1024</span>);</span><br><span class="line">        <span class="function">string <span class="title">commandbuf</span><span class="params">(buffer)</span></span>;</span><br><span class="line">        string command;</span><br><span class="line">        <span class="type">int</span> idx = commandbuf.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == idx)</span><br><span class="line">        &#123;</span><br><span class="line">            command = commandbuf;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            command = commandbuf.<span class="built_in">substr</span>(<span class="number">0</span>,idx);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = commandHandlerMap.<span class="built_in">find</span>(command);</span><br><span class="line">        <span class="keyword">if</span>(it == commandHandlerMap.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;invalid command&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用相应命令的事件处理回调,mainMenu对修改封闭,添加新功能</span></span><br><span class="line">        it-&gt;<span class="built_in">second</span>(clientfd,commandbuf.<span class="built_in">substr</span>(idx+<span class="number">1</span>,commandbuf.<span class="built_in">size</span>()-idx));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;chat&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">chat</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> idx = str.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == idx)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;chat command invalid!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> friendid = <span class="built_in">atoi</span>((str.<span class="built_in">substr</span>(<span class="number">0</span>,idx)).<span class="built_in">c_str</span>());</span><br><span class="line">    string message = str.<span class="built_in">substr</span>(idx+<span class="number">1</span>,str.<span class="built_in">size</span>()-idx);</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = ONE_CHAT_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;name&quot;</span>] = g_currentUser.<span class="built_in">getName</span>();</span><br><span class="line">    js[<span class="string">&quot;toid&quot;</span>] = friendid;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>] = message;</span><br><span class="line">    js[<span class="string">&quot;time&quot;</span>] = <span class="built_in">getCurrentTime</span>();</span><br><span class="line"></span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send chat msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;addfriend&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addfriend</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> friendid = <span class="built_in">atoi</span>(str.<span class="built_in">c_str</span>());</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = ADD_FRIEND_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;friendid&quot;</span>] = friendid;</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == len)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send addfriend msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;creategroup&quot; command handler  groupname:groupdesc</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">creategroup</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> idx = str.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == idx)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;creategroup command invalid!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;        </span><br><span class="line">    &#125;</span><br><span class="line">    string groupname = str.<span class="built_in">substr</span>(<span class="number">0</span>,idx);</span><br><span class="line">    string groupdesc = str.<span class="built_in">substr</span>(idx+<span class="number">1</span>,str.<span class="built_in">size</span>()-idx);</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = CREATE_GROUP_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;groupname&quot;</span>] = groupname;</span><br><span class="line">    js[<span class="string">&quot;groupdesc&quot;</span>] = groupdesc;</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send creategroup msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;addgroup&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addgroup</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> groupid = <span class="built_in">atoi</span>(str.<span class="built_in">c_str</span>());</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = ADD_GROUP_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;groupid&quot;</span>] = groupid;</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send addgroup msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;groupchat&quot; command handler   groupid:message</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">groupchat</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> idx = str.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == idx)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;groupchat command invalid!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> groupid = <span class="built_in">atoi</span>((str.<span class="built_in">substr</span>(<span class="number">0</span>,idx)).<span class="built_in">c_str</span>());</span><br><span class="line">    string message = str.<span class="built_in">substr</span>(idx+<span class="number">1</span>,str.<span class="built_in">size</span>()-idx);</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = GROUP_CHAT_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;name&quot;</span>] = g_currentUser.<span class="built_in">getName</span>();</span><br><span class="line">    js[<span class="string">&quot;groupid&quot;</span>] = groupid;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>] = message;</span><br><span class="line">    js[<span class="string">&quot;time&quot;</span>] = <span class="built_in">getCurrentTime</span>();</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send groupchat msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取系统时间（聊天信息需要添加时间信息）</span></span><br><span class="line"><span class="function">string <span class="title">getCurrentTime</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> tt = std::chrono::system_clock::<span class="built_in">to_time_t</span>(std::chrono::system_clock::<span class="built_in">now</span>());</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> *ptm = <span class="built_in">localtime</span>(&amp;tt);</span><br><span class="line">    <span class="type">char</span> date[<span class="number">60</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(date, <span class="string">&quot;%d-%02d-%02d %02d:%02d:%02d&quot;</span>,</span><br><span class="line">            (<span class="type">int</span>)ptm-&gt;tm_year + <span class="number">1900</span>, (<span class="type">int</span>)ptm-&gt;tm_mon + <span class="number">1</span>, (<span class="type">int</span>)ptm-&gt;tm_mday,</span><br><span class="line">            (<span class="type">int</span>)ptm-&gt;tm_hour, (<span class="type">int</span>)ptm-&gt;tm_min, (<span class="type">int</span>)ptm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">string</span>(date);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>创建群组</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/24-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/24-01(2).png" alt="本地png图片PictureTest.png"></p>
<p><strong>加入群组</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/24-01(3).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/24-01(4).png" alt="本地png图片PictureTest.png"></p>
<p><strong>一对一聊天、群聊，离线消息加入offlinemessage,ID为2上线接受到离线消息</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/24-01(5).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/24-01(6).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/24-01(7).png" alt="本地png图片PictureTest.png"></p>
<p><strong>一对一聊天、群聊</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/24-01(8).png" alt="本地png图片PictureTest.png"></p>
<h2 id="25-客户端开发四用户注销功能开发"><a href="#25-客户端开发四用户注销功能开发" class="headerlink" title="25 客户端开发四用户注销功能开发"></a>25 客户端开发四用户注销功能开发</h2><p>在include&#x2F;public.hpp下增加注销消息</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PUBLIC_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUBLIC_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">是属于server和client的公共文件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">EnMsgType</span></span><br><span class="line">&#123;</span><br><span class="line">    LOGIN_MSG = <span class="number">1</span>,<span class="comment">//登录消息</span></span><br><span class="line">    LOGIN_MSG_ACK, <span class="comment">//登录回应消息</span></span><br><span class="line">    LOGINOUT_MSG,<span class="comment">//注销消息</span></span><br><span class="line">    REG_MSG, <span class="comment">//注册消息</span></span><br><span class="line">    REG_MSG_ACK, <span class="comment">//注册回应消息</span></span><br><span class="line">    ONE_CHAT_MSG, <span class="comment">//聊天消息</span></span><br><span class="line">    ADD_FRIEND_MSG,<span class="comment">//添加好友消息</span></span><br><span class="line"></span><br><span class="line">    CREATE_GROUP_MSG,<span class="comment">//创建群组</span></span><br><span class="line">    ADD_GROUP_MSG,<span class="comment">//加入群组</span></span><br><span class="line">    GROUP_CHAT_MSG,<span class="comment">//群聊天</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !PUBLIC_H</span></span></span><br></pre></td></tr></table></figure>

<p><strong>在include&#x2F;chatservice.hpp下增加对处理注销业务函数的声明</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span> <span class="comment">//一个消息ID映射一个事件处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;offlinemsgmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;friendmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;groupmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理一对一聊天业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理客户端异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理服务器异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加好友业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addFriend</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建群组业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">createGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加入群组业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//群组聊天业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">groupChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//处理注销业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">loginout</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储在线用户的通信连接，用户的id， TcpConnectionPtr</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,TcpConnectionPtr&gt; _userConnMap;</span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据操作类对象</span></span><br><span class="line">    UserModel _userModel;</span><br><span class="line">    OfflineMsgModel _offlineMsgModel;</span><br><span class="line">    FriendModel _friendModel;</span><br><span class="line">    GroupModel _groupModel;</span><br><span class="line">    <span class="comment">//定义互斥锁，保证_userConnMap的线程安全</span></span><br><span class="line">    mutex _connMutex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>在src&#x2F;server&#x2F;chatservice.cpp下</strong></p>
<p>增加注销业务处理回调注册</p>
<p>增加对注销业务函数的编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGINOUT_MSG, std::<span class="built_in">bind</span>(&amp;ChatService::loginout, <span class="keyword">this</span>, _1, _2, _3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ONE_CHAT_MSG,<span class="built_in">bind</span>(&amp;ChatService::oneChat,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ADD_FRIEND_MSG,<span class="built_in">bind</span>(&amp;ChatService::addFriend,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;CREATE_GROUP_MSG,<span class="built_in">bind</span>(&amp;ChatService::createGroup,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ADD_GROUP_MSG,<span class="built_in">bind</span>(&amp;ChatService::addGroup,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;GROUP_CHAT_MSG,<span class="built_in">bind</span>(&amp;ChatService::groupChat,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务器异常，业务重置方法</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//把online状态的用户，设置成offline</span></span><br><span class="line">    _userModel.<span class="built_in">resetState</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取id号</span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码 </span></span><br><span class="line"></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id); <span class="comment">//查找 这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getPassword</span>() == password) <span class="comment">//查出来了，登录成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>) <span class="comment">//该用户已经登录，不允许重复登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;this account is using,input another&quot;</span>;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串            </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//登录成功，记录用户连接信息，当多个用户登录时，都会操作这个_userConnMap</span></span><br><span class="line">            &#123;</span><br><span class="line">                lock_guard&lt;mutex&gt; <span class="built_in">lock</span>(_connMutex);</span><br><span class="line">                _userConnMap.<span class="built_in">insert</span>(&#123;id,conn&#125;);</span><br><span class="line">            &#125;<span class="comment">//加个作用域，出了这个右括号就自动解锁</span></span><br><span class="line"></span><br><span class="line">             <span class="comment">//登录成功，更新用户状态信息 state offline=&gt;online</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">&quot;online&quot;</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user); <span class="comment">//这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">            response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//查询该用户是否有离线消息</span></span><br><span class="line">            vector&lt;string&gt; vec = _offlineMsgModel.<span class="built_in">query</span>(id); <span class="comment">//查询用户ID</span></span><br><span class="line">            <span class="keyword">if</span>(!vec.<span class="built_in">empty</span>()) <span class="comment">//不为空</span></span><br><span class="line">            &#123;</span><br><span class="line">                response[<span class="string">&quot;offlinemsg&quot;</span>] = vec; <span class="comment">//json库可以和容器之间序列化和反序列化 </span></span><br><span class="line">                <span class="comment">//读取该用户的离线消息后，把该用户的所有离线消息删除掉</span></span><br><span class="line">                _offlineMsgModel.<span class="built_in">remove</span>(id);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//查询该用户的好友信息并返回</span></span><br><span class="line">            vector&lt;User&gt; userVec = _friendModel.<span class="built_in">query</span>(id);</span><br><span class="line">            <span class="keyword">if</span>(!userVec.<span class="built_in">empty</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                vector&lt;string&gt; vec2;</span><br><span class="line">                <span class="keyword">for</span>(User &amp;user:userVec)</span><br><span class="line">                &#123;</span><br><span class="line">                    json js;</span><br><span class="line">                    js[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">                    js[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">                    js[<span class="string">&quot;state&quot;</span>] = user.<span class="built_in">getState</span>();</span><br><span class="line">                    vec2.<span class="built_in">push_back</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">                &#125;</span><br><span class="line">                response[<span class="string">&quot;friends&quot;</span>] = vec2;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//查询该用户的群组信息并返回</span></span><br><span class="line">            vector&lt;Group&gt; groupuserVec = _groupModel.<span class="built_in">queryGroups</span>(id);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!groupuserVec.<span class="built_in">empty</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                vector&lt;string&gt; groupV;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(Group &amp;group:groupuserVec)</span><br><span class="line">                &#123;</span><br><span class="line">                    json grpjson;</span><br><span class="line">                    grpjson[<span class="string">&quot;id&quot;</span>] = group.<span class="built_in">getId</span>();</span><br><span class="line">                    grpjson[<span class="string">&quot;groupname&quot;</span>] = group.<span class="built_in">getName</span>();</span><br><span class="line">                    grpjson[<span class="string">&quot;groupdesc&quot;</span>] = group.<span class="built_in">getDesc</span>();</span><br><span class="line"></span><br><span class="line">                    vector&lt;string&gt; userV;</span><br><span class="line">                    <span class="keyword">for</span>(GroupUser &amp;user:group.<span class="built_in">getUsers</span>())</span><br><span class="line">                    &#123;</span><br><span class="line">                        json js;</span><br><span class="line">                        js[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">                        js[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">                        js[<span class="string">&quot;state&quot;</span>] = user.<span class="built_in">getState</span>();</span><br><span class="line">                        js[<span class="string">&quot;role&quot;</span>] = user.<span class="built_in">getRole</span>();</span><br><span class="line">                        userV.<span class="built_in">push_back</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">                    &#125;</span><br><span class="line">                    grpjson[<span class="string">&quot;users&quot;</span>] = userV;</span><br><span class="line">                    groupV.<span class="built_in">push_back</span>(grpjson.<span class="built_in">dump</span>());</span><br><span class="line">                &#125;</span><br><span class="line">                response[<span class="string">&quot;groups&quot;</span>] = groupV;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串 </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//该用户不存在，用户存在但是密码错误，登录失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;id or password is invalid&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];  <span class="comment">//获取名字 </span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码</span></span><br><span class="line"></span><br><span class="line">    User user;  <span class="comment">//创建用户对象 </span></span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_userModel.<span class="built_in">insert</span>(user)) <span class="comment">//插入成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册成功</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理客户端异常退出</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    User user;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> it = _userConnMap.<span class="built_in">begin</span>(); it != _userConnMap.<span class="built_in">end</span>();it++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(it-&gt;second == conn)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//从map表删除用户的链接信息</span></span><br><span class="line">                user.<span class="built_in">setId</span>(it-&gt;first);</span><br><span class="line">                _userConnMap.<span class="built_in">erase</span>(it);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新用户的状态信息</span></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        user.<span class="built_in">setState</span>(<span class="string">&quot;offline&quot;</span>);</span><br><span class="line">        _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理一对一聊天业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取本人的id号</span></span><br><span class="line">    <span class="type">int</span> toid = js[<span class="string">&quot;toid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取对方的id号</span></span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>; <span class="comment">//访问连接信息表，要保证线程安全 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(toid);  <span class="comment">//查找对方id号 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>()) <span class="comment">//找到了</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//toid在线，转发消息  服务器主动推送消息给toid用户</span></span><br><span class="line">            it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//toid不在线，存储离线消息</span></span><br><span class="line">    _offlineMsgModel.<span class="built_in">insert</span>(toid,js.<span class="built_in">dump</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加好友业务 格式： msgid id friendid</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::addFriend</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//当前用户的id </span></span><br><span class="line">    <span class="type">int</span> friendid = js[<span class="string">&quot;friendid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取对方的id号 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(friendid);  <span class="comment">//查找对方id号 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>()) <span class="comment">//找到了</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//toid在线，转发消息  服务器主动推送消息给friendid用户</span></span><br><span class="line">            it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储好友信息</span></span><br><span class="line">    _friendModel.<span class="built_in">insert</span>(userid,friendid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建群组业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::createGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//创建群的用户的id </span></span><br><span class="line">    string name = js[<span class="string">&quot;groupname&quot;</span>];</span><br><span class="line">    string desc = js[<span class="string">&quot;groupdesc&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储新创建的群组信息</span></span><br><span class="line">    Group group;</span><br><span class="line">    group.<span class="built_in">setName</span>(name);</span><br><span class="line">    group.<span class="built_in">setDesc</span>(desc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_groupModel.<span class="built_in">createGroup</span>(group))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//存储群组创建人信息</span></span><br><span class="line">        _groupModel.<span class="built_in">addGroup</span>(userid,group.<span class="built_in">getId</span>(),<span class="string">&quot;creator&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//加入群组业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::addGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    <span class="type">int</span> groupid = js[<span class="string">&quot;groupid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    _groupModel.<span class="built_in">addGroup</span>(userid,groupid,<span class="string">&quot;normal&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//群组聊天业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::groupChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    <span class="type">int</span> groupid = js[<span class="string">&quot;groupid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; useridVec = _groupModel.<span class="built_in">queryGroupUsers</span>(userid, groupid);</span><br><span class="line">    <span class="comment">//查询这个用户所在群组的其他用户id </span></span><br><span class="line"></span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;<span class="comment">//不允许其他人在map里面增删改查 </span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> id:useridVec)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(id);</span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            _offlineMsgModel.<span class="built_in">insert</span>(id,js.<span class="built_in">dump</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注销业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::loginout</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); </span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            _userConnMap.<span class="built_in">erase</span>(it);        </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">user</span><span class="params">(id,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;offline&quot;</span>)</span></span>;</span><br><span class="line">    _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>src&#x2F;client&#x2F;main.cpp</p>
<p>完成对注销函数的编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gruop.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;groupuser.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录当前登录用户的信息</span></span><br><span class="line">User g_currentUser;</span><br><span class="line"><span class="comment">// 记录当前用户朋友的信息</span></span><br><span class="line">vector&lt;User&gt; g_currentFriendList; </span><br><span class="line"><span class="comment">// 记录当前用户群组的信息</span></span><br><span class="line">vector&lt;Group&gt; g_currentGroupList;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取系统时间（聊天信息需要添加时间信息）</span></span><br><span class="line"><span class="function">string <span class="title">getCurrentTime</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">showCurrentUserData</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接收线程 控制台应用程序，接收用户的手动输入，用户不输入cin就阻塞住，所以要2个线程 </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">readTaskHandler</span><span class="params">(<span class="type">int</span> clientfd)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//显示主菜单</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainMenu</span><span class="params">(<span class="type">int</span> clientfd)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聊天客户端程序实现，main线程用作发送线程，子线程用作接受线程</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;command invalid example : ./ChatClient 127.0.0.1 6000&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建client端的socket</span></span><br><span class="line">    <span class="type">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM , <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == clientfd)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;socket create error&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">uint16_t</span> port = <span class="built_in">atoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//填写client需要连接的server信息ip+port</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serv;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv,<span class="number">0</span>,<span class="built_in">sizeof</span>(sockaddr_in));</span><br><span class="line">    serv.sin_family = AF_INET;</span><br><span class="line">    serv.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    serv.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client和server进行连接</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">connect</span>(clientfd,(<span class="type">const</span> sockaddr *)&amp;serv,<span class="built_in">sizeof</span>(sockaddr_in)))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect server error&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">close</span>(clientfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//main线程用于接受用户输入，负责发送数据</span></span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 显示首页面菜单 登录、注册、退出</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;========================&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;1.login&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;2.register&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;3.quit&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;========================&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;choice:&quot;</span>;</span><br><span class="line">        <span class="type">int</span> choice = <span class="number">0</span>;</span><br><span class="line">        cin &gt;&gt; choice;</span><br><span class="line">        cin.<span class="built_in">get</span>(); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (choice)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> id = <span class="number">0</span>;</span><br><span class="line">            <span class="type">char</span> password[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;userid:&quot;</span>;</span><br><span class="line">            cin &gt;&gt; id;</span><br><span class="line">            cin.<span class="built_in">get</span>();  <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;userpassword:&quot;</span>;</span><br><span class="line">            cin.<span class="built_in">getline</span>(password,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">            json js;</span><br><span class="line">            js[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG;</span><br><span class="line">            js[<span class="string">&quot;id&quot;</span>] = id;</span><br><span class="line">            js[<span class="string">&quot;password&quot;</span>] = password;</span><br><span class="line">            string request = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,request.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(request.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;send login msg error:&quot;</span> &lt;&lt; request &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">recv</span>(clientfd,buffer,<span class="number">1024</span>,<span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;recv login msg error&quot;</span> &lt;&lt; endl;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    json responsejs = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(<span class="number">0</span> != responsejs[<span class="string">&quot;errno&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;()) <span class="comment">//登录失败</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; responsejs[<span class="string">&quot;errmsg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="comment">//登录成功</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cout &lt;&lt; responsejs[<span class="string">&quot;errmsg&quot;</span>] &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 记录当前用户的id和name</span></span><br><span class="line">                        g_currentUser.<span class="built_in">setId</span>(responsejs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                        g_currentUser.<span class="built_in">setName</span>(responsejs[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 记录当前用户的好友列表信息</span></span><br><span class="line">                        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;friends&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            vector&lt;string&gt; vec = responsejs[<span class="string">&quot;friends&quot;</span>];</span><br><span class="line">                            <span class="keyword">for</span>(string &amp;str:vec)</span><br><span class="line">                            &#123;</span><br><span class="line">                                json js = json::<span class="built_in">parse</span>(str);</span><br><span class="line">                                User user;</span><br><span class="line">                                user.<span class="built_in">setId</span>(js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                                user.<span class="built_in">setName</span>(js[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">                                user.<span class="built_in">setState</span>(js[<span class="string">&quot;state&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                                g_currentFriendList.<span class="built_in">push_back</span>(user);</span><br><span class="line">                            &#125;  </span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;groups&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            vector&lt;string&gt; vec1 = responsejs[<span class="string">&quot;groups&quot;</span>];</span><br><span class="line">                            <span class="keyword">for</span>(string &amp;str1:vec1)</span><br><span class="line">                            &#123;</span><br><span class="line">                                json grpjs = json::<span class="built_in">parse</span>(str1);</span><br><span class="line">                                Group group;</span><br><span class="line">                                group.<span class="built_in">setId</span>(grpjs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                                group.<span class="built_in">setName</span>(grpjs[<span class="string">&quot;groupname&quot;</span>]);</span><br><span class="line">                                group.<span class="built_in">setDesc</span>(grpjs[<span class="string">&quot;groupdesc&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                                vector&lt;string&gt; vec2 = grpjs[<span class="string">&quot;users&quot;</span>];</span><br><span class="line">                                <span class="keyword">for</span>(string &amp;str2:vec2)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    json js = json::<span class="built_in">parse</span>(str2);</span><br><span class="line">                                    GroupUser user;</span><br><span class="line">                                    user.<span class="built_in">setId</span>(js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                                    user.<span class="built_in">setName</span>(js[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">                                    user.<span class="built_in">setState</span>(js[<span class="string">&quot;state&quot;</span>]);</span><br><span class="line">                                    user.<span class="built_in">setRole</span>(js[<span class="string">&quot;role&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                                    group.<span class="built_in">getUsers</span>().<span class="built_in">push_back</span>(user);</span><br><span class="line">                                &#125;</span><br><span class="line">                                g_currentGroupList.<span class="built_in">push_back</span>(group);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line">                        <span class="built_in">showCurrentUserData</span>();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;offlinemsg&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            vector&lt;string&gt; vec = responsejs[<span class="string">&quot;offlinemsg&quot;</span>];</span><br><span class="line">                            <span class="keyword">for</span>(string &amp;str: vec)</span><br><span class="line">                            &#123;</span><br><span class="line">                                json js = json::<span class="built_in">parse</span>(str);</span><br><span class="line">                                <span class="keyword">if</span>(ONE_CHAT_MSG == js[<span class="string">&quot;msgid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;())</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">                                    cout &lt;&lt; js[<span class="string">&quot;time&quot;</span>] &lt;&lt; <span class="string">&quot; [ &quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot; ] &quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] </span><br><span class="line">                                    &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span> <span class="keyword">if</span>(GROUP_CHAT_MSG == js[<span class="string">&quot;msgid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;())</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">                                    cout &lt;&lt; <span class="string">&quot;群消息[&quot;</span> &lt;&lt; js[<span class="string">&quot;groupid&quot;</span>] &lt;&lt; <span class="string">&quot;]:&quot;</span> &lt;&lt; js[<span class="string">&quot;time&quot;</span>] </span><br><span class="line">                                    &lt;&lt; <span class="string">&quot; [ &quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot; ]&quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] </span><br><span class="line">                                    &lt;&lt; endl;</span><br><span class="line">                                    <span class="keyword">continue</span>;             </span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;                            </span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//登陆成功，启动接受线程负责接受数据</span></span><br><span class="line">                        <span class="function">std::thread <span class="title">readTask</span><span class="params">(readTaskHandler,clientfd)</span></span>;</span><br><span class="line">                        readTask.<span class="built_in">detach</span>();</span><br><span class="line">                        <span class="comment">// 进入聊天主菜单页面</span></span><br><span class="line">                        <span class="built_in">mainMenu</span>(clientfd);                        </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;   </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cin.<span class="built_in">get</span>();</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;clear&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">char</span> name[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="type">char</span> password[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;name:&quot;</span> ;</span><br><span class="line">            cin.<span class="built_in">getline</span>(name,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;password:&quot;</span>;</span><br><span class="line">            cin.<span class="built_in">getline</span>(password,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">            json js;</span><br><span class="line">            js[<span class="string">&quot;msgid&quot;</span>] = REG_MSG;</span><br><span class="line">            js[<span class="string">&quot;name&quot;</span>] = name;</span><br><span class="line">            js[<span class="string">&quot;password&quot;</span>] = password;</span><br><span class="line">            string request = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,request.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(request.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;send reg msg error:&quot;</span> &lt;&lt; request &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="type">int</span> len = <span class="built_in">recv</span>(clientfd,buffer,<span class="number">1024</span>,<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">-1</span> == len)</span><br><span class="line">                &#123;</span><br><span class="line">                    cerr &lt;&lt; <span class="string">&quot;recv reg response error&quot;</span> &lt;&lt; endl;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> </span><br><span class="line">                &#123;</span><br><span class="line">                    json responsejs = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line">                    <span class="keyword">if</span>(<span class="number">0</span> != responsejs[<span class="string">&quot;errno&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;())</span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; name &lt;&lt; <span class="string">&quot; is already exist , register error !&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="comment">//注册成功</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        cerr &lt;&lt; <span class="string">&quot;register success , userid is &quot;</span> </span><br><span class="line">                        &lt;&lt; responsejs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;() &lt;&lt; </span><br><span class="line">                        <span class="string">&quot; , dot not forget it !&quot;</span> &lt;&lt; endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;     </span><br><span class="line">        &#125;</span><br><span class="line">        cin.<span class="built_in">get</span>();</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;clear&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">//quit业务</span></span><br><span class="line">            <span class="built_in">close</span>(clientfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">break</span>;            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;invalid input!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">showCurrentUserData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;======================login user======================&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;current login user =&gt; id:&quot;</span> &lt;&lt; g_currentUser.<span class="built_in">getId</span>() &lt;&lt; <span class="string">&quot; name:&quot;</span> </span><br><span class="line">    &lt;&lt; g_currentUser.<span class="built_in">getName</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;----------------------friend list---------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span>(!g_currentFriendList.<span class="built_in">empty</span>()) <span class="comment">//如果好友列表不为空</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(User &amp;user:g_currentFriendList)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;第&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;个好友信息:&quot;</span> &lt;&lt; user.<span class="built_in">getId</span>() </span><br><span class="line">            &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getState</span>() &lt;&lt; endl;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;----------------------group list---------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span>(!g_currentGroupList.<span class="built_in">empty</span>())<span class="comment">//群组信息不为空，才打印出来</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(Group &amp;group:g_currentGroupList)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; group.<span class="built_in">getId</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; group.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> </span><br><span class="line">            &lt;&lt; group.<span class="built_in">getDesc</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span>(GroupUser &amp;user:group.<span class="built_in">getUsers</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;第&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;个人信息:&quot;</span> &lt;&lt; user.<span class="built_in">getId</span>() </span><br><span class="line">                &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getState</span>() &lt;&lt; </span><br><span class="line">                <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getRole</span>() &lt;&lt; endl;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接受线程</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">readTaskHandler</span><span class="params">(<span class="type">int</span> clientfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">int</span> len = <span class="built_in">recv</span>(clientfd, buffer, <span class="number">1024</span> , <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == len || <span class="number">0</span> == len)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">close</span>(clientfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接受ChatServer转发的数据，反序列化生产json数据对象</span></span><br><span class="line">        json js = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line">        <span class="type">int</span> msgtype = js[<span class="string">&quot;msgid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">        <span class="keyword">if</span>(ONE_CHAT_MSG == msgtype)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">            cout &lt;&lt; js[<span class="string">&quot;time&quot;</span>] &lt;&lt; <span class="string">&quot; [ &quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot; ] &quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] </span><br><span class="line">            &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(GROUP_CHAT_MSG == msgtype)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;群消息[&quot;</span> &lt;&lt; js[<span class="string">&quot;groupid&quot;</span>] &lt;&lt; <span class="string">&quot;]:&quot;</span> &lt;&lt; js[<span class="string">&quot;time&quot;</span>] </span><br><span class="line">            &lt;&lt; <span class="string">&quot; [&quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot;]&quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] </span><br><span class="line">            &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;             </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;help&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">help</span><span class="params">(<span class="type">int</span> fd = <span class="number">0</span> , string str = <span class="string">&quot; &quot;</span>)</span></span>;</span><br><span class="line"><span class="comment">// &quot;chat&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">chat</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">// &quot;addfriend&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addfriend</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">// &quot;creategroup&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">creategroup</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">//&quot;addgroup&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addgroup</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">//&quot;groupchat&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">groupchat</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">//&quot;groupchat&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loginout</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统支持的客户端命令列表</span></span><br><span class="line">unordered_map&lt;string,string&gt; commandMap = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;help&quot;</span>,<span class="string">&quot;显示所有支持的命令,格式help&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,<span class="string">&quot;一对一聊天,格式chat:friendid:message&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addfriend&quot;</span>,<span class="string">&quot;添加好友,格式addfriend:friendid&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;creategroup&quot;</span>,<span class="string">&quot;创建群组,格式creategroup:groupname:groupdesc&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addgroup&quot;</span>,<span class="string">&quot;加入群组,格式addgroup:groupid&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;groupchat&quot;</span>, <span class="string">&quot;群聊,格式groupchat:groupid:message&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;loginout&quot;</span>, <span class="string">&quot;注销，格式loginout&quot;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册系统支持的客户端命令处理</span></span><br><span class="line">unordered_map&lt;string,function&lt;<span class="type">void</span>(<span class="type">int</span>,string)&gt;&gt; commandHandlerMap = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;help&quot;</span>,help&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,chat&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addfriend&quot;</span>,addfriend&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;creategroup&quot;</span>,creategroup&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addgroup&quot;</span>,addgroup&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;groupchat&quot;</span>,groupchat&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;loginout&quot;</span>,loginout&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;help&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">help</span><span class="params">(<span class="type">int</span>, string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;show command list &gt;&gt;&gt;&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;it:commandMap)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; it.first &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; it.second &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//主聊天页面程序，先显示一下系统支持的命令 </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainMenu</span><span class="params">(<span class="type">int</span> clientfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">help</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        cin.<span class="built_in">getline</span>(buffer, <span class="number">1024</span>);</span><br><span class="line">        <span class="function">string <span class="title">commandbuf</span><span class="params">(buffer)</span></span>;</span><br><span class="line">        string command;</span><br><span class="line">        <span class="type">int</span> idx = commandbuf.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == idx)</span><br><span class="line">        &#123;</span><br><span class="line">            command = commandbuf;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            command = commandbuf.<span class="built_in">substr</span>(<span class="number">0</span>,idx);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = commandHandlerMap.<span class="built_in">find</span>(command);</span><br><span class="line">        <span class="keyword">if</span>(it == commandHandlerMap.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;invalid command&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用相应命令的事件处理回调,mainMenu对修改封闭,添加新功能</span></span><br><span class="line">        it-&gt;<span class="built_in">second</span>(clientfd,commandbuf.<span class="built_in">substr</span>(idx+<span class="number">1</span>,commandbuf.<span class="built_in">size</span>()-idx));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;chat&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">chat</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> idx = str.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == idx)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;chat command invalid!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> friendid = <span class="built_in">atoi</span>((str.<span class="built_in">substr</span>(<span class="number">0</span>,idx)).<span class="built_in">c_str</span>());</span><br><span class="line">    string message = str.<span class="built_in">substr</span>(idx+<span class="number">1</span>,str.<span class="built_in">size</span>()-idx);</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = ONE_CHAT_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;name&quot;</span>] = g_currentUser.<span class="built_in">getName</span>();</span><br><span class="line">    js[<span class="string">&quot;toid&quot;</span>] = friendid;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>] = message;</span><br><span class="line">    js[<span class="string">&quot;time&quot;</span>] = <span class="built_in">getCurrentTime</span>();</span><br><span class="line"></span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send chat msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;addfriend&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addfriend</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> friendid = <span class="built_in">atoi</span>(str.<span class="built_in">c_str</span>());</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = ADD_FRIEND_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;friendid&quot;</span>] = friendid;</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == len)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send addfriend msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;creategroup&quot; command handler  groupname:groupdesc</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">creategroup</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> idx = str.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == idx)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;creategroup command invalid!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;        </span><br><span class="line">    &#125;</span><br><span class="line">    string groupname = str.<span class="built_in">substr</span>(<span class="number">0</span>,idx);</span><br><span class="line">    string groupdesc = str.<span class="built_in">substr</span>(idx+<span class="number">1</span>,str.<span class="built_in">size</span>()-idx);</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = CREATE_GROUP_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;groupname&quot;</span>] = groupname;</span><br><span class="line">    js[<span class="string">&quot;groupdesc&quot;</span>] = groupdesc;</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send creategroup msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;addgroup&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addgroup</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> groupid = <span class="built_in">atoi</span>(str.<span class="built_in">c_str</span>());</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = ADD_GROUP_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;groupid&quot;</span>] = groupid;</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send addgroup msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;groupchat&quot; command handler   groupid:message</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">groupchat</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> idx = str.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == idx)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;groupchat command invalid!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> groupid = <span class="built_in">atoi</span>((str.<span class="built_in">substr</span>(<span class="number">0</span>,idx)).<span class="built_in">c_str</span>());</span><br><span class="line">    string message = str.<span class="built_in">substr</span>(idx+<span class="number">1</span>,str.<span class="built_in">size</span>()-idx);</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = GROUP_CHAT_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;name&quot;</span>] = g_currentUser.<span class="built_in">getName</span>();</span><br><span class="line">    js[<span class="string">&quot;groupid&quot;</span>] = groupid;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>] = message;</span><br><span class="line">    js[<span class="string">&quot;time&quot;</span>] = <span class="built_in">getCurrentTime</span>();</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send groupchat msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;loginout&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loginout</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = LOGINOUT_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send groupchat msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取系统时间（聊天信息需要添加时间信息）</span></span><br><span class="line"><span class="function">string <span class="title">getCurrentTime</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> tt = std::chrono::system_clock::<span class="built_in">to_time_t</span>(std::chrono::system_clock::<span class="built_in">now</span>());</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> *ptm = <span class="built_in">localtime</span>(&amp;tt);</span><br><span class="line">    <span class="type">char</span> date[<span class="number">60</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(date, <span class="string">&quot;%d-%02d-%02d %02d:%02d:%02d&quot;</span>,</span><br><span class="line">            (<span class="type">int</span>)ptm-&gt;tm_year + <span class="number">1900</span>, (<span class="type">int</span>)ptm-&gt;tm_mon + <span class="number">1</span>, (<span class="type">int</span>)ptm-&gt;tm_mday,</span><br><span class="line">            (<span class="type">int</span>)ptm-&gt;tm_hour, (<span class="type">int</span>)ptm-&gt;tm_min, (<span class="type">int</span>)ptm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">string</span>(date);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="25-1-问题"><a href="#25-1-问题" class="headerlink" title="25.1 问题"></a>25.1 问题</h3><p><strong>1.登录之后发现不能进入主界面</strong></p>
<p>解决方法:增加一个全局变量来控制</p>
<p>控制主菜单页面程序  bool isMainMenuRunning &#x3D; false;</p>
<p><strong>2.注销之后，再登录会打印两次好友信息、群组消息</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/25-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><strong>解决方法：每次进入将好友和群组清空一下</strong></p>
<p><strong>3.第一次登录成功后会开启线程接受数据，注销之后，在登陆，又会开启新的线程</strong></p>
<p><strong>解决方法:使用静态局部变量进行控制</strong></p>
<p>编译，效果如下:</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/25-01(2).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/25-01(3).png" alt="本地png图片PictureTest.png"></p>
<h2 id="26-集群服务器为什么要引入负载均衡器"><a href="#26-集群服务器为什么要引入负载均衡器" class="headerlink" title="26 集群服务器为什么要引入负载均衡器"></a>26 集群服务器为什么要引入负载均衡器</h2><p>我们使用的socketfd本质上是文件描述符，默认大小是1024个，我们通过一个进程，使用limit调大，一台服务器在我们的32位的linux下并发量：2万左右的并发量，单台的chatserver支持2万左右的用户在线聊天，如果要支持3万，4万用户同时在线聊天就不可以了。如果我们想提供我们聊天服务器的并发能力，让更多的用户可以同时在线聊天，我们要进行集群部署。在水平方向上扩展多台主机，每一台主机运行着独立的chatserver，我们在下图中，引入了3台主机，每一台主机运行着独立的chatserver服务器，可以给用户提供聊天服务，但是，我们在用QQ客户端登录的时候，人家有没有问你想连哪个服务器？不能把选择服务器的决定扔给客户，客户又不知道哪个服务器空闲哪个服务器繁忙。所以，我们在集群聊天服务器，要引入负载均衡器，也叫做方向代理设备，帮我们统一接收客户端的请求，然后根据配置的既定的负载均衡算法，来把客户端的这些请分发到业务服务器chatserver上。</p>
<p>我们将使用nginx负载均衡器，nginx的TCP负载均衡模块可以轻松提供5-6万的并发量。我们一台nginx负载均衡器带上3台chatserver，能够马上把用户的并发量提升到5-6万。解决并发量最直接最简单的方法。如果要提供更大更大的并发量，也是有办法的：我们的负载均衡器本身也可以集群，前端再挂一个LVS（比较底层的负载均衡器）。负载均衡有业务层的负载均衡（业务分发），传输层的负载均衡（TCP,UDP），网络层的负载均衡（通过ip），数据链路层的负载均衡（数据帧）。LVS的并发量轻松到10多万。一台LVS带多台nginx就可以更大进行用户聊天的并发量。</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/26-01(1).png" alt="本地png图片PictureTest.png"></p>
<p>首先，用户在使用客户端的时候，不用去选择连接哪个服务器，客户端软件默认的连接负载均衡器，负载均衡器的角色相当于一个中间的桥梁，连接了客户端和服务器之间的通信，client1先发送请求到负载均衡器，负载均衡器根据配置的既定的负载算法，比如说轮询，按权重，按ip哈希等等，负载均衡器给client1的请求分发到了chatserver1上，相当于client1就登录到了chatserver1上。client2现在登录，通过负载算法，轮询，登录到了chatserver2上。再来client3登录的话，就登录到了chatserver3上。<br>就这样，分别注册到了3台服务器上。<br>这样的话，就有效地把不同的客户端用户分发到了不同的服务器上，一台32位的linux带2万，3台就是带6万并发量了。</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/26-01(2).png" alt="本地png图片PictureTest.png"></p>
<p>负载均衡器处理的3件事情如在上图中显示。<br>聊天服务器是长连接的业务，聊天的链路一直保持着。客户端的请求和服务器的响应都是要经过负载均衡器</p>
<p>也有的方法场景是：负载均衡只是做客户端请求的分发，分发了以后，服务器最终给客户端回复消息的时候是通过建立一条ip隧道，直接把请求响应给相应的客户端，因为负载均衡器可以把客户端的网络信息ip和port保存。关于心跳见我在基于RPC的分布式TCP通信框架项目的文章。</p>
<p>如果要再扩展一台设备。我们把这个设备的信息添加到负载均衡器上，然后再把负载均衡器重启一下，肯定是不行的，因为此时用户就不能使用了。但是nginx支持平滑启动，可以在不中断服务的前提下去加载配置文件，动态的识别新添加的服务信息。</p>
<h2 id="27-nginx的tcp负载均衡配置"><a href="#27-nginx的tcp负载均衡配置" class="headerlink" title="27 nginx的tcp负载均衡配置"></a>27 nginx的tcp负载均衡配置</h2><p>在服务器快速集群环境搭建中，都迫切需要一个能拿来即用的负载均衡器，nginx在1.9版本之前，只支持http协议web服务器的负载均衡，从1.9版本开始以后，</p>
<p>nginx开始支持tcp的长连接负载均衡，但是nginx默认并没有编译tcp负载均衡模块，编写它时，需要加入–with-stream参数来激活这个模块。</p>
<p>打开WinSCP，将<strong>nginx-1.12.2.tar.gz</strong>传送至服务器创建的目录，我的目录是&#x2F;home&#x2F;iot&#x2F;caiwei，进行解压</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -zxvf nginx-1.12.2.tar.gz</span><br><span class="line">su - root</span><br><span class="line">cd /home/iot/caiwei</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/27-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><strong>问题：</strong>出现.&#x2F;configure: error: the HTTP rewrite module requires the PCRE library</p>
<p><strong>解决方法：</strong>sudo apt-get install libpcre3 libpcre3-dev</p>
<p>make &amp;&amp; make Install</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/27-01(2).png" alt="本地png图片PictureTest.png"></p>
<p>编译完成后，默认安装在了&#x2F;usr&#x2F;local&#x2F;nginx目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /usr/local/nginx</span><br></pre></td></tr></table></figure>

<p><strong>我们进入配置文件，修改配置文件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#nginx tcp loadbalance config</span><br><span class="line">stream &#123;</span><br><span class="line">    upstream MyServer&#123;</span><br><span class="line">       server 127.0.0.1:6000 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">       server 127.0.0.1:6002 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     server &#123;</span><br><span class="line">     proxy_connect_timeout 1s;</span><br><span class="line">     #proxy_timeout 3s;</span><br><span class="line">     listen 8000;</span><br><span class="line">     proxy_pass MyServer;</span><br><span class="line">     tcp_nodelay on;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>nginx -s reload 重新加载配置文件启动</strong></p>
<p>我们写在http的上面<br>listen 8000；这个是nginx会监听的一个端口号，也就是说，所有的客户端连接指定的8000端口就可以，所有客户端发过来的请求在配置文件中，人家就写好了，你都连8000，客户端发的请求如果都在8000端口上，nginx感应到，你要我完成反向代理的操作，也就是负载均衡的操作，nginx就按照既定的负载均衡算法把这些请求分发到不同的服务器上。<br>proxy pass MyServer 相当于一个标记。<br>所有连接到8000端口的请求都连接到这个MyServer的信息里面负载均衡。<br>MyServer的这个upstream就是负载均衡模块，包含了几台机器呢？<br>包含了2台：127.0.0.1:6000，127.0.0.1.6002，相当于起了2台服务器，一个运行在6000端口，一个运行在6002端口。<br>weight&#x3D;1，就是权重，这2个服务器的权重都是1，就是说按照轮询算法，轮着往配置的服务器发，转着圈发送，<br>配置强的服务器，我们可以给它配置的权重大一些。<br>max_fails是在完成心跳机制，连续超过3次心跳失败，就认为服务器挂掉，fail_timeout，等心跳30秒。<br>如果要添加新的服务器，我们只需要在下面新增这台服务器的信息就可以了。<br>proxy_timeout 3s;是指nginx只和后端的chatserver连接3秒就断开，我们不加这个了。<br>proxy_connect_timeout的意思是nginx得连接后台的server服务器，第一次连接的时候发现超过1秒的时间还没有握手成功就判定连接失败了<br>tcp_nodelay on就是配置TCP的参数<br>listen 8000是让客户端都往8000端口发送数据，8000端口可以给你负载均衡，往MyServer负载均衡配置里面进行负载均衡<br>hash remote addr是另外一种基于哈希的负载算法，要单独安装插件</p>
<p><strong>启动nginx</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /usr/local/nginx/sbin/</span><br><span class="line">./nginx</span><br><span class="line">netstat -tanp</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/27-01(3).png" alt="本地png图片PictureTest.png"></p>
<p>如果要停止nginx，不能发kill 进程ID号，因为nginx有进程容错机制，当提供服务的进程挂掉了，会自动重启，是kill不完的。执行s-s stop关闭他。</p>
<p><strong>修改一下&#x2F;src&#x2F;server&#x2F;main.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatserver.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理服务器ctrl+c结束后，进行重置user的状态信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">resetHandler</span><span class="params">(<span class="type">int</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ChatService::<span class="built_in">instance</span>()-&gt;<span class="built_in">reset</span>(); <span class="comment">//调用重置 </span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;command invalid! example: ./ChatServer 127.0.0.1 6000&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析通过命令行参数传递的ip和port</span></span><br><span class="line">    <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = <span class="built_in">atoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">signal</span>(SIGINT,resetHandler);</span><br><span class="line"></span><br><span class="line">    EventLoop loop;  <span class="comment">//相当于像是创建了epoll</span></span><br><span class="line">    <span class="function">InetAddress <span class="title">addr</span><span class="params">(ip,port)</span></span>; <span class="comment">//IP地址，端口号</span></span><br><span class="line">    <span class="function">ChatServer <span class="title">server</span><span class="params">(&amp;loop,addr,<span class="string">&quot;ChatServer&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    server.<span class="built_in">start</span>();  <span class="comment">//listenfd通过 epoll_ctl 添加到 epoll </span></span><br><span class="line">    loop.<span class="built_in">loop</span>();    <span class="comment">//相当于epoll_wait，以阻塞方式等待新用户连接，已连接用户的读写事件等</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>重新编译一下，启动两台服务器</strong></p>
<p><strong>启动两个客户端</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/27-01(4).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/27-01(5).png" alt="本地png图片PictureTest.png"></p>
<p><strong>我们客户端的请求先发的nginx，nginx根据配置既定的负载均衡算法，把第一个请求转到第一台服务器，根据权重相等，轮询，下一个客户端连接到第二台服务器。</strong></p>
<h2 id="28-redis发布订阅消息队列代码编写和测试"><a href="#28-redis发布订阅消息队列代码编写和测试" class="headerlink" title="28 redis发布订阅消息队列代码编写和测试"></a>28 redis发布订阅消息队列代码编写和测试</h2><h3 id="28-1-编译安装hiredis"><a href="#28-1-编译安装hiredis" class="headerlink" title="28.1 编译安装hiredis"></a>28.1 编译安装hiredis</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/redis/hiredis</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/28-01(1).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/28-01(2).png" alt="本地png图片PictureTest.png"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">su - root</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/28-01(3).png" alt="本地png图片PictureTest.png"></p>
<h3 id="28-2-Redis发布订阅消息队列在项目上的代码实现"><a href="#28-2-Redis发布订阅消息队列在项目上的代码实现" class="headerlink" title="28.2 Redis发布订阅消息队列在项目上的代码实现"></a>28.2 Redis发布订阅消息队列在项目上的代码实现</h3><p><strong>我们在include下的server下创建文件夹：redis<br>我们在include的server的redis下创建文件：redis.hpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> REDIS_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REDIS_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hiredis/hiredis.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Redis</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Redis</span>();</span><br><span class="line">    ~<span class="built_in">Redis</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//连接redis服务器 </span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">connect</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//向redis指定的通道channel发布消息</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">publish</span><span class="params">(<span class="type">int</span> channel, string message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//向redis指定的通道subscribe订阅消息</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">subscribe</span><span class="params">(<span class="type">int</span> channel)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//向redis指定的通道unsubscribe取消订阅消息</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">unsubscribe</span><span class="params">(<span class="type">int</span> channel)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在独立线程中接收订阅通道中的消息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">observer_channel_message</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化向业务层上报通道消息的回调对象</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init_notify_handler</span><span class="params">(function&lt;<span class="type">void</span>(<span class="type">int</span>, string)&gt; fn)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//hiredis同步上下文对象，负责publish消息，相当于客户端一个redis-client </span></span><br><span class="line">    redisContext *_publish_context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//hiredis同步上下文对象，负责subscribe消息，相当于客户端一个redis-client ，</span></span><br><span class="line">	<span class="comment">// _publish和_subcribe不能在一个上下文处理 ,会阻塞 </span></span><br><span class="line">    redisContext *_subcribe_context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//回调操作，收到订阅的消息，给service层上报</span></span><br><span class="line">    function&lt;<span class="type">void</span>(<span class="type">int</span>, string)&gt; _notify_message_handler;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善一下项目工程chatserver下的CMakeLists.txt</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.10)</span><br><span class="line">project(chat)</span><br><span class="line"></span><br><span class="line"># 配置编译选项</span><br><span class="line">set(CMAKE_CXX_FLAGS $&#123;CMAKE_CXX_FLAGS&#125; -g)</span><br><span class="line"></span><br><span class="line"># 设置可执行文件最终存储的路径</span><br><span class="line">set(EXECUTABLE_OUTPUT_PATH $&#123;PROJECT_SOURCE_DIR&#125;/bin)</span><br><span class="line"></span><br><span class="line"># 配置头文件的搜索路径</span><br><span class="line">include_directories($&#123;PROJECT_SOURCE_DIR&#125;/include)</span><br><span class="line">include_directories($&#123;PROJECT_SOURCE_DIR&#125;/include/server)</span><br><span class="line">include_directories($&#123;PROJECT_SOURCE_DIR&#125;/thirdparty)</span><br><span class="line">include_directories($&#123;PROJECT_SOURCE_DIR&#125;/include/server/db)</span><br><span class="line">include_directories($&#123;PROJECT_SOURCE_DIR&#125;/include/server/model)</span><br><span class="line">include_directories($&#123;PROJECT_SOURCE_DIR&#125;/include/server/redis)</span><br><span class="line"></span><br><span class="line">add_subdirectory(src)</span><br></pre></td></tr></table></figure>

<p><strong>我们在src下的server下创建文件夹：redis<br>在src下的server下的redis下创建文件：redis.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;redis.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">Redis::<span class="built_in">Redis</span>() </span><br><span class="line">    : _publish_context(<span class="literal">nullptr</span>), _subcribe_context(<span class="literal">nullptr</span>)<span class="comment">//两个上下文指针 </span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Redis::~<span class="built_in">Redis</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_publish_context != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">redisFree</span>(_publish_context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_subcribe_context != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">redisFree</span>(_subcribe_context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Redis::connect</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//负责publish发布消息的上下文连接</span></span><br><span class="line">    _publish_context = <span class="built_in">redisConnect</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> == _publish_context)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect redis failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//负责subscribe订阅消息的上下文连接</span></span><br><span class="line">    _subcribe_context = <span class="built_in">redisConnect</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> == _subcribe_context)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect redis failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在单独的线程中，监听通道上的事件，有消息给业务层进行上报</span></span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">([&amp;]() &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        observer_channel_message();</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span></span>;</span><br><span class="line">    t.<span class="built_in">detach</span>();</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;connect redis-server success!&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//向redis指定的通道channel发布消息</span></span><br><span class="line"><span class="comment">//redisCommand先把命令缓存在本地，然后把命令发送到redis-server，然后阻塞等待命令的执行结果 </span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Redis::publish</span><span class="params">(<span class="type">int</span> channel, string message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    redisReply *reply = (redisReply *)<span class="built_in">redisCommand</span>(_publish_context, <span class="string">&quot;PUBLISH %d %s&quot;</span>, channel, message.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> == reply)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;publish command failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">freeReplyObject</span>(reply);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//向redis指定的通道subscribe订阅消息</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Redis::subscribe</span><span class="params">(<span class="type">int</span> channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//SUBSCRIBE命令本身会造成线程阻塞等待通道里面发生消息，这里只做订阅通道，不接收通道消息</span></span><br><span class="line">    <span class="comment">//通道消息的接收专门在observer_channel_message函数中的独立线程中进行</span></span><br><span class="line">    <span class="comment">//只负责发送命令，不阻塞接收redis server响应消息，否则和notifyMsg线程抢占响应资源</span></span><br><span class="line">    <span class="keyword">if</span> (REDIS_ERR == <span class="built_in">redisAppendCommand</span>(<span class="keyword">this</span>-&gt;_subcribe_context, <span class="string">&quot;SUBSCRIBE %d&quot;</span>, channel))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;subscribe command failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//redisBufferWrite可以循环发送缓冲区，直到缓冲区数据发送完毕（done被置为1）</span></span><br><span class="line">    <span class="type">int</span> done = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!done)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (REDIS_ERR == <span class="built_in">redisBufferWrite</span>(<span class="keyword">this</span>-&gt;_subcribe_context, &amp;done))</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;subscribe command failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//redisGetReply</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//向redis指定的通道unsubscribe取消订阅消息</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Redis::unsubscribe</span><span class="params">(<span class="type">int</span> channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (REDIS_ERR == <span class="built_in">redisAppendCommand</span>(<span class="keyword">this</span>-&gt;_subcribe_context, <span class="string">&quot;UNSUBSCRIBE %d&quot;</span>, channel))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;unsubscribe command failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//redisBufferWrite可以循环发送缓冲区，直到缓冲区数据发送完毕（done被置为1）</span></span><br><span class="line">    <span class="type">int</span> done = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!done)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (REDIS_ERR == <span class="built_in">redisBufferWrite</span>(<span class="keyword">this</span>-&gt;_subcribe_context, &amp;done))</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;unsubscribe command failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在独立线程中接收订阅通道中的消息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Redis::observer_channel_message</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    redisReply *reply = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">while</span> (REDIS_OK == <span class="built_in">redisGetReply</span>(<span class="keyword">this</span>-&gt;_subcribe_context, (<span class="type">void</span> **)&amp;reply))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//订阅收到的消息是一个带三元素的数组</span></span><br><span class="line">        <span class="keyword">if</span> (reply != <span class="literal">nullptr</span> &amp;&amp; reply-&gt;element[<span class="number">2</span>] != <span class="literal">nullptr</span> &amp;&amp; reply-&gt;element[<span class="number">2</span>]-&gt;str != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//给业务层上报通道上发生的消息</span></span><br><span class="line">            _notify_message_handler(<span class="built_in">atoi</span>(reply-&gt;element[<span class="number">1</span>]-&gt;str) , reply-&gt;element[<span class="number">2</span>]-&gt;str);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">freeReplyObject</span>(reply);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; observer_channel_message quit &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Redis::init_notify_handler</span><span class="params">(function&lt;<span class="type">void</span>(<span class="type">int</span>,string)&gt; fn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;_notify_message_handler = fn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>我们完善src下的server下的CMakeLists.txt</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 把当前路径下的所有源文件名字放入变量名SRC_LIST里面</span><br><span class="line">aux_source_directory(. SRC_LIST)</span><br><span class="line">aux_source_directory(./db DB_LIST)</span><br><span class="line">aux_source_directory(./model MODEL_LIST)</span><br><span class="line">aux_source_directory(./model REDIS_LIST)</span><br><span class="line"></span><br><span class="line"># 表示生成可执行文件ChatServer，由SRC_LIST变量所定义的源文件</span><br><span class="line">add_executable(ChatServer $&#123;SRC_LIST&#125; $&#123;DB_LIST&#125; $&#123;MODEL_LIST&#125; $&#123;REDIS_LIST&#125;)</span><br><span class="line"></span><br><span class="line"># 指定可执行文件链接时需要依赖的库文件</span><br><span class="line">target_link_libraries(ChatServer muduo_net muduo_base pthread mysqlclient hiredis)</span><br></pre></td></tr></table></figure>

<p><strong>我们完善include&#x2F;server&#x2F;chatservice.hpp</strong></p>
<p>增加redis类对象</p>
<p>增加对从redis消息队列中获取订阅消息函数的声明</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span> <span class="comment">//一个消息ID映射一个事件处理</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span> <span class="comment">//muduo的日志 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;offlinemsgmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;friendmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;groupmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;redis.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示处理消息的事件回调方法类型，事件处理器，派发3个东西 </span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//聊天服务器业务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//获取单例对象的接口函数</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService *<span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理登录业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理注册业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理一对一聊天业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取消息对应的处理器</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理客户端异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理服务器异常退出</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加好友业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addFriend</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建群组业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">createGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加入群组业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//群组聊天业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">groupChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//处理注销业务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">loginout</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从redis消息队列中获取订阅的消息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">handleRedisSubscribeMessage</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>(); <span class="comment">//单例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储在线用户的通信连接，用户的id， TcpConnectionPtr</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,TcpConnectionPtr&gt; _userConnMap;</span><br><span class="line">    <span class="comment">//存储消息id和其对应的业务处理方法，消息处理器的一个表，写消息id对应的处理操作 </span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>,MsgHandler&gt; _msgHandlerMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据操作类对象</span></span><br><span class="line">    UserModel _userModel;</span><br><span class="line">    OfflineMsgModel _offlineMsgModel;</span><br><span class="line">    FriendModel _friendModel;</span><br><span class="line">    GroupModel _groupModel;</span><br><span class="line">    <span class="comment">//定义互斥锁，保证_userConnMap的线程安全</span></span><br><span class="line">    mutex _connMutex;</span><br><span class="line">    <span class="comment">//redis操作对象</span></span><br><span class="line">    Redis _redis;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>

<p><strong>我们完善src&#x2F;server&#x2F;chatservice.cpp</strong></p>
<p>增加对从redis消息队列中获取订阅消息函数的编写</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">ChatService *<span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法，注册消息以及对应的Handler回调操作</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//用户基本业务管理相关事件处理回调注册</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG,<span class="built_in">bind</span>(&amp;ChatService::login,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGINOUT_MSG, std::<span class="built_in">bind</span>(&amp;ChatService::loginout, <span class="keyword">this</span>, _1, _2, _3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG,<span class="built_in">bind</span>(&amp;ChatService::reg,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ONE_CHAT_MSG,<span class="built_in">bind</span>(&amp;ChatService::oneChat,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ADD_FRIEND_MSG,<span class="built_in">bind</span>(&amp;ChatService::addFriend,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;CREATE_GROUP_MSG,<span class="built_in">bind</span>(&amp;ChatService::createGroup,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ADD_GROUP_MSG,<span class="built_in">bind</span>(&amp;ChatService::addGroup,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;GROUP_CHAT_MSG,<span class="built_in">bind</span>(&amp;ChatService::groupChat,<span class="keyword">this</span>,_1,_2,_3)&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//连接redis服务器</span></span><br><span class="line">    <span class="keyword">if</span> (_redis.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//设置上报消息的回调</span></span><br><span class="line">        _redis.<span class="built_in">init_notify_handler</span>(std::<span class="built_in">bind</span>(&amp;ChatService::handleRedisSubscribeMessage, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务器异常，业务重置方法</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//把online状态的用户，设置成offline</span></span><br><span class="line">    _userModel.<span class="built_in">resetState</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取消息对应的处理器</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记录错误日志，msgid没有对应的事件处理回调</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())<span class="comment">//找不到 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//返回一个默认的处理器，空操作，=按值获取 </span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid:&quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can not find handler!&quot;</span>;<span class="comment">//muduo日志会自动输出endl </span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//成功的话 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second; <span class="comment">//返回这个处理器 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理登录业务  id  pwd   pwd</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取id号</span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码 </span></span><br><span class="line"></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id); <span class="comment">//查找 这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getPassword</span>() == password) <span class="comment">//查出来了，登录成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>) <span class="comment">//该用户已经登录，不允许重复登录</span></span><br><span class="line">        &#123;</span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;this account is using,input another&quot;</span>;</span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串            </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//登录成功，记录用户连接信息，当多个用户登录时，都会操作这个_userConnMap</span></span><br><span class="line">            &#123;</span><br><span class="line">                lock_guard&lt;mutex&gt; <span class="built_in">lock</span>(_connMutex);</span><br><span class="line">                _userConnMap.<span class="built_in">insert</span>(&#123;id,conn&#125;);</span><br><span class="line">            &#125;<span class="comment">//加个作用域，出了这个右括号就自动解锁</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//id用户登录成功后，向redis订阅channel(id)</span></span><br><span class="line">            _redis.<span class="built_in">subscribe</span>(id); </span><br><span class="line"></span><br><span class="line">             <span class="comment">//登录成功，更新用户状态信息 state offline=&gt;online</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">&quot;online&quot;</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user); <span class="comment">//这里要完善usermodel.cpp usermodel.hpp</span></span><br><span class="line"></span><br><span class="line">            json response;</span><br><span class="line">            response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;登录成功&quot;</span>;</span><br><span class="line">            response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//查询该用户是否有离线消息</span></span><br><span class="line">            vector&lt;string&gt; vec = _offlineMsgModel.<span class="built_in">query</span>(id); <span class="comment">//查询用户ID</span></span><br><span class="line">            <span class="keyword">if</span>(!vec.<span class="built_in">empty</span>()) <span class="comment">//不为空</span></span><br><span class="line">            &#123;</span><br><span class="line">                response[<span class="string">&quot;offlinemsg&quot;</span>] = vec; <span class="comment">//json库可以和容器之间序列化和反序列化 </span></span><br><span class="line">                <span class="comment">//读取该用户的离线消息后，把该用户的所有离线消息删除掉</span></span><br><span class="line">                _offlineMsgModel.<span class="built_in">remove</span>(id);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//查询该用户的好友信息并返回</span></span><br><span class="line">            vector&lt;User&gt; userVec = _friendModel.<span class="built_in">query</span>(id);</span><br><span class="line">            <span class="keyword">if</span>(!userVec.<span class="built_in">empty</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                vector&lt;string&gt; vec2;</span><br><span class="line">                <span class="keyword">for</span>(User &amp;user:userVec)</span><br><span class="line">                &#123;</span><br><span class="line">                    json js;</span><br><span class="line">                    js[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">                    js[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">                    js[<span class="string">&quot;state&quot;</span>] = user.<span class="built_in">getState</span>();</span><br><span class="line">                    vec2.<span class="built_in">push_back</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">                &#125;</span><br><span class="line">                response[<span class="string">&quot;friends&quot;</span>] = vec2;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//查询该用户的群组信息并返回</span></span><br><span class="line">            vector&lt;Group&gt; groupuserVec = _groupModel.<span class="built_in">queryGroups</span>(id);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!groupuserVec.<span class="built_in">empty</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                vector&lt;string&gt; groupV;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(Group &amp;group:groupuserVec)</span><br><span class="line">                &#123;</span><br><span class="line">                    json grpjson;</span><br><span class="line">                    grpjson[<span class="string">&quot;id&quot;</span>] = group.<span class="built_in">getId</span>();</span><br><span class="line">                    grpjson[<span class="string">&quot;groupname&quot;</span>] = group.<span class="built_in">getName</span>();</span><br><span class="line">                    grpjson[<span class="string">&quot;groupdesc&quot;</span>] = group.<span class="built_in">getDesc</span>();</span><br><span class="line"></span><br><span class="line">                    vector&lt;string&gt; userV;</span><br><span class="line">                    <span class="keyword">for</span>(GroupUser &amp;user:group.<span class="built_in">getUsers</span>())</span><br><span class="line">                    &#123;</span><br><span class="line">                        json js;</span><br><span class="line">                        js[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">                        js[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">                        js[<span class="string">&quot;state&quot;</span>] = user.<span class="built_in">getState</span>();</span><br><span class="line">                        js[<span class="string">&quot;role&quot;</span>] = user.<span class="built_in">getRole</span>();</span><br><span class="line">                        userV.<span class="built_in">push_back</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">                    &#125;</span><br><span class="line">                    grpjson[<span class="string">&quot;users&quot;</span>] = userV;</span><br><span class="line">                    groupV.<span class="built_in">push_back</span>(grpjson.<span class="built_in">dump</span>());</span><br><span class="line">                &#125;</span><br><span class="line">                response[<span class="string">&quot;groups&quot;</span>] = groupV;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串 </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//该用户不存在，用户存在但是密码错误，登录失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;id or password is invalid&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注册业务  name  password</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];  <span class="comment">//获取名字 </span></span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];  <span class="comment">//获取密码</span></span><br><span class="line"></span><br><span class="line">    User user;  <span class="comment">//创建用户对象 </span></span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_userModel.<span class="built_in">insert</span>(user)) <span class="comment">//插入成功 </span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册成功</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//注册失败</span></span><br><span class="line">        json response;</span><br><span class="line">        response[<span class="string">&quot;msgid:&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>()); <span class="comment">//回调 ，返回json字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理客户端异常退出</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    User user;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> it = _userConnMap.<span class="built_in">begin</span>(); it != _userConnMap.<span class="built_in">end</span>();it++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(it-&gt;second == conn)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//从map表删除用户的链接信息</span></span><br><span class="line">                user.<span class="built_in">setId</span>(it-&gt;first);</span><br><span class="line">                _userConnMap.<span class="built_in">erase</span>(it);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户注销，相当于就是下线，在redis中取消订阅通道</span></span><br><span class="line">    _redis.<span class="built_in">unsubscribe</span>(user.<span class="built_in">getId</span>()); </span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新用户的状态信息</span></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        user.<span class="built_in">setState</span>(<span class="string">&quot;offline&quot;</span>);</span><br><span class="line">        _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理一对一聊天业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> toid = js[<span class="string">&quot;toid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取对方的id号</span></span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>; <span class="comment">//访问连接信息表，要保证线程安全 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(toid);  <span class="comment">//查找对方id号 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>()) <span class="comment">//找到了</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//toid在线，转发消息  服务器主动推送消息给toid用户</span></span><br><span class="line">            it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询toid是否在线 </span></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(toid);</span><br><span class="line">    <span class="keyword">if</span> (user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        _redis.<span class="built_in">publish</span>(toid, js.<span class="built_in">dump</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//toid不在线，存储离线消息</span></span><br><span class="line">    _offlineMsgModel.<span class="built_in">insert</span>(toid,js.<span class="built_in">dump</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加好友业务 格式： msgid id friendid</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::addFriend</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,json &amp;js,Timestamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//当前用户的id </span></span><br><span class="line">    <span class="type">int</span> friendid = js[<span class="string">&quot;friendid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//获取对方的id号 </span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(friendid);  <span class="comment">//查找对方id号 </span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>()) <span class="comment">//找到了</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//toid在线，转发消息  服务器主动推送消息给friendid用户</span></span><br><span class="line">            it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储好友信息</span></span><br><span class="line">    _friendModel.<span class="built_in">insert</span>(userid,friendid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建群组业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::createGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); <span class="comment">//创建群的用户的id </span></span><br><span class="line">    string name = js[<span class="string">&quot;groupname&quot;</span>];</span><br><span class="line">    string desc = js[<span class="string">&quot;groupdesc&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储新创建的群组信息</span></span><br><span class="line">    Group group;</span><br><span class="line">    group.<span class="built_in">setName</span>(name);</span><br><span class="line">    group.<span class="built_in">setDesc</span>(desc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_groupModel.<span class="built_in">createGroup</span>(group))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//存储群组创建人信息</span></span><br><span class="line">        _groupModel.<span class="built_in">addGroup</span>(userid,group.<span class="built_in">getId</span>(),<span class="string">&quot;creator&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//加入群组业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::addGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    <span class="type">int</span> groupid = js[<span class="string">&quot;groupid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    _groupModel.<span class="built_in">addGroup</span>(userid,groupid,<span class="string">&quot;normal&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//群组聊天业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::groupChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    <span class="type">int</span> groupid = js[<span class="string">&quot;groupid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; useridVec = _groupModel.<span class="built_in">queryGroupUsers</span>(userid, groupid);</span><br><span class="line">    <span class="comment">//查询这个用户所在群组的其他用户id </span></span><br><span class="line"></span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;<span class="comment">//不允许其他人在map里面增删改查 </span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> id:useridVec)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(id);</span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//查询toid是否在线 </span></span><br><span class="line">            User user = _userModel.<span class="built_in">query</span>(id);</span><br><span class="line">            <span class="keyword">if</span> (user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _redis.<span class="built_in">publish</span>(id, js.<span class="built_in">dump</span>());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//存储离线群消息</span></span><br><span class="line">                _offlineMsgModel.<span class="built_in">insert</span>(id, js.<span class="built_in">dump</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理注销业务</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::loginout</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(); </span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(userid);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(it != _userConnMap.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            _userConnMap.<span class="built_in">erase</span>(it);        </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户注销，相当于就是下线，在redis中取消订阅通道</span></span><br><span class="line">    _redis.<span class="built_in">unsubscribe</span>(userid);</span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">user</span><span class="params">(userid,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;offline&quot;</span>)</span></span>;</span><br><span class="line">    _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//从redis消息队列中获取订阅的消息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::handleRedisSubscribeMessage</span><span class="params">(<span class="type">int</span> userid, string msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> it = _userConnMap.<span class="built_in">find</span>(userid);</span><br><span class="line">    <span class="comment">//防止在找的过程，它下线了，就储存在离线表内</span></span><br><span class="line">    <span class="keyword">if</span> (it != _userConnMap.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        it-&gt;second-&gt;<span class="built_in">send</span>(msg);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储该用户的离线消息</span></span><br><span class="line">    _offlineMsgModel.<span class="built_in">insert</span>(userid, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="28-3-编译测试"><a href="#28-3-编译测试" class="headerlink" title="28.3 编译测试"></a>28.3 编译测试</h3><p><strong>写一个脚本文件build.sh</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">rm CMakeCache.txt</span><br><span class="line">rm Makefile</span><br><span class="line">rm cmake_install.cmake</span><br><span class="line">rm -r CMakeFiles</span><br><span class="line">rm ./src/Makefile</span><br><span class="line">rm ./src/cmake_install.cmake</span><br><span class="line">rm -r ./src/CMakeFiles</span><br><span class="line">rm ./src/server/Makefile</span><br><span class="line">rm ./src/server/cmake_install.cmake</span><br><span class="line">rm -r ./src/server/CMakeFiles</span><br><span class="line"></span><br><span class="line">cmake .</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p><strong>编译</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/28-01(4).png" alt="本地png图片PictureTest.png"></p>
<p><strong>启动两个服务器</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/28-01(5).png" alt="本地png图片PictureTest.png"></p>
<h2 id="29-github管理项目"><a href="#29-github管理项目" class="headerlink" title="29 github管理项目"></a>29 github管理项目</h2><p><strong>首先在本地产生chatserver</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone git@github.com:keaixiaocai/chatserver.git</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/29-01(1).png" alt="本地png图片PictureTest.png"></p>
<p>会出现以上的错误</p>
<p><strong>解决方法:</strong></p>
<p><strong>第一步：创建SSH Key pair</strong></p>
<p>输入ssh-keygen</p>
<p>提示输入秘钥名字和密码，为了方便起见，我这里选择不填</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/29-01(2).png" alt="本地png图片PictureTest.png"></p>
<p>可以看到秘钥生成在<code>/home/iot/.ssh这个地方，文件名为</code>id_rsa.pub&#96;</p>
<p>我们把这个文件的内容复制一下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh-rsa </span><br><span class="line">AAAAB3NzaC1yc2EAAAADAQABAAABAQDCCXsYW3fq6DUYZJtxPg6VjX51V9Pc5nFWWQMIHhnrFwDm96++CU5X4nX8zrT06Kbj0nSjTjf/9+5V9kk</span><br><span class="line">z4oibGl3Pb0IUlt/VkkE8qgfGEzJdBVlXA/ZZ55VEgyZ+c217lCyQg6afrojj0pElN0yYNOl4J2LDSjpHFgo3RBF4zvPOkE+Q5sRyyXqMwlBeLXqlGJVC7G</span><br><span class="line">AFUP/xUcycI7ZPd1PNF8FS2yfyg8P5nY34Uycltwc2Mn0PMYgqfRUtOxlHWbNJbxduqpht01IzGkZGD0m55Pq+/p4KudzDT/so3iGg2NMyDu+KYqgHCKWyC</span><br><span class="line">2SsQvT/UXTO6XNTpoijcgkj iot@ANT</span><br></pre></td></tr></table></figure>

<p><strong>第二步：将SSH key添加到Github账户</strong></p>
<p>在github点击头像-&gt;setting</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/29-01(3).png" alt="本地png图片PictureTest.png"></p>
<p><strong>点击SSH and GPG keys</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/29-01(4).png" alt="本地png图片PictureTest.png"></p>
<p><strong>点击New SSH key</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/29-01(5).png" alt="本地png图片PictureTest.png"></p>
<p><strong>把刚刚复制的秘钥粘贴到Key里面</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/29-01(6).png" alt="本地png图片PictureTest.png"></p>
<p>然后再输入命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone git@github.com:keaixiaocai/chatserver.git</span><br><span class="line">git status</span><br><span class="line">git add .</span><br><span class="line">git commit -m &quot;提交所有项目代码&quot;</span><br></pre></td></tr></table></figure>

<p><strong>出现以下问题:</strong></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/29-01(7).png" alt="本地png图片PictureTest.png"></p>
<p><strong>解决方法:</strong></p>
<p>我们进入.git目录下，将配置文件添加以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[user]</span><br><span class="line">	email = 1819117719@qq.com</span><br><span class="line">	name = caiwei</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/29-01(8).png" alt="本地png图片PictureTest.png"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">然后输入git commit -m &quot;提交所有项目代码&quot;</span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/29-01(9).png" alt="本地png图片PictureTest.png"></p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/29-01(10).png" alt="本地png图片PictureTest.png"></p>
<h2 id="30-客户端注销问题"><a href="#30-客户端注销问题" class="headerlink" title="30 客户端注销问题"></a>30 客户端注销问题</h2><h3 id="30-1-找出问题"><a href="#30-1-找出问题" class="headerlink" title="30.1 找出问题"></a>30.1 找出问题</h3><p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/30-01(1).png" alt="本地png图片PictureTest.png"></p>
<p>客户端注销后再次登录，失败了。</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/30-01(2).png" alt="本地png图片PictureTest.png"></p>
<p>gdb attach 4207</p>
<p>info threads</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/30-01(3).png" alt="本地png图片PictureTest.png"></p>
<p>我们的客户端有2个线程：一个专门读（主线程，接收客户端用户的输入，然后发送），一个专门写（子线程，<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=recv&spm=1001.2101.3001.7020">recv</a>接收，打印信息）<br>但是，我们现在看到，这2个线程都在recv</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/30-01(4).png" alt="本地png图片PictureTest.png"></p>
<p>主线程阻塞在这里：</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/30-01(5).png" alt="本地png图片PictureTest.png"></p>
<p>很明显，我们的子线程也在recv上，</p>
<p>thread 2</p>
<p>bt</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/30-01(6).png" alt="本地png图片PictureTest.png"></p>
<p>我们看到，子线程也阻塞在recv</p>
<p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/30-01(7).png" alt="本地png图片PictureTest.png"></p>
<p>也就是说，现在的现象是：客户端刚才登录成功，然后注销退出，然后重新登录，客户端没反应了。我们是通过gdb attach到正在运行的进程上，大致的看所有的线程和线程调用堆栈的详细信息，就可以知道现在的任务是阻塞在哪里了。现在的情况是：接收线程（读线程）现在在recv处阻塞了，主线程（写线程）也是在它对应的recv处阻塞了。我们刚开始进行登录的时候，打包了登录的json包数据发送到服务器，然后就在recv处阻塞，等待服务器对登录的消息进行响应，客户端得到响应后，对发送过来的json数据进行反序列化。拿到相应的字段进行业务的处理，然后启动子线程，登录成功后，把读线程启动,进入mainMenu，进行登录时的信息的打印然后现在注销了，并没有把子线程关闭掉，注销以后，我们再进行登录的时候，主线程去send，send后主线程马上recv，子线程此时也在recv，因为子线程的代码是无限的for循环，不断的recv。实际上，我们是想要主线程发的登录消息，由主线程去接收它的响应，接收了以后就不会阻塞了，就继续向下执行，但是，第二次send的时候，由于子线程抢到了recv，因为主线程和子线程都是处理的是同一个clientfd，子线程把这个数据recv了，但是子线程的代码没有相应的消息类型的处理啊，子线程只有单聊和群聊的消息类型的操作，然后子线程转了一圈，又阻塞在recv了，而主线程在recv登录的响应，却被子线程接收了，所以导致主线程的recv并没有接收到任何响应，一直阻塞住。</p>
<h3 id="30-2-改进代码"><a href="#30-2-改进代码" class="headerlink" title="30.2 改进代码"></a>30.2 改进代码</h3><p>彻底的把线程的接收分离开。<br>主线程：发送线程<br>子线程：接收线程<br>我们把客户端创建socket，connect服务器成功以后，我们就把子线程启动，而不是等登录之后才启动子线程。<br>TCP连接都创建成功了，就把子线程启动就好了，子线程专门做for无限循环做recv接收服务器的响应消息，专门做读操作。<br>然后主线程进来首界面（1登录，2注册，3退出）<br>主线程做的事情是：登录：提醒用户输入id和密码。打包数据进行json的序列化，然后send，通过网络发送到服务器，服务器响应，统一是由子线程进行接收，子线程接收响应消息的时候可以根据消息的类型识别这是登录的响应消息，主线程在send以后，应该等一等：等待登录是成功还是登录失败，这是在子线程进行判断的，所以，我们要添加通知机制，主线程（发送线程）send之后要进行等待，然后子线程来recv接收这个登录的响应消息，然后根据登录的响应消息：成功或者失败，去写一些标志，然后通过信号量，告诉主线程，（线程间的通信），然后主线程继续往下走，通过一个变量判断登录成功还是失败，登录失败的话，继续转到首界面，登录成功的话，转到主界面。<br><img src="/img/loading.gif" data-original="E:/蔡伟/14-笔记/图片/6-基于muduo网络库的集群服务器项目/30-01(8).png" alt="本地png图片PictureTest.png"></p>
<p>C++11提供了互斥锁和条件变量，但是没有提供信号量，所以我们使用Linux原生的pthread库的信号量<br>除了增加信号量（负责通知主线程，子线程已经把响应处理完了），我们还要增加一个标志（登录成功还是失败），这个标志变量定义成原子类型（C++11 CAS，自带volitale属性），因为在2个线程中要使用。</p>
<p>修改&#x2F;src&#x2F;client&#x2F;main.cpp</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;gruop.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录当前登录用户的信息</span></span><br><span class="line">User g_currentUser;</span><br><span class="line"><span class="comment">// 记录当前用户朋友的信息</span></span><br><span class="line">vector&lt;User&gt; g_currentFriendList; </span><br><span class="line"><span class="comment">// 记录当前用户群组的信息</span></span><br><span class="line">vector&lt;Group&gt; g_currentGroupList;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取系统时间（聊天信息需要添加时间信息）</span></span><br><span class="line"><span class="function">string <span class="title">getCurrentTime</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">showCurrentUserData</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//接收线程 控制台应用程序，接收用户的手动输入，用户不输入cin就阻塞住，所以要2个线程 </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">readTaskHandler</span><span class="params">(<span class="type">int</span> clientfd)</span></span>;</span><br><span class="line"><span class="comment">//显示主菜单</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainMenu</span><span class="params">(<span class="type">int</span> clientfd)</span></span>;</span><br><span class="line"><span class="comment">//控制主菜单页面程序</span></span><br><span class="line"><span class="type">bool</span> isMainMenuRunning = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用于读写线程之间的通信</span></span><br><span class="line"><span class="type">sem_t</span> rwsem;</span><br><span class="line"><span class="comment">//记录登录状态</span></span><br><span class="line">atomic_bool g_isLoginSuccess&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聊天客户端程序实现，main线程用作发送线程，子线程用作接受线程</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;command invalid example : ./ChatClient 127.0.0.1 6000&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建client端的socket</span></span><br><span class="line">    <span class="type">int</span> clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM , <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == clientfd)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;socket create error&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">uint16_t</span> port = <span class="built_in">atoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//填写client需要连接的server信息ip+port</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serv;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv,<span class="number">0</span>,<span class="built_in">sizeof</span>(sockaddr_in));</span><br><span class="line">    serv.sin_family = AF_INET;</span><br><span class="line">    serv.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    serv.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client和server进行连接</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">connect</span>(clientfd,(<span class="type">const</span> sockaddr *)&amp;serv,<span class="built_in">sizeof</span>(sockaddr_in)))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect server error&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">close</span>(clientfd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化读写线程通信用的信号量</span></span><br><span class="line">    <span class="built_in">sem_init</span>(&amp;rwsem, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接服务器成功，启动接收子线程</span></span><br><span class="line">    <span class="function">std::thread <span class="title">readTask</span><span class="params">(readTaskHandler, clientfd)</span></span>; <span class="comment">// pthread_create</span></span><br><span class="line">    readTask.<span class="built_in">detach</span>();                               <span class="comment">// pthread_detach</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//main线程用于接受用户输入，负责发送数据</span></span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 显示首页面菜单 登录、注册、退出</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;========================&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;1.login&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;2.register&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;3.quit&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;========================&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;choice:&quot;</span>;</span><br><span class="line">        <span class="type">int</span> choice = <span class="number">0</span>;</span><br><span class="line">        cin &gt;&gt; choice;</span><br><span class="line">        cin.<span class="built_in">get</span>(); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (choice)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> id = <span class="number">0</span>;</span><br><span class="line">            <span class="type">char</span> password[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;userid:&quot;</span>;</span><br><span class="line">            cin &gt;&gt; id;</span><br><span class="line">            cin.<span class="built_in">get</span>();  <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;userpassword:&quot;</span>;</span><br><span class="line">            cin.<span class="built_in">getline</span>(password,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">            json js;</span><br><span class="line">            js[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG;</span><br><span class="line">            js[<span class="string">&quot;id&quot;</span>] = id;</span><br><span class="line">            js[<span class="string">&quot;password&quot;</span>] = password;</span><br><span class="line">            string request = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">            g_isLoginSuccess = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,request.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(request.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;send login msg error:&quot;</span> &lt;&lt; request &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">sem_wait</span>(&amp;rwsem); <span class="comment">// 等待信号量，由子线程处理完登录的响应消息后，通知这里</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(g_isLoginSuccess)</span><br><span class="line">            &#123;</span><br><span class="line">                isMainMenuRunning = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// 进入聊天主菜单页面</span></span><br><span class="line">                <span class="built_in">mainMenu</span>(clientfd);</span><br><span class="line">            &#125;       </span><br><span class="line">        &#125;</span><br><span class="line">        cin.<span class="built_in">get</span>();</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;clear&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">char</span> name[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="type">char</span> password[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;name:&quot;</span> ;</span><br><span class="line">            cin.<span class="built_in">getline</span>(name,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;password:&quot;</span>;</span><br><span class="line">            cin.<span class="built_in">getline</span>(password,<span class="number">50</span>); <span class="comment">//读掉缓冲区残留的回车</span></span><br><span class="line"></span><br><span class="line">            json js;</span><br><span class="line">            js[<span class="string">&quot;msgid&quot;</span>] = REG_MSG;</span><br><span class="line">            js[<span class="string">&quot;name&quot;</span>] = name;</span><br><span class="line">            js[<span class="string">&quot;password&quot;</span>] = password;</span><br><span class="line">            string request = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,request.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(request.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                cerr &lt;&lt; <span class="string">&quot;send reg msg error:&quot;</span> &lt;&lt; request &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">sem_wait</span>(&amp;rwsem); <span class="comment">// 等待信号量，子线程处理完注册消息会通知     </span></span><br><span class="line">        &#125;</span><br><span class="line">        cin.<span class="built_in">get</span>();</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;clear&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">//quit业务</span></span><br><span class="line">            <span class="built_in">close</span>(clientfd);</span><br><span class="line">            <span class="built_in">sem_destroy</span>(&amp;rwsem);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">break</span>;            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;invalid input!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">showCurrentUserData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;======================login user======================&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;current login user =&gt; id:&quot;</span> &lt;&lt; g_currentUser.<span class="built_in">getId</span>() &lt;&lt; <span class="string">&quot; name:&quot;</span> </span><br><span class="line">    &lt;&lt; g_currentUser.<span class="built_in">getName</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;----------------------friend list---------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span>(!g_currentFriendList.<span class="built_in">empty</span>()) <span class="comment">//如果好友列表不为空</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(User &amp;user:g_currentFriendList)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;第&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;个好友信息:&quot;</span> &lt;&lt; user.<span class="built_in">getId</span>() </span><br><span class="line">            &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getState</span>() &lt;&lt; endl;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;----------------------group list---------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span>(!g_currentGroupList.<span class="built_in">empty</span>())<span class="comment">//群组信息不为空，才打印出来</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(Group &amp;group:g_currentGroupList)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; group.<span class="built_in">getId</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; group.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> </span><br><span class="line">            &lt;&lt; group.<span class="built_in">getDesc</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span>(GroupUser &amp;user:group.<span class="built_in">getUsers</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;第&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;个人信息:&quot;</span> &lt;&lt; user.<span class="built_in">getId</span>() </span><br><span class="line">                &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getState</span>() &lt;&lt; </span><br><span class="line">                <span class="string">&quot; &quot;</span> &lt;&lt; user.<span class="built_in">getRole</span>() &lt;&lt; endl;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理注册的响应逻辑</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doRegResponse</span><span class="params">(json &amp;responsejs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> != responsejs[<span class="string">&quot;errno&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;())</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;name is already exist , register error !&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//注册成功</span></span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;name register success , userid is &quot;</span> </span><br><span class="line">        &lt;&lt; responsejs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;() &lt;&lt; </span><br><span class="line">        <span class="string">&quot; , dot not forget it !&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 处理登录的响应逻辑</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doLoginResponse</span><span class="params">(json &amp;responsejs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> != responsejs[<span class="string">&quot;errno&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;()) <span class="comment">//登录失败</span></span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; responsejs[<span class="string">&quot;errmsg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">        g_isLoginSuccess = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//登录成功</span></span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; responsejs[<span class="string">&quot;errmsg&quot;</span>] &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录当前用户的id和name</span></span><br><span class="line">        g_currentUser.<span class="built_in">setId</span>(responsejs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">        g_currentUser.<span class="built_in">setName</span>(responsejs[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录当前用户的好友列表信息</span></span><br><span class="line">        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;friends&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            g_currentFriendList.<span class="built_in">clear</span>();</span><br><span class="line">            vector&lt;string&gt; vec = responsejs[<span class="string">&quot;friends&quot;</span>];</span><br><span class="line">            <span class="keyword">for</span>(string &amp;str:vec)</span><br><span class="line">            &#123;</span><br><span class="line">                json js = json::<span class="built_in">parse</span>(str);</span><br><span class="line">                User user;</span><br><span class="line">                user.<span class="built_in">setId</span>(js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                user.<span class="built_in">setName</span>(js[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">                user.<span class="built_in">setState</span>(js[<span class="string">&quot;state&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                g_currentFriendList.<span class="built_in">push_back</span>(user);</span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;groups&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            g_currentGroupList.<span class="built_in">clear</span>();</span><br><span class="line">            vector&lt;string&gt; vec1 = responsejs[<span class="string">&quot;groups&quot;</span>];</span><br><span class="line">            <span class="keyword">for</span>(string &amp;str1:vec1)</span><br><span class="line">            &#123;</span><br><span class="line">                json grpjs = json::<span class="built_in">parse</span>(str1);</span><br><span class="line">                Group group;</span><br><span class="line">                group.<span class="built_in">setId</span>(grpjs[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                group.<span class="built_in">setName</span>(grpjs[<span class="string">&quot;groupname&quot;</span>]);</span><br><span class="line">                group.<span class="built_in">setDesc</span>(grpjs[<span class="string">&quot;groupdesc&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                vector&lt;string&gt; vec2 = grpjs[<span class="string">&quot;users&quot;</span>];</span><br><span class="line">                <span class="keyword">for</span>(string &amp;str2:vec2)</span><br><span class="line">                &#123;</span><br><span class="line">                    json js = json::<span class="built_in">parse</span>(str2);</span><br><span class="line">                    GroupUser user;</span><br><span class="line">                    user.<span class="built_in">setId</span>(js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">                    user.<span class="built_in">setName</span>(js[<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">                    user.<span class="built_in">setState</span>(js[<span class="string">&quot;state&quot;</span>]);</span><br><span class="line">                    user.<span class="built_in">setRole</span>(js[<span class="string">&quot;role&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                    group.<span class="built_in">getUsers</span>().<span class="built_in">push_back</span>(user);</span><br><span class="line">                &#125;</span><br><span class="line">                g_currentGroupList.<span class="built_in">push_back</span>(group);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 显示登录用户的基本信息</span></span><br><span class="line">        <span class="built_in">showCurrentUserData</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(responsejs.<span class="built_in">contains</span>(<span class="string">&quot;offlinemsg&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            vector&lt;string&gt; vec = responsejs[<span class="string">&quot;offlinemsg&quot;</span>];</span><br><span class="line">            <span class="keyword">for</span>(string &amp;str: vec)</span><br><span class="line">            &#123;</span><br><span class="line">                json js = json::<span class="built_in">parse</span>(str);</span><br><span class="line">                <span class="keyword">if</span>(ONE_CHAT_MSG == js[<span class="string">&quot;msgid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">                    cout &lt;&lt; js[<span class="string">&quot;time&quot;</span>] &lt;&lt; <span class="string">&quot; [ &quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot; ] &quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] </span><br><span class="line">                    &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(GROUP_CHAT_MSG == js[<span class="string">&quot;msgid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">                    cout &lt;&lt; <span class="string">&quot;群消息[&quot;</span> &lt;&lt; js[<span class="string">&quot;groupid&quot;</span>] &lt;&lt; <span class="string">&quot;]:&quot;</span> &lt;&lt; js[<span class="string">&quot;time&quot;</span>] </span><br><span class="line">                    &lt;&lt; <span class="string">&quot; [ &quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot; ]&quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] </span><br><span class="line">                    &lt;&lt; endl;</span><br><span class="line">                    <span class="keyword">continue</span>;             </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;                            </span><br><span class="line">        &#125;</span><br><span class="line">        g_isLoginSuccess = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接受线程</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">readTaskHandler</span><span class="params">(<span class="type">int</span> clientfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">int</span> len = <span class="built_in">recv</span>(clientfd, buffer, <span class="number">1024</span> , <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == len || <span class="number">0</span> == len)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">close</span>(clientfd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接受ChatServer转发的数据，反序列化生产json数据对象</span></span><br><span class="line">        json js = json::<span class="built_in">parse</span>(buffer);</span><br><span class="line">        <span class="type">int</span> msgtype = js[<span class="string">&quot;msgid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">        <span class="keyword">if</span>(ONE_CHAT_MSG == msgtype)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">            cout &lt;&lt; js[<span class="string">&quot;time&quot;</span>] &lt;&lt; <span class="string">&quot; [ &quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot; ] &quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] </span><br><span class="line">            &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(GROUP_CHAT_MSG == msgtype)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// time + [id] + name + &quot; said: &quot; + xxx</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;群消息[&quot;</span> &lt;&lt; js[<span class="string">&quot;groupid&quot;</span>] &lt;&lt; <span class="string">&quot;]:&quot;</span> &lt;&lt; js[<span class="string">&quot;time&quot;</span>] </span><br><span class="line">            &lt;&lt; <span class="string">&quot; [&quot;</span> &lt;&lt; js[<span class="string">&quot;id&quot;</span>] &lt;&lt; <span class="string">&quot;]&quot;</span> &lt;&lt; js[<span class="string">&quot;name&quot;</span>] &lt;&lt; <span class="string">&quot; said: &quot;</span> &lt;&lt; js[<span class="string">&quot;msg&quot;</span>] </span><br><span class="line">            &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;             </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(LOGIN_MSG_ACK == msgtype)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">doLoginResponse</span>(js); <span class="comment">// 处理登录响应的业务逻辑</span></span><br><span class="line">            <span class="built_in">sem_post</span>(&amp;rwsem);   <span class="comment">// 通知主线程，登录结果处理完成</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(REG_MSG_ACK == msgtype)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">doRegResponse</span>(js);  <span class="comment">// 处理注册的响应逻辑</span></span><br><span class="line">            <span class="built_in">sem_post</span>(&amp;rwsem);   <span class="comment">// 通知主线程，登录结果处理完成</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;help&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">help</span><span class="params">(<span class="type">int</span> fd = <span class="number">0</span> , string str = <span class="string">&quot; &quot;</span>)</span></span>;</span><br><span class="line"><span class="comment">// &quot;chat&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">chat</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">// &quot;addfriend&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addfriend</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">// &quot;creategroup&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">creategroup</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">//&quot;addgroup&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addgroup</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">//&quot;groupchat&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">groupchat</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"><span class="comment">//&quot;groupchat&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loginout</span><span class="params">(<span class="type">int</span>, string)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统支持的客户端命令列表</span></span><br><span class="line">unordered_map&lt;string,string&gt; commandMap = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;help&quot;</span>,<span class="string">&quot;显示所有支持的命令,格式help&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,<span class="string">&quot;一对一聊天,格式chat:friendid:message&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addfriend&quot;</span>,<span class="string">&quot;添加好友,格式addfriend:friendid&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;creategroup&quot;</span>,<span class="string">&quot;创建群组,格式creategroup:groupname:groupdesc&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addgroup&quot;</span>,<span class="string">&quot;加入群组,格式addgroup:groupid&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;groupchat&quot;</span>, <span class="string">&quot;群聊,格式groupchat:groupid:message&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;loginout&quot;</span>, <span class="string">&quot;注销，格式loginout&quot;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册系统支持的客户端命令处理</span></span><br><span class="line">unordered_map&lt;string,function&lt;<span class="type">void</span>(<span class="type">int</span>,string)&gt;&gt; commandHandlerMap = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;help&quot;</span>,help&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;chat&quot;</span>,chat&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addfriend&quot;</span>,addfriend&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;creategroup&quot;</span>,creategroup&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;addgroup&quot;</span>,addgroup&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;groupchat&quot;</span>,groupchat&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;loginout&quot;</span>,loginout&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;help&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">help</span><span class="params">(<span class="type">int</span>, string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;show command list &gt;&gt;&gt;&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;it:commandMap)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; it.first &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; it.second &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//主聊天页面程序，先显示一下系统支持的命令 </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainMenu</span><span class="params">(<span class="type">int</span> clientfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">help</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(isMainMenuRunning)</span><br><span class="line">    &#123;</span><br><span class="line">        cin.<span class="built_in">getline</span>(buffer, <span class="number">1024</span>);</span><br><span class="line">        <span class="function">string <span class="title">commandbuf</span><span class="params">(buffer)</span></span>;</span><br><span class="line">        string command;</span><br><span class="line">        <span class="type">int</span> idx = commandbuf.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == idx)</span><br><span class="line">        &#123;</span><br><span class="line">            command = commandbuf;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            command = commandbuf.<span class="built_in">substr</span>(<span class="number">0</span>,idx);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> it = commandHandlerMap.<span class="built_in">find</span>(command);</span><br><span class="line">        <span class="keyword">if</span>(it == commandHandlerMap.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;invalid command&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用相应命令的事件处理回调,mainMenu对修改封闭,添加新功能</span></span><br><span class="line">        it-&gt;<span class="built_in">second</span>(clientfd,commandbuf.<span class="built_in">substr</span>(idx+<span class="number">1</span>,commandbuf.<span class="built_in">size</span>()-idx));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;chat&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">chat</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> idx = str.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == idx)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;chat command invalid!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> friendid = <span class="built_in">atoi</span>((str.<span class="built_in">substr</span>(<span class="number">0</span>,idx)).<span class="built_in">c_str</span>());</span><br><span class="line">    string message = str.<span class="built_in">substr</span>(idx+<span class="number">1</span>,str.<span class="built_in">size</span>()-idx);</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = ONE_CHAT_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;name&quot;</span>] = g_currentUser.<span class="built_in">getName</span>();</span><br><span class="line">    js[<span class="string">&quot;toid&quot;</span>] = friendid;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>] = message;</span><br><span class="line">    js[<span class="string">&quot;time&quot;</span>] = <span class="built_in">getCurrentTime</span>();</span><br><span class="line"></span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send chat msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;addfriend&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addfriend</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> friendid = <span class="built_in">atoi</span>(str.<span class="built_in">c_str</span>());</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = ADD_FRIEND_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;friendid&quot;</span>] = friendid;</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == len)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send addfriend msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;creategroup&quot; command handler  groupname:groupdesc</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">creategroup</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> idx = str.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == idx)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;creategroup command invalid!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;        </span><br><span class="line">    &#125;</span><br><span class="line">    string groupname = str.<span class="built_in">substr</span>(<span class="number">0</span>,idx);</span><br><span class="line">    string groupdesc = str.<span class="built_in">substr</span>(idx+<span class="number">1</span>,str.<span class="built_in">size</span>()-idx);</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = CREATE_GROUP_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;groupname&quot;</span>] = groupname;</span><br><span class="line">    js[<span class="string">&quot;groupdesc&quot;</span>] = groupdesc;</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send creategroup msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;addgroup&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addgroup</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> groupid = <span class="built_in">atoi</span>(str.<span class="built_in">c_str</span>());</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = ADD_GROUP_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;groupid&quot;</span>] = groupid;</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send addgroup msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;groupchat&quot; command handler   groupid:message</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">groupchat</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> idx = str.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == idx)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;groupchat command invalid!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> groupid = <span class="built_in">atoi</span>((str.<span class="built_in">substr</span>(<span class="number">0</span>,idx)).<span class="built_in">c_str</span>());</span><br><span class="line">    string message = str.<span class="built_in">substr</span>(idx+<span class="number">1</span>,str.<span class="built_in">size</span>()-idx);</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = GROUP_CHAT_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    js[<span class="string">&quot;name&quot;</span>] = g_currentUser.<span class="built_in">getName</span>();</span><br><span class="line">    js[<span class="string">&quot;groupid&quot;</span>] = groupid;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>] = message;</span><br><span class="line">    js[<span class="string">&quot;time&quot;</span>] = <span class="built_in">getCurrentTime</span>();</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send groupchat msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;loginout&quot; command handler</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loginout</span><span class="params">(<span class="type">int</span> clientfd,string str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msgid&quot;</span>] = LOGINOUT_MSG;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = g_currentUser.<span class="built_in">getId</span>();</span><br><span class="line">    string buffer = js.<span class="built_in">dump</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == <span class="built_in">send</span>(clientfd,buffer.<span class="built_in">c_str</span>(),<span class="built_in">strlen</span>(buffer.<span class="built_in">c_str</span>())+<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;send loginout msg error -&gt; &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        isMainMenuRunning = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取系统时间（聊天信息需要添加时间信息）</span></span><br><span class="line"><span class="function">string <span class="title">getCurrentTime</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> tt = std::chrono::system_clock::<span class="built_in">to_time_t</span>(std::chrono::system_clock::<span class="built_in">now</span>());</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> *ptm = <span class="built_in">localtime</span>(&amp;tt);</span><br><span class="line">    <span class="type">char</span> date[<span class="number">60</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(date, <span class="string">&quot;%d-%02d-%02d %02d:%02d:%02d&quot;</span>,</span><br><span class="line">            (<span class="type">int</span>)ptm-&gt;tm_year + <span class="number">1900</span>, (<span class="type">int</span>)ptm-&gt;tm_mon + <span class="number">1</span>, (<span class="type">int</span>)ptm-&gt;tm_mday,</span><br><span class="line">            (<span class="type">int</span>)ptm-&gt;tm_hour, (<span class="type">int</span>)ptm-&gt;tm_min, (<span class="type">int</span>)ptm-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">string</span>(date);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="30-3-编译"><a href="#30-3-编译" class="headerlink" title="30.3 编译"></a>30.3 编译</h3><p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/30-01(9).png" alt="本地png图片PictureTest.png"></p>
<h2 id="31-项目面试问题汇总"><a href="#31-项目面试问题汇总" class="headerlink" title="31 项目面试问题汇总"></a>31 项目面试问题汇总</h2><h3 id="31-1-两个关键问题"><a href="#31-1-两个关键问题" class="headerlink" title="31.1 两个关键问题"></a>31.1 两个关键问题</h3><p><strong>1 项目描述</strong></p>
<p>本项目分为四个模块来设计的，首先网络模块采用的是性能比较好的muduo网络库，解耦了网络模块和业务模块，让开发者专注于业务模块的开发。服务层运用了C++11的技术，map、绑定器、消息ID以及合格消息发生之后的回调操作绑定，回调机制让网络IO做一个消息请求的话，从消息解析出Jason得到消息ID，做相应的处理，数据存储层用的是MySQL，对于项目上的一些关键数据落地</p>
<p><strong>2 自我介绍</strong></p>
<h3 id="31-2-数据明文的传输问题"><a href="#31-2-数据明文的传输问题" class="headerlink" title="31.2 数据明文的传输问题"></a>31.2 数据明文的传输问题</h3><p><img src="/img/loading.gif" data-original="/img/%E5%9B%BE%E7%89%87/6-%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/31-01(1).png" alt="本地png图片PictureTest.png"></p>
<p>连接成功之后，通过RSA公钥将AES密钥Key加密成密文，服务器本身带有RSA私钥，用RSA私钥从密文中得到客户端先给我发的AES密钥Key，既可以验证又可以解密。解密成功后给客户端发个OK，如果没解密成功的话，说明是篡改的数据不能接受，接下来就可以加解密效率高的AES加解密算法通信。为什么要采用混合加密？因为采用对称加密的算法时，首先要将密钥发送到服务器，传送的过程中也会遭到截获，也会造成数据不安全，如果采用的非对称加密算法，数据量大的话，加密复杂、效率慢。</p>
<h3 id="31-3-历史消息存储问题"><a href="#31-3-历史消息存储问题" class="headerlink" title="31.3 历史消息存储问题"></a>31.3 历史消息存储问题</h3><p>以ID为名字新建文件夹保存消息</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">蔡伟</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/07/29/%E5%9F%BA%E4%BA%8Emuduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A1%B9%E7%9B%AE/">http://example.com/2022/07/29/基于muduo网络库的集群服务器项目/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">憨憨小胖</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C-%E9%A1%B9%E7%9B%AE/">C++项目</a></div><div class="post_share"><div class="social-share" data-image="/img/3.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-original="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/loading.gif" data-original="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/07/29/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/"><img class="prev-cover" src="/img/loading.gif" data-original="/img/4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">数据库连接池</div></div></a></div><div class="next-post pull-right"><a href="/2022/07/29/STL%E5%92%8C%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/"><img class="next-cover" src="/img/loading.gif" data-original="/img/2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">STL和泛型编程笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/07/31/C-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/" title="C++数据库连接池"><img class="cover" src="/img/loading.gif" data-original="/img/6.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-31</div><div class="title">C++数据库连接池</div></div></a></div><div><a href="/2022/07/29/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/" title="数据库连接池"><img class="cover" src="/img/loading.gif" data-original="/img/4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-29</div><div class="title">数据库连接池</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/loading.gif" data-original="/img/%E5%A4%B4%E5%83%8F.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">蔡伟</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AE%E8%BF%9C%E7%A8%8B%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">1 配置远程开发环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%AE%89%E8%A3%85Json%E5%BC%80%E5%8F%91%E5%BA%93"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 安装Json开发库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%AE%89%E8%A3%85boost-muduo%E7%BD%91%E7%BB%9C%E5%BA%93%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 安装boost + muduo网络库开发环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-%E9%94%99%E8%AF%AF"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.2.1 错误</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%AE%89%E8%A3%85nginx"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 安装nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-windows-vscode%E9%85%8D%E7%BD%AE%E8%BF%9C%E7%A8%8Blinux%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 windows+vscode配置远程linux开发环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Json"><span class="toc-number">2.</span> <span class="toc-text">2 Json</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Json%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 Json介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Json%E6%95%B0%E6%8D%AE%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 Json数据序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Json%E6%95%B0%E6%8D%AE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 Json数据反序列化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-muduo%E7%BD%91%E7%BB%9C%E5%BA%93%E7%BC%96%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">3 muduo网络库编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%9F%BA%E4%BA%8Emuduo%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 基于muduo的客户端服务器编程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-CMake"><span class="toc-number">4.</span> <span class="toc-text">4 CMake</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-CMake%E7%AE%80%E4%BB%8B"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 CMake简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-CMake%E5%AE%89%E8%A3%85"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 CMake安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-CMake%E5%9C%A8Ubuntu%E7%9A%84VScode%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 CMake在Ubuntu的VScode安装插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-CMake%E6%9E%84%E5%BB%BA%E9%9B%86%E6%88%90%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83-1"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 CMake构建集成编译环境(1)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-CMake%E6%9E%84%E5%BB%BA%E9%9B%86%E6%88%90%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83-2"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 CMake构建集成编译环境(2)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E9%A1%B9%E7%9B%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BB%A5%E5%8F%8A%E8%A1%A8%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.</span> <span class="toc-text">5 项目数据库以及表的设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-MySQL%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E8%AE%BE%E7%BD%AE"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 MySQL环境安装设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E7%A8%8B"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 MySQL数据库编程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 数据库设计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E9%9B%86%E7%BE%A4%E8%81%8A%E5%A4%A9%E9%A1%B9%E7%9B%AE%E5%B7%A5%E7%A8%8B%E7%9B%AE%E5%BD%95%E5%88%9B%E5%BB%BA"><span class="toc-number">6.</span> <span class="toc-text">6 集群聊天项目工程目录创建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81ChatServer"><span class="toc-number">7.</span> <span class="toc-text">7 网络模块代码ChatServer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81ChatService"><span class="toc-number">8.</span> <span class="toc-text">8 业务模块代码ChatService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9D%97%E5%92%8C%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9D%97%E8%80%A6%E5%90%88%E5%BA%A6%E9%99%8D%E7%BA%A7%E4%BB%A3%E7%A0%81%E5%A4%84%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text">9 网络模块和业务模块耦合度降级代码处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9D%97%E5%88%86%E5%8F%91%E4%B8%9A%E5%8A%A1%E4%BA%8B%E4%BB%B6%E5%9B%9E%E8%B0%83%E6%93%8D%E4%BD%9C%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">10.</span> <span class="toc-text">10 网络模块分发业务事件回调操作功能测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BB%A3%E7%A0%81%E5%B0%81%E8%A3%85"><span class="toc-number">11.</span> <span class="toc-text">11 MySQL数据库代码封装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-Model%E6%95%B0%E6%8D%AE%E5%B1%82%E4%BB%A3%E7%A0%81%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1"><span class="toc-number">12.</span> <span class="toc-text">12 Model数据层代码框架设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">13.</span> <span class="toc-text">13 用户注册业务代码编写和测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">14.</span> <span class="toc-text">14 用户登录业务代码编写和测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-%E8%AE%B0%E5%BD%95%E7%94%A8%E6%88%B7%E7%9A%84%E8%BF%9E%E6%8E%A5%E4%BF%A1%E6%81%AF%E4%BB%A5%E5%8F%8A%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="toc-number">15.</span> <span class="toc-text">15 记录用户的连接信息以及线程安全问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%82%E5%B8%B8%E9%80%80%E5%87%BA%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">16.</span> <span class="toc-text">16 客户端异常退出业务代码编写和测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17-%E7%82%B9%E5%AF%B9%E7%82%B9%E8%81%8A%E5%A4%A9%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">17.</span> <span class="toc-text">17 点对点聊天业务代码编写和测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-%E7%A6%BB%E7%BA%BF%E6%B6%88%E6%81%AF%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">18.</span> <span class="toc-text">18 离线消息业务代码编写和测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#19-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%82%E5%B8%B8%E9%80%80%E5%87%BA%E5%A4%84%E7%90%86%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">19.</span> <span class="toc-text">19 服务器异常退出处理代码编写和测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#20-%E6%B7%BB%E5%8A%A0%E5%A5%BD%E5%8F%8B%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">20.</span> <span class="toc-text">20 添加好友业务代码编写和测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#20-1-%E9%97%AE%E9%A2%98"><span class="toc-number">20.1.</span> <span class="toc-text">20.1 问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-%E7%BE%A4%E7%BB%84%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="toc-number">21.</span> <span class="toc-text">21 群组业务代码编写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91%E4%B8%80%E9%A6%96%E9%A1%B5%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91%E4%BB%A5%E5%8F%8A%E6%B5%8B%E8%AF%95"><span class="toc-number">22.</span> <span class="toc-text">22 客户端开发一首页功能开发以及测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#22-1-%E9%97%AE%E9%A2%98"><span class="toc-number">22.1.</span> <span class="toc-text">22.1 问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91%E4%BA%8C%E6%B7%BB%E5%8A%A0%E5%A5%BD%E5%8F%8B%E5%92%8C%E8%81%8A%E5%A4%A9%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="toc-number">23.</span> <span class="toc-text">23 客户端开发二添加好友和聊天功能开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#23-1-%E9%97%AE%E9%A2%98"><span class="toc-number">23.1.</span> <span class="toc-text">23.1 问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91%E4%B8%89%E7%BE%A4%E7%BB%84%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="toc-number">24.</span> <span class="toc-text">24 客户端开发三群组功能开发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#25-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91%E5%9B%9B%E7%94%A8%E6%88%B7%E6%B3%A8%E9%94%80%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91"><span class="toc-number">25.</span> <span class="toc-text">25 客户端开发四用户注销功能开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#25-1-%E9%97%AE%E9%A2%98"><span class="toc-number">25.1.</span> <span class="toc-text">25.1 问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#26-%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BC%95%E5%85%A5%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8"><span class="toc-number">26.</span> <span class="toc-text">26 集群服务器为什么要引入负载均衡器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#27-nginx%E7%9A%84tcp%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">27.</span> <span class="toc-text">27 nginx的tcp负载均衡配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#28-redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">28.</span> <span class="toc-text">28 redis发布订阅消息队列代码编写和测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#28-1-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85hiredis"><span class="toc-number">28.1.</span> <span class="toc-text">28.1 编译安装hiredis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#28-2-Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%9A%84%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">28.2.</span> <span class="toc-text">28.2 Redis发布订阅消息队列在项目上的代码实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#28-3-%E7%BC%96%E8%AF%91%E6%B5%8B%E8%AF%95"><span class="toc-number">28.3.</span> <span class="toc-text">28.3 编译测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#29-github%E7%AE%A1%E7%90%86%E9%A1%B9%E7%9B%AE"><span class="toc-number">29.</span> <span class="toc-text">29 github管理项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#30-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B3%A8%E9%94%80%E9%97%AE%E9%A2%98"><span class="toc-number">30.</span> <span class="toc-text">30 客户端注销问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#30-1-%E6%89%BE%E5%87%BA%E9%97%AE%E9%A2%98"><span class="toc-number">30.1.</span> <span class="toc-text">30.1 找出问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#30-2-%E6%94%B9%E8%BF%9B%E4%BB%A3%E7%A0%81"><span class="toc-number">30.2.</span> <span class="toc-text">30.2 改进代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#30-3-%E7%BC%96%E8%AF%91"><span class="toc-number">30.3.</span> <span class="toc-text">30.3 编译</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#31-%E9%A1%B9%E7%9B%AE%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB"><span class="toc-number">31.</span> <span class="toc-text">31 项目面试问题汇总</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-1-%E4%B8%A4%E4%B8%AA%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98"><span class="toc-number">31.1.</span> <span class="toc-text">31.1 两个关键问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#31-2-%E6%95%B0%E6%8D%AE%E6%98%8E%E6%96%87%E7%9A%84%E4%BC%A0%E8%BE%93%E9%97%AE%E9%A2%98"><span class="toc-number">31.2.</span> <span class="toc-text">31.2 数据明文的传输问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#31-3-%E5%8E%86%E5%8F%B2%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E9%97%AE%E9%A2%98"><span class="toc-number">31.3.</span> <span class="toc-text">31.3 历史消息存储问题</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/08/10/%E5%9B%BE%E8%A7%A3HTTP/" title="图解HTTP"><img src="/img/loading.gif" data-original="/img/5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="图解HTTP"/></a><div class="content"><a class="title" href="/2022/08/10/%E5%9B%BE%E8%A7%A3HTTP/" title="图解HTTP">图解HTTP</a><time datetime="2022-08-10T08:44:43.000Z" title="发表于 2022-08-10 16:44:43">2022-08-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/10/%E7%8E%B0%E9%98%B6%E6%AE%B5%E7%9B%AE%E6%A0%87/" title="现阶段目标"><img src="/img/loading.gif" data-original="/img/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="现阶段目标"/></a><div class="content"><a class="title" href="/2022/08/10/%E7%8E%B0%E9%98%B6%E6%AE%B5%E7%9B%AE%E6%A0%87/" title="现阶段目标">现阶段目标</a><time datetime="2022-08-10T02:24:34.000Z" title="发表于 2022-08-10 10:24:34">2022-08-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/09/MySQL%E7%AC%94%E8%AE%B0/" title="MySQL笔记"><img src="/img/loading.gif" data-original="/img/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL笔记"/></a><div class="content"><a class="title" href="/2022/08/09/MySQL%E7%AC%94%E8%AE%B0/" title="MySQL笔记">MySQL笔记</a><time datetime="2022-08-09T12:10:16.000Z" title="发表于 2022-08-09 20:10:16">2022-08-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" title="计算机网络"><img src="/img/loading.gif" data-original="/img/5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="计算机网络"/></a><div class="content"><a class="title" href="/2022/08/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" title="计算机网络">计算机网络</a><time datetime="2022-08-07T07:04:09.000Z" title="发表于 2022-08-07 15:04:09">2022-08-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/06/Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" title="Linux操作系统"><img src="/img/loading.gif" data-original="/img/4.img" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux操作系统"/></a><div class="content"><a class="title" href="/2022/08/06/Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" title="Linux操作系统">Linux操作系统</a><time datetime="2022-08-06T00:23:51.000Z" title="发表于 2022-08-06 08:23:51">2022-08-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 蔡伟</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script type="text/javascript" src="/js/fairyDustCursor.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>